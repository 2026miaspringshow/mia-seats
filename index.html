<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <meta property="og:title" content="2026 8th MIA SPRING SHOW">
    <meta property="og:description" content="MIA 春季展演 | 票務即時管理系統">
    <meta property="og:image" content="https://2026miaspringshow.github.io/mia-seats/logo.png">
    <meta property="og:type" content="website">
    <meta name="description" content="2026 MIA SPRING SHOW 即時座位票務系統">

    <title>2026 MIA SPRING SHOW | 票務管理系統</title>
    <style>
        :root { 
            --primary-blue: rgb(94, 121, 172); 
            --accent-blue: #2196f3; 
            --bg-gray: #f8f9fa; 
            --sold-pink: rgb(216, 83, 123); 
            --camera-light-gray: #E0E0E0; 
            --reserve-yellow: #FFF9C4; 
            --reserve-sold-dark: #FFD54F; 
            --reserve-border: #FBC02D;
            --reserve-selected-orange: #FF9800;
            --mia-gradient: linear-gradient(135deg, #e91e63 0%, #673ab7 100%);
            --confirm-dark: #0d1b2a;
            --confirm-hover: #1b2a3a;
        }
        body { font-family: "PingFang TC", "Microsoft JhengHei", sans-serif; background-color: var(--bg-gray); margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        .header { background: var(--mia-gradient); color: white; padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.2); z-index: 1000; }
        .header-title-wrapper { display: flex; align-items: center; gap: 12px; }
        .header-logo { height: 48px; width: auto; object-fit: contain; } 
        .header-title h1 { margin: 0; font-size: 18px; font-weight: 800; letter-spacing: 1.5px; line-height: 1.2; }
        .header-title span { font-size: 13px; font-weight: 400; opacity: 0.95; }
        .menu-btn { background: none; border: none; color: white; font-size: 26px; cursor: pointer; transition: 0.2s; }
        .menu-btn:hover { opacity: 0.7; transform: scale(1.1); }

        .main-content { flex: 1; overflow-y: auto; padding-bottom: 120px; display: flex; flex-direction: column; align-items: center; }
        .legend-area { display: flex; gap: 12px; margin: 15px 0; font-size: 11px; color: #666; justify-content: center; flex-wrap: wrap; }
        .legend-item { display: flex; align-items: center; gap: 4px; }
        .legend-box { width: 14px; height: 14px; border-radius: 3px; border: 1px solid #ddd; }
        .venue-wrapper { width: 100%; overflow-x: auto; padding: 10px 0; }
        .stage-area { width: fit-content; margin: 0 auto; display: flex; flex-direction: column; align-items: center; padding: 0 50px; }
        .screen { background: #121212; width: 400px; margin-bottom: 8px; padding: 10px; color: #fff; border-radius: 0 0 80px 80px; text-align: center; font-size: 13px; letter-spacing: 5px; }
        .view-notice { font-size: 10px; color: #999; margin-bottom: 30px; }
        .venue-container { display: grid; grid-template-columns: auto auto auto; gap: 50px; width: fit-content; }
        .block { display: flex; flex-direction: column; gap: 6px; }
        #LT, #LM, #LB { align-items: flex-end; }
        #RT, #RM, #RB { align-items: flex-start; }
        #MT, #MM, #MB { align-items: center; }
        .row { display: flex; gap: 4px; height: 32px; align-items: center; }
        
        /* 座位 Hover 效果 */
        .seat { width: 34px; height: 34px; font-size: 10px; border-radius: 5px; display: flex; align-items: center; justify-content: center; border: 1px solid #e0e0e0; background: white; cursor: pointer; transition: all 0.2s ease; color: #333; }
        .seat:hover:not(.camera-seat):not(.sold) { border-color: var(--accent-blue); transform: scale(1.12); z-index: 5; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }

        .sold { background-color: var(--sold-pink) !important; color: white !important; border: 1px solid transparent; }
        .selected { background-color: var(--primary-blue) !important; color: white !important; }
        .reserve-seat { background-color: var(--reserve-yellow) !important; border: 1px solid var(--reserve-border) !important; color: #333 !important; }
        .reserve-seat.selected { background-color: var(--reserve-selected-orange) !important; border-color: var(--reserve-selected-orange) !important; color: white !important; }
        .sold.reserve-seat { background-color: var(--reserve-sold-dark) !important; border: 1px solid var(--reserve-sold-dark) !important; color: #5d4037 !important; }
        .camera-seat { background: var(--camera-light-gray) !important; color: #888; cursor: default; }
        
        .bottom-bar { position: fixed; bottom: 0; left: 0; right: 0; height: 110px; background: white; display: none; align-items: center; justify-content: space-between; padding: 0 50px; box-shadow: 0 -5px 20px rgba(0,0,0,0.1); z-index: 500; border-top: 1px solid #eee; }
        .logged-in .bottom-bar { display: flex; }
        .price-info { text-align: left; }
        .price-row-top { font-size: 12px; color: #999; }
        .price-row-middle { font-size: 26px; font-weight: 800; color: var(--accent-blue); }
        .price-row-bottom { font-size: 12px; color: #aaa; }
        
        /* 確認購票按鈕（底部橫排與彈窗一致） */
        .btn-confirm-main { background: var(--confirm-dark); color: white; padding: 16px 45px; border-radius: 12px; border: none; font-size: 16px; font-weight: bold; cursor: pointer; transition: all 0.2s; }
        .btn-confirm-main:hover:not(:disabled) { background: var(--confirm-hover); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        .btn-confirm-main:disabled { opacity: 0.5; cursor: not-allowed; }

        .modal-overlay { position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 3000; padding: 20px; }
        .modal { background: white; width: 100%; max-width: 420px; max-height: 85vh; border-radius: 20px; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 25px 60px rgba(0,0,0,0.4); }
        .modal-header { background: var(--mia-gradient); color: white; padding: 18px; text-align: center; font-size: 18px; font-weight: bold; position: relative; flex-shrink: 0; }
        .close-x { position: absolute; right: 20px; top: 50%; transform: translateY(-50%); cursor: pointer; font-size: 24px; z-index: 10; transition: 0.2s; }
        .close-x:hover { color: #ffeb3b; transform: translateY(-50%) rotate(90deg); }
        
        .modal-body { padding: 25px; overflow-y: auto; flex: 1; }
        .form-group { margin-bottom: 12px; }
        .form-group label { display: block; font-size: 12px; font-weight: bold; margin-bottom: 4px; color: #666; }
        .form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        
        /* 詳細資訊格式保留 */
        .detail-row { margin-bottom: 12px; border-bottom: 1px solid #f0f0f0; padding-bottom: 8px; }
        .detail-label { font-size: 11px; color: #999; font-weight: bold; }
        .detail-value { font-size: 15px; color: #333; margin-top: 3px; }
        
        .btn-confirm-final { background: var(--confirm-dark); color: white; width: 100%; padding: 16px; border-radius: 12px; border: none; font-size: 16px; font-weight: bold; cursor: pointer; transition: all 0.2s; }
        .btn-confirm-final:hover { background: var(--confirm-hover); }

        .side-menu { position: fixed; top: 0; right: -250px; width: 250px; height: 100%; background: white; box-shadow: -5px 0 15px rgba(0,0,0,0.1); transition: 0.3s; z-index: 2000; padding-top: 60px; }
        .side-menu.active { right: 0; }
        .menu-item { padding: 15px 25px; border-bottom: 1px solid #eee; color: #333; cursor: pointer; font-weight: bold; }
        .menu-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; z-index: 1500; }
        
        /* 購票須知內容樣式 */
        .notice-text { line-height: 1.8; color: #444; }
        .notice-important-line { font-size: 18px; font-weight: bold; color: #e91e63; display: block; margin-bottom: 15px; }
        .notice-title { font-size: 17px; font-weight: bold; color: #000; display: block; margin-top: 12px; margin-bottom: 4px; }
        .notice-footer { font-size: 12.5px; color: #777; border-top: 1px solid #eee; margin-top: 20px; padding-top: 10px; white-space: nowrap; }

        /* --- 專屬手機版 RWD 優化 --- */
        @media screen and (max-width: 480px) {
            .modal { max-width: 92%; }
            .modal-body.notice-text { padding: 18px; }
            .notice-important-line { font-size: 15.5px; margin-bottom: 10px; }
            .notice-title { font-size: 15px; margin-top: 10px; }
            .notice-text { font-size: 13px; line-height: 1.5; }
            .notice-footer { 
                font-size: 11px; 
                white-space: normal; /* 解決手機版左右滑動的關鍵：允許換行 */
                line-height: 1.4;
            }
            .btn-confirm-final { padding: 12px; font-size: 15px; }
            .bottom-bar { padding: 0 20px; } /* 手機版底部縮減內距 */
        }
    </style>
</head>
<body id="main-body">

    <div class="modal-overlay" id="modal-notice" style="display: flex;">
        <div class="modal">
            <div class="modal-header">2026 8th MIA SPRING SHOW 購票須知</div>
            <div class="modal-body notice-text">
                <span class="notice-important-line">3/1 (日) 18:00 開放MIA光復館排隊購票</span>
                <span class="notice-title">【售票資訊】</span>
                早鳥優惠：NT$ 600（3/1 - 3/8 限時販售）<br>
                一般原價：NT$ 800
                <span class="notice-title">【劃位資訊】</span>
                1. 3/1 ~ 3/8：僅限MIA光復館櫃檯現場劃位購票。<br>
                2. 3/9 起：開放櫃檯現場及官方LINE同步劃位購票。
                <div class="notice-footer">
                    ※本系統座位圖僅供即時查閱參考，如需購買請向MIA櫃檯人員諮詢。
                </div>
                <button class="btn-confirm-final" style="margin-top:20px;" onclick="closeModal('modal-notice')">我已了解</button>
            </div>
        </div>
    </div>

    <div class="header">
        <div class="header-title-wrapper">
            <img src="logo.png" class="header-logo" alt="MIA LOGO" onerror="this.style.display='none'">
            <div class="header-title">
                <h1>2026 8th MIA SPRING SHOW</h1>
                <span>即時座位票務系統</span>
            </div>
        </div>
        <button class="menu-btn" onclick="toggleMenu()">☰</button>
    </div>

    <div class="menu-overlay" id="menu-overlay" onclick="toggleMenu()"></div>
    <div class="side-menu" id="side-menu">
        <div class="menu-item" id="menu-login" onclick="handleLogin()">管理員登入</div>
        <div class="menu-item" id="menu-logout" onclick="handleLogout()" style="display:none;">管理員登出</div>
        <div class="menu-item" onclick="exportData('seats')">匯出購票名冊</div>
        <div class="menu-item" onclick="exportData('refunds')">匯出退票名冊</div>
    </div>

    <div class="main-content">
        <div class="legend-area">
            <div class="legend-item"><div class="legend-box" style="background:white;"></div> 可選位</div>
            <div class="legend-item"><div class="legend-box" style="background:var(--primary-blue);"></div> 已選擇</div>
            <div class="legend-item"><div class="legend-box" style="background:var(--sold-pink);"></div> 已售出</div>
            <div class="legend-item"><div class="legend-box" style="background:var(--camera-light-gray);"></div> 攝影席</div>
            <div class="legend-item"><div class="legend-box" style="background:var(--reserve-yellow); border:1px solid var(--reserve-border);"></div> 保留席</div>
        </div>
        <div class="venue-wrapper">
            <div class="stage-area">
                <div class="screen">STAGE 舞 台</div>
                <div class="view-notice">座位圖示僅供參考，實際視野可能因場地佈置略有差異。</div>
                <div class="venue-container" id="grid">
                    <div id="LT" class="block"></div><div id="MT" class="block"></div><div id="RT" class="block"></div>
                    <div id="LM" class="block"></div><div id="MM" class="block"></div><div id="RM" class="block"></div>
                    <div id="LB" class="block"></div><div id="MB" class="block"></div><div id="RB" class="block"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="bottom-bar">
        <div class="price-info">
            <div class="price-row-top">總計金額</div>
            <div id="display-total" class="price-row-middle">NT$ 0</div>
            <div id="display-sub-info" class="price-row-bottom">已選 0 張</div>
        </div>
        <button class="btn-confirm-main" id="btn-open-modal" disabled>確認購票</button>
    </div>

    <div class="modal-overlay" id="modal-purchase">
        <div class="modal">
            <div class="modal-header">管理員劃位購票<span class="close-x" onclick="closeModal('modal-purchase')">×</span></div>
            <div class="modal-body">
                <div class="form-group"><label>劃位座位</label><input type="text" id="buy-seat-list" readonly style="background:#f9f9f9; color:var(--primary-blue); font-weight:bold; border:none;"></div>
                <div class="form-group"><label>票價類型</label>
                    <select id="p-type" onchange="calculateFinalTotal()">
                        <option value="600">早鳥票價 NT$ 600 / 張</option>
                        <option value="800">原價票價 NT$ 800 / 張</option>
                        <option value="0">公關票價 NT$ 0 / 張</option>
                    </select>
                </div>
                <div class="form-group"><label>購票人姓名</label><input type="text" id="p-name"></div>
                <div class="form-group"><label>購票人電話</label><input type="tel" id="p-phone"></div>
                <div class="form-group"><label>付款日期</label><input type="date" id="p-date"></div>
                <div class="form-group"><label>售票人員</label>
                    <select id="p-staff">
                        <option value="">請選擇</option><option value="芷瑜">芷瑜</option><option value="Daifi">Daifi</option><option value="Ruby">Ruby</option><option value="孟萱">孟萱</option>
                    </select>
                </div>
                <div class="form-group"><label>備註</label><input type="text" id="p-note"></div>
                <div class="total-row" style="display:flex; justify-content:space-between; align-items:center; margin-top:15px; border-top:1px dashed #ddd; padding:20px 0 25px 0;">
                    <div style="font-weight:bold; color:#666;">總計金額</div>
                    <div id="buy-final-total" style="font-size:28px; font-weight:bold; color:var(--accent-blue);">NT$ 0</div>
                </div>
                <button class="btn-confirm-final" id="btn-confirm-final">確認劃位售出</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modal-detail">
        <div class="modal">
            <div class="modal-header">票務詳細資訊<span class="close-x" onclick="closeModal('modal-detail')">×</span></div>
            <div class="modal-body">
                <div id="detail-info-area">
                    <div class="detail-row"><div class="detail-label">座位</div><div class="detail-value" id="det-seat-id" style="font-size:18px; color:var(--primary-blue); font-weight:bold;"></div></div>
                    <div class="detail-row"><div class="detail-label">購票人姓名</div><div class="detail-value" id="det-name"></div></div>
                    <div class="detail-row"><div class="detail-label">購票人電話</div><div class="detail-value" id="det-phone"></div></div>
                    <div class="detail-row"><div class="detail-label">票價類型</div><div class="detail-value" id="det-type"></div></div>
                    <div class="detail-row"><div class="detail-label">付款日期</div><div class="detail-value" id="det-date"></div></div>
                    <div class="detail-row"><div class="detail-label">售票人員</div><div class="detail-value" id="det-staff"></div></div>
                    <div class="detail-row"><div class="detail-label">備註</div><div class="detail-value" id="det-note"></div></div>
                    <div style="margin-top:20px;"><button class="btn-confirm-final" onclick="showRefundSection()">取消售出</button></div>
                </div>
                <div id="refund-section" style="display:none; border-top:2px solid #eee; padding-top:15px; margin-top:15px;">
                    <div class="form-group"><label>請選擇取消原因</label>
                        <select id="refund-reason">
                            <option value="取消退費">取消退費</option><option value="更換位置">更換位置</option><option value="其他原因">其他原因</option>
                        </select>
                    </div>
                    <div style="display:flex; gap:10px;">
                        <button class="btn-confirm-final" style="background:#666;" onclick="hideRefundSection()">返回</button>
                        <button class="btn-confirm-final" style="background:var(--sold-pink);" id="btn-do-refund">確認取消並紀錄</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js";
        import { getDatabase, ref, onValue, update, push, set } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBpxxZ0DJvGJdu8anqJWmGeGHf_wUufv28",
            authDomain: "miaspringshow.firebaseapp.com",
            databaseURL: "https://miaspringshow-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "miaspringshow",
            storageBucket: "miaspringshow.firebasestorage.app",
            messagingSenderId: "756405426670",
            appId: "1:756405426670:web:cc234426bb8c3ac2ce96ff"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        let isAdmin = false, seatsData = {}, selectedIds = [], activeSeatForRefund = null;
        
        const cameraSeats = ["F15", "F16", "F17", "G15", "G16", "G17"];
        const reserveSeats = [];
        for(let i=1; i<=27; i++) reserveSeats.push("A"+i);
        for(let i=1; i<=29; i++) reserveSeats.push("B"+i);

        onValue(ref(db, 'seats'), (snapshot) => { seatsData = snapshot.val() || {}; render(); });

        window.toggleMenu = () => {
            const menu = document.getElementById('side-menu');
            const overlay = document.getElementById('menu-overlay');
            menu.classList.toggle('active');
            overlay.style.display = menu.classList.contains('active') ? 'block' : 'none';
        };

        window.handleLogin = () => {
            const pw = prompt("管理員密碼：");
            if(pw === "mia2026") {
                isAdmin = true;
                document.getElementById('main-body').classList.add('logged-in');
                document.getElementById('menu-login').style.display = 'none';
                document.getElementById('menu-logout').style.display = 'block';
                render(); toggleMenu();
            }
        };

        window.handleLogout = () => { 
            isAdmin = false; selectedIds = []; 
            document.getElementById('main-body').classList.remove('logged-in'); 
            document.getElementById('menu-login').style.display = 'block'; 
            document.getElementById('menu-logout').style.display = 'none'; 
            render(); toggleMenu(); 
        };

        const layout = [
            { id: 'T', rows: 5, L: [7,8,9,10,11], M: 13, R: [7,8,9,10,11], start: 'A' },
            { id: 'M', rows: 10, L: 9, M: 13, R: 9, start: 'F' },
            { id: 'B', rows: 10, L: 6, M: 13, R: 6, start: 'P' }
        ];

        function render() {
            layout.forEach(sec => {
                for(let r=0; r<sec.rows; r++){
                    const rowName = String.fromCharCode(sec.start.charCodeAt(0)+r);
                    const cL = Array.isArray(sec.L)?sec.L[r]:sec.L;
                    updateBlock(`L${sec.id}`, rowName, 1, cL);
                    updateBlock(`M${sec.id}`, rowName, cL+1, cL+13);
                    updateBlock(`R${sec.id}`, rowName, cL+13+1, cL+13+(Array.isArray(sec.R)?sec.R[r]:sec.R));
                }
            });
            updateBottomBar();
        }

        function updateBlock(bid, rowName, start, end) {
            const block = document.getElementById(bid);
            if(rowName==='A' || rowName==='F' || rowName==='P') block.innerHTML = '';
            const rowDiv = document.createElement('div');
            rowDiv.className = 'row';
            for(let s=start; s<=end; s++){
                const id = rowName + s;
                const div = document.createElement('div');
                div.innerText = id;
                if (cameraSeats.includes(id)) {
                    div.className = "seat camera-seat";
                } else {
                    const status = (seatsData[id] && seatsData[id].status) ? seatsData[id].status : 'available';
                    const isReserve = reserveSeats.includes(id);
                    div.className = `seat ${status} ${isReserve ? 'reserve-seat' : ''}`;
                    if(selectedIds.includes(id)) div.classList.add('selected');
                    div.onclick = () => handleSeatClick(id);
                }
                rowDiv.appendChild(div);
            }
            block.appendChild(rowDiv);
        }

        function handleSeatClick(id) {
            if(!isAdmin) return;
            const current = seatsData[id] || { status: 'available' };
            if(current.status === 'sold') {
                activeSeatForRefund = id;
                hideRefundSection();
                document.getElementById('det-seat-id').innerText = id;
                document.getElementById('det-name').innerText = current.name || '';
                document.getElementById('det-phone').innerText = current.phone || '';
                document.getElementById('det-type').innerText = current.ticketType || '';
                document.getElementById('det-staff').innerText = current.staff || '';
                document.getElementById('det-date').innerText = current.date || '';
                document.getElementById('det-note').innerText = current.note || '';
                document.getElementById('modal-detail').style.display = 'flex';
                return;
            }
            if (selectedIds.includes(id)) {
                selectedIds = selectedIds.filter(i => i !== id);
            } else { 
                if(selectedIds.length >= 5) { alert("單次購票上限 5 張。"); return; }
                selectedIds.push(id); 
            }
            render();
        }

        window.showRefundSection = () => { document.getElementById('refund-section').style.display = 'block'; };
        window.hideRefundSection = () => { document.getElementById('refund-section').style.display = 'none'; };

        document.getElementById('btn-do-refund').onclick = () => {
            const reason = document.getElementById('refund-reason').value;
            const originalData = seatsData[activeSeatForRefund];
            if(confirm(`確定要取消 ${activeSeatForRefund} 嗎？`)) {
                const refundRef = push(ref(db, 'refunds'));
                set(refundRef, { ...originalData, seatId: activeSeatForRefund, refundReason: reason, refundTime: new Date().toLocaleString() });
                update(ref(db, `seats/${activeSeatForRefund}`), { status: 'available', name: null, staff: null, date: null, note: null, phone: null, ticketType: null });
                closeModal('modal-detail');
            }
        };

        function updateBottomBar() {
            const count = selectedIds.length;
            const price = parseInt(document.getElementById('p-type').value);
            const total = count * price;
            document.getElementById('display-total').innerText = `NT$ ${total.toLocaleString()}`;
            document.getElementById('display-sub-info').innerText = `已選 ${count} 張`;
            document.getElementById('btn-open-modal').disabled = count === 0;
        }

        window.calculateFinalTotal = () => { 
            updateBottomBar(); 
            const finalTotal = selectedIds.length * parseInt(document.getElementById('p-type').value);
            document.getElementById('buy-final-total').innerText = `NT$ ${finalTotal.toLocaleString()}`; 
        };

        window.closeModal = (mid) => { document.getElementById(mid).style.display = 'none'; };

        document.getElementById('btn-open-modal').onclick = () => {
            document.getElementById('p-name').value = ""; document.getElementById('p-phone').value = "";
            document.getElementById('p-staff').value = ""; document.getElementById('p-note').value = "";
            document.getElementById('modal-purchase').style.display = 'flex';
            document.getElementById('buy-seat-list').value = selectedIds.join(', ');
            const now = new Date();
            const offset = now.getTimezoneOffset() * 60000;
            const localISOTime = (new Date(now - offset)).toISOString().split('T')[0];
            document.getElementById('p-date').value = localISOTime;
            calculateFinalTotal();
        };

        document.getElementById('btn-confirm-final').onclick = () => {
            const name = document.getElementById('p-name').value;
            const staff = document.getElementById('p-staff').value;
            const typeText = document.getElementById('p-type').options[document.getElementById('p-type').selectedIndex].text;
            if(!name || !staff) return alert("請填寫姓名與售票人員");
            const updates = {};
            selectedIds.forEach(id => {
                updates[`seats/${id}`] = { 
                    status: 'sold', name, staff, ticketType: typeText, 
                    phone: document.getElementById('p-phone').value, 
                    date: document.getElementById('p-date').value, 
                    note: document.getElementById('p-note').value 
                };
            });
            update(ref(db), updates).then(() => { selectedIds = []; closeModal('modal-purchase'); render(); });
        };

        window.exportData = (type) => {
            const pw = prompt("管理員密碼：");
            if(pw !== "mia2026") return;
            onValue(ref(db, type), (snapshot) => {
                const data = snapshot.val() || {};
                let csv = "";
                if(type === 'seats') {
                    csv = "座位,購票人,電話,票價類型,付款日期,售票員,備註\n";
                    Object.keys(data).forEach(id => {
                        const s = data[id];
                        if(s.status === 'sold') csv += `${id},${s.name},${s.phone},${s.ticketType},${s.date},${s.staff},${s.note}\n`;
                    });
                } else {
                    csv = "退票座位,原購票人,票價類型,售票員,取消原因,退票紀錄時間\n";
                    Object.keys(data).forEach(key => {
                        const r = data[key];
                        csv += `${r.seatId},${r.name},${r.ticketType},${r.staff},${r.refundReason},${r.refundTime}\n`;
                    });
                }
                const blob = new Blob(["\ufeff" + csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = `MIA_${type === 'seats' ? 'Purchase' : 'Refund'}_${new Date().toLocaleDateString()}.csv`;
                link.click();
            }, { onlyOnce: true });
            toggleMenu();
        };
    </script>
</body>
</html>
