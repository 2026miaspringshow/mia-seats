<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <meta property="og:title" content="2026 8th MIA SPRING SHOW">
    <meta property="og:description" content="MIA 春季展演 | 票務即時管理系統">
    <meta property="og:image" content="https://2026miaspringshow.github.io/mia-seats/logo.png">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:type" content="website">
    <meta name="description" content="2026 MIA SPRING SHOW 即時座位票務系統">

    <title>2026 MIA SPRING SHOW | 票務管理系統</title>
    <!-- 引入 ExcelJS 引擎，產生真正的 xlsx 檔案 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <style>
        :root { 
            --primary-blue: #6366f1; 
            --accent-blue: #6366f1; 
            --bg-gray: #f8f9fa; 
            --mia-gradient: linear-gradient(135deg, #1e3a8a 0%, #172554 100%);
            --success-gradient: linear-gradient(135deg, #10b981 0%, #059669 100%);
            --confirm-dark: #0d1b2a;
            --confirm-hover: #1b2a3a;

            --seat-bg-avail: #ffffff;
            --seat-text-avail: #64748b;
            --seat-border-avail: #f1f5f9;
            --seat-shadow-avail: #cbd5e1;
            
            --seat-bg-selected: #6366f1;
            --seat-text-selected: #ffffff;
            --seat-shadow-selected: #3730a3;
            
            --seat-bg-sold: #fee2e2;
            --seat-text-sold: #b91c1c;
            --seat-shadow-sold: #fca5a5;
            
            --seat-bg-reserve: #fef3c7;
            --seat-text-reserve: #f59e0b;
            --seat-shadow-reserve: #fcd34d;
            
            --seat-bg-camera: #1e3a8a;
            --seat-text-camera: #ffffff;
            --seat-shadow-camera: #1e40af;

            --seat-bg-blocked: #e2e8f0;
            --seat-text-blocked: #94a3b8;
            --seat-shadow-blocked: #cbd5e1;
        }
        body { font-family: "PingFang TC", "Microsoft JhengHei", sans-serif; background-color: var(--bg-gray); margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        .header { background: var(--mia-gradient); color: white; padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.2); z-index: 1000; }
        .header-title-wrapper { display: flex; align-items: center; gap: 12px; }
        .header-logo { height: 48px; width: auto; object-fit: contain; } 
        .header-title h1 { margin: 0; font-size: 18px; font-weight: 800; letter-spacing: 1.5px; line-height: 1.2; }
        .header-title span { font-size: 13px; font-weight: 400; opacity: 0.95; }
        
        .header-actions { display: flex; align-items: center; gap: 12px; }
        .menu-btn { background: none; border: none; color: white; cursor: pointer; transition: 0.2s; padding: 0 5px; display: flex; align-items: center; justify-content: center; }
        .menu-btn:hover { opacity: 0.7; transform: scale(1.1); }
        .menu-btn svg { width: 24px; height: 24px; }

        .main-content { flex: 1; overflow-y: auto; padding-bottom: 10px; display: flex; flex-direction: column; align-items: center; width: 100%; }
        
        .legend-area { display: flex; gap: 15px; margin: 15px 0; font-size: 14px; color: #666; justify-content: center; flex-wrap: wrap; align-items: center; }
        .legend-item { display: flex; align-items: center; gap: 6px; }
        .legend-box { width: 16px; height: 16px; border-radius: 4px 4px 2px 2px; }
        
        .venue-wrapper { width: 100%; overflow-x: auto; padding: 10px 0; }
        .stage-area { width: fit-content; margin: 0 auto; display: flex; flex-direction: column; align-items: center; padding: 0 50px; }
        
        .screen { background: #0f172a; width: 888px; margin-bottom: 8px; padding: 12px 20px; color: #fff; border-radius: 0 0 80px 80px; text-align: center; font-size: 20px; font-weight: 900; letter-spacing: 15px; box-shadow: 0 10px 20px rgba(0,0,0,0.15); }
        
        .view-notice { font-size: 14px; color: #999; margin-bottom: 30px; font-weight: normal; }
        
        .venue-container { 
            display: grid; 
            grid-template-columns: auto auto auto; 
            column-gap: 60px; 
            row-gap: 25px; 
            width: fit-content; 
        }
        .block { display: flex; flex-direction: column; gap: 6px; }
        #LT, #LM, #LB { align-items: flex-end; }
        #RT, #RM, #RB { align-items: flex-start; }
        #MT, #MM, #MB { align-items: center; }
        
        .row { display: flex; gap: 4px; height: 38px; align-items: center; }
        
        .seat { 
            width: 28px !important; 
            height: 28px !important; 
            box-sizing: border-box !important;
            flex-shrink: 0; 
            font-size: 9px; 
            font-weight: bold;
            border-radius: 12px 12px 6px 6px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            transition: all 0.15s ease; 
            user-select: none;
            background-color: var(--seat-bg-avail); 
            color: var(--seat-text-avail);
            border: 1px solid var(--seat-border-avail); 
            box-shadow: 0 3px 0 0 var(--seat-shadow-avail);
            cursor: pointer;
        }
        
        .seat:hover:not(.camera-seat):not(.sold):not(.blocked-seat) { transform: translateY(-2px); box-shadow: 0 5px 0 0 var(--seat-shadow-avail); z-index: 5; }
        .seat:active:not(.camera-seat):not(.sold):not(.blocked-seat) { transform: translateY(2px); box-shadow: 0 1px 0 0 var(--seat-shadow-avail); }

        .sold { background-color: var(--seat-bg-sold) !important; color: var(--seat-text-sold) !important; box-shadow: 0 3px 0 0 var(--seat-shadow-sold) !important; border: none !important; cursor: not-allowed; transform: none !important; }
        .selected { background-color: var(--seat-bg-selected) !important; color: var(--seat-text-selected) !important; box-shadow: 0 3px 0 0 var(--seat-shadow-selected) !important; border: none !important; transform: translateY(1px) !important; }
        .reserve-seat { background-color: var(--seat-bg-reserve) !important; color: var(--seat-text-reserve) !important; box-shadow: 0 3px 0 0 var(--seat-shadow-reserve) !important; border: none !important; }
        .reserve-seat.selected { background-color: var(--seat-bg-selected) !important; color: var(--seat-text-selected) !important; box-shadow: 0 3px 0 0 var(--seat-shadow-selected) !important; border: none !important; transform: translateY(1px) !important; }
        .sold.reserve-seat { background-color: #f59e0b !important; color: #fffbeb !important; box-shadow: 0 3px 0 0 #d97706 !important; border: none !important; }
        .camera-seat { background-color: var(--seat-bg-camera) !important; color: var(--seat-text-camera) !important; box-shadow: 0 3px 0 0 var(--seat-shadow-camera) !important; border: none !important; cursor: default; }
        
        .blocked-seat { 
            background-color: var(--seat-bg-blocked) !important; 
            color: var(--seat-text-blocked) !important; 
            box-shadow: 0 3px 0 0 var(--seat-shadow-blocked) !important; 
            border: 1px solid #cbd5e1 !important; 
            cursor: default !important; 
            pointer-events: none; 
        }

        .floating-bar {
            position: fixed; bottom: -120px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 450px;
            background: #0f172a; border-radius: 20px; padding: 12px 16px; display: flex; align-items: center;
            justify-content: space-between; box-shadow: 0 10px 30px rgba(0,0,0,0.4); z-index: 500;
            transition: bottom 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.15);
        }
        .floating-bar.show { bottom: 30px; }
        .floating-bar-left { display: flex; align-items: center; gap: 15px; }
        .floating-cart-icon { width: 46px; height: 46px; background: var(--primary-blue); border-radius: 14px; display: flex; align-items: center; justify-content: center; color: white; }
        .floating-info { display: flex; flex-direction: column; justify-content: center; }
        .floating-info-top { font-size: 16px; font-weight: bold; color: white; }
        .btn-floating-confirm { background: white; color: #0f172a; padding: 14px 24px; border-radius: 14px; border: none; font-size: 15px; font-weight: bold; cursor: pointer; transition: all 0.2s; }
        .btn-floating-confirm:hover { background: #f1f5f9; transform: scale(1.03); }
        .btn-floating-confirm:active { transform: scale(0.97); }

        .custom-toast {
            position: fixed; top: -100px; left: 50%; transform: translateX(-50%); background-color: #ef4444; color: white;
            padding: 12px 28px; border-radius: 9999px; display: flex; align-items: center; gap: 10px; font-size: 16px;
            font-weight: bold; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2); z-index: 5000;
            transition: top 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.2), opacity 0.3s; opacity: 0; pointer-events: none;
        }
        .custom-toast.show { top: 40px; opacity: 1; pointer-events: auto; }
        .custom-toast.success { background-color: #10b981; }
        .custom-toast svg { width: 22px; height: 22px; }

        /* 在這裡加上 backdrop-filter 產生背景模糊效果 */
        .modal-overlay { position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.6); backdrop-filter: blur(6px); -webkit-backdrop-filter: blur(6px); display: none; justify-content: center; align-items: center; z-index: 3000; padding: 20px; }
        .modal { background: white; width: 100%; max-width: 480px; max-height: 95vh; border-radius: 20px; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 25px 60px rgba(0,0,0,0.4); }
        
        .modal-header { 
            background-color: #1e3a8a; 
            background-image: 
                url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 24 24' fill='none' stroke='rgba(255,255,255,0.1)' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M2 9a3 3 0 0 1 0 6v2a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-2a3 3 0 0 1 0-6V7a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2Z'/%3E%3Cpath d='M13 5v2'/%3E%3Cpath d='M13 17v2'/%3E%3Cpath d='M13 11v2'/%3E%3C/svg%3E"),
                var(--mia-gradient); 
            background-repeat: no-repeat;
            background-position: right -15px center, center;
            background-size: 110px, cover; 
            color: white; 
            padding: 32px 20px; 
            text-align: center; 
            font-size: 20px; 
            font-weight: bold; 
            position: relative; 
            flex-shrink: 0; 
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-header.login-header { 
            background-image: 
                url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 24 24' fill='none' stroke='rgba(255,255,255,0.1)' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Crect x='3' y='11' width='18' height='11' rx='2' ry='2'/%3E%3Cpath d='M7 11V7a5 5 0 0 1 10 0v4'/%3E%3C/svg%3E"),
                var(--mia-gradient); 
            background-position: right -15px center, center;
            background-size: 110px, cover;
        }

        .modal-header.success-header { 
            background-image: 
                url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 24 24' fill='none' stroke='rgba(255,255,255,0.1)' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M2 9a3 3 0 0 1 0 6v2a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-2a3 3 0 0 1 0-6V7a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2Z'/%3E%3Cpath d='M13 5v2'/%3E%3Cpath d='M13 17v2'/%3E%3Cpath d='M13 11v2'/%3E%3C/svg%3E"),
                var(--success-gradient); 
            background-size: 110px, cover;
        }

        .modal-header.danger-header { 
            background-image: 
                url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 24 24' fill='none' stroke='rgba(255,255,255,0.1)' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='12' cy='12' r='10'/%3E%3Cline x1='12' y1='8' x2='12' y2='12'/%3E%3Cline x1='12' y1='16' x2='12.01' y2='16'/%3E%3C/svg%3E"),
                linear-gradient(135deg, #ef4444 0%, #b91c1c 100%); 
            background-size: 110px, cover;
            background-position: right -15px center, center;
        }

        .modal-header.delete-header { 
            background-image: 
                url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 24 24' fill='none' stroke='rgba(255,255,255,0.1)' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='3 6 5 6 21 6'/%3E%3Cpath d='M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2'/%3E%3Cline x1='10' y1='11' x2='10' y2='17'/%3E%3Cline x1='14' y1='11' x2='14' y2='17'/%3E%3C/svg%3E"),
                linear-gradient(135deg, #ef4444 0%, #b91c1c 100%); 
            background-size: 110px, cover;
            background-position: right -15px center, center;
        }

        .modal-header.verify-header { 
            background-image: 
                url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 24 24' fill='none' stroke='rgba(255,255,255,0.1)' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M22 11.08V12a10 10 0 1 1-5.93-9.14'/%3E%3Cpolyline points='22 4 12 14.01 9 11.01'/%3E%3C/svg%3E"),
                var(--success-gradient); 
            background-size: 110px, cover;
            background-position: right -15px center, center;
        }

        .close-x { 
            position: absolute; 
            right: 15px; 
            top: 50%; 
            transform: translateY(-50%); 
            width: 32px; 
            height: 32px; 
            background: rgba(255, 255, 255, 0.15); 
            color: white; 
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            cursor: pointer; 
            z-index: 10; 
            transition: background 0.2s; 
        }
        .close-x:hover { 
            background: rgba(255, 255, 255, 0.3); 
            color: white; 
        }
        
        .modal-body { padding: 30px; overflow-y: auto; flex: 1; }
        .modal-body input, .modal-body select { width: 100% !important; box-sizing: border-box !important; display: block !important; }

        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; font-size: 14px; font-weight: bold; margin-bottom: 8px; color: #666; }
        .required-star { color: #ef4444; margin-left: 4px; font-weight: 900; }

        .total-summary-row { 
            margin-top: 20px; 
            padding-top: 15px; 
            border-top: 1.5px dashed #e2e8f0; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        .total-label { font-size: 16px; font-weight: bold; color: #666; }
        .total-amount { font-size: 32px; font-weight: 900; color: var(--primary-blue); font-family: inherit; }

        .btn-confirm-final { background: var(--confirm-dark); color: white; width: 100%; padding: 16px; border-radius: 12px; border: none; font-size: 16px; font-weight: bold; cursor: pointer; transition: all 0.2s; }
        .btn-confirm-final:hover { background: var(--confirm-hover); }

        .pay-method-btn { flex: 1; padding: 14px; border-radius: 12px; border: 2px solid #e2e8f0; background: white; color: #64748b; font-weight: bold; cursor: pointer; transition: all 0.2s; text-align: center; font-size: 15px; }
        .pay-method-btn.active-cash { border-color: #10b981; background: #ecfdf5; color: #059669; }
        .pay-method-btn.active-transfer { border-color: #f59e0b; background: #fffbeb; color: #d97706; }
        
        .btn-prev-step { background: white; color: #64748b; border: 1px solid #cbd5e1; padding: 14px; border-radius: 12px; font-weight: bold; cursor: pointer; transition: all 0.2s; flex: 1; font-size: 15px; }
        .btn-prev-step:hover { background: #f8fafc; }
        .btn-complete { background: #10b981; color: white; border: none; padding: 14px; border-radius: 12px; font-weight: bold; cursor: pointer; transition: all 0.2s; flex: 2; font-size: 15px; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-complete:hover:not(:disabled) { background: #059669; transform: scale(1.02); }
        .btn-complete:active:not(:disabled) { transform: scale(0.98); }
        .btn-complete:disabled { background: #94a3b8; cursor: not-allowed; opacity: 0.8; transform: none; }

        /* Loading Spinner Animation */
        @keyframes spin { 100% { transform: rotate(360deg); } }
        .spinner { animation: spin 1s linear infinite; width: 20px; height: 20px; }

        .order-page { flex: 1; overflow-y: auto; padding: 30px 20px; width: 100%; display: none; flex-direction: column; align-items: center; background-color: var(--bg-gray); }
        .order-page-inner { width: 100%; max-width: 1000px; }
        .order-page-header { display: flex; align-items: center; gap: 20px; margin-bottom: 24px; flex-wrap: wrap; }
        .order-page-title { font-size: 24px; font-weight: 800; color: #1e293b; margin: 0; flex: 1; }
        .header-actions-group { display: flex; gap: 10px; flex-wrap: wrap; }
        .btn-action-outline { background: white; border: 2px solid #e2e8f0; padding: 10px 16px; border-radius: 12px; font-weight: bold; color: #64748b; cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 8px; font-size: 14px; }
        .btn-action-outline:hover { background: #f8fafc; border-color: #cbd5e1; transform: translateY(-1px); }
        
        .filter-panel {
            margin-bottom: 10px;
            width: 100%;
            box-sizing: border-box;
        }
        .filter-row-top {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }
        .filter-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .filter-label {
            font-size: 14px;
            font-weight: bold;
            color: #475569;
            white-space: nowrap;
        }
        .filter-control {
            padding: 0 14px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 14px;
            color: #1e293b;
            outline: none;
            transition: 0.2s;
            font-family: inherit;
            background: white;
            cursor: pointer;
            height: 42px;
            box-sizing: border-box;
        }
        .filter-control:focus { border-color: var(--primary-blue); }
        
        .btn-clear-filters {
            background: var(--primary-blue);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 0 15px;
            height: 42px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: 0.2s;
            font-size: 14px;
            font-weight: bold;
            box-shadow: 0 4px 6px -1px rgba(99, 102, 241, 0.3);
        }
        .btn-clear-filters:hover { 
            background: #4f46e5; 
            transform: translateY(-1px);
            box-shadow: 0 6px 12px -2px rgba(99, 102, 241, 0.4);
        }
        .btn-clear-filters:active {
            transform: translateY(0);
        }

        .search-group { position: relative; flex: 1; min-width: 200px; }
        .search-input { padding: 10px 16px 10px 42px; border: 2px solid #e2e8f0; border-radius: 10px; width: 100%; box-sizing: border-box; font-size: 14px; transition: all 0.2s; height: 42px; outline: none;}
        .search-input:focus { border-color: var(--primary-blue); box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1); }
        .search-icon { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); color: #94a3b8; width: 18px; height: 18px; }

        .results-summary {
            font-size: 13px;
            color: #94a3b8;
            font-weight: 500;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .results-count {
            color: var(--primary-blue);
            font-weight: 800;
        }

        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 25px; }
        .stat-card { background: white; padding: 20px; border-radius: 16px; border: 1px solid #e2e8f0; display: flex; flex-direction: column; position: relative; overflow: hidden; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); }
        .stat-label { font-size: 12px; font-weight: bold; color: #94a3b8; margin-bottom: 10px; }
        .stat-value { font-size: 24px; font-weight: 900; color: #1e293b; }
        .stat-value span { font-size: 14px; font-weight: 500; color: #64748b; margin-left: 4px; }
        .stat-value.pending { color: #ef4444; } 
        .stat-icon-wrapper { position: absolute; right: 15px; top: 15px; width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; }
        .icon-revenue { background: #eef2ff; color: #6366f1; }
        .icon-tickets { background: #eff6ff; color: #3b82f6; }
        .icon-orders { background: #f0fdf4; color: #22c55e; }
        .icon-pending { background: #fff7ed; color: #f97316; }

        .order-table-container { width: 100%; overflow-x: auto; border-radius: 16px; border: 1px solid #e2e8f0; background: white; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05); }
        .order-table { width: 100%; border-collapse: collapse; text-align: left; min-width: 700px; font-size: 14px; }
        .order-table th { background: #f8fafc; padding: 16px 20px; font-weight: bold; color: #475569; border-bottom: 2px solid #e2e8f0; white-space: nowrap; }
        .order-table td { padding: 16px 20px; border-bottom: 1px solid #e2e8f0; color: #1e293b; vertical-align: middle; }
        .order-table tr:hover { background: #f1f5f9; }
        
        .status-badge { display: inline-flex; align-items: center; padding: 4px 10px; border-radius: 9999px; font-size: 12px; font-weight: bold; white-space: nowrap; border: 1px solid transparent; }
        .status-paid { background: #dcfce7; color: #059669; border-color: #a7f3d0; }
        .status-unpaid-red { background: #fee2e2; color: #b91c1c; border-color: #fecaca; }
        .status-pending-orange { background: #fef3c7; color: #d97706; border-color: #fde68a; }
        
        .action-icon-btn { background: none; border: none; cursor: pointer; padding: 8px; border-radius: 8px; transition: 0.2s; display: inline-flex; align-items: center; justify-content: center;}
        .action-icon-btn.edit:hover { background: #e0e7ff; color: #4338ca; }
        .action-icon-btn.delete:hover { background: #fee2e2; color: #b91c1c; }
        .action-icon-btn.verify { color: #10b981; }
        .action-icon-btn.verify:hover { background: #d1fae5; color: #065f46; }
        .action-icon-btn svg { width: 18px; height: 18px; }

        .success-checkmark {
            width: 80px; height: 80px; 
            margin: 0 auto 15px; 
            background: #d1fae5; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            color: #10b981;
        }
        .success-checkmark svg { width: 45px; height: 45px; }

        .warning-exclamation {
            width: 80px; height: 80px; 
            margin: 0 auto 20px; 
            background: #fee2e2; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            color: #ef4444;
        }
        .warning-exclamation svg { width: 40px; height: 40px; }

        .copy-info-box {
            background: #f1f5f9;
            padding: 18px;
            border-radius: 12px;
            margin-top: 20px;
            border: 1px solid #e2e8f0;
            text-align: left;
            position: relative;
        }
        .copy-info-text {
            font-size: 11px; 
            line-height: 1.65;
            color: #475569;
            white-space: pre-wrap;
            margin-bottom: 12px;
            user-select: all;
        }
        .btn-copy-action {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: 1.5px solid #cbd5e1;
            background: white;
            color: #64748b;
            font-weight: bold;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center; gap: 6px;
        }
        .btn-copy-action:hover {
            background: #f8fafc;
            border-color: var(--primary-blue);
            color: var(--primary-blue);
        }

        @media screen and (max-width: 768px) {
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .order-page-header { flex-direction: column; align-items: stretch; gap: 15px; }
            .header-actions-group { flex-direction: column; width: 100%; gap: 10px; }
            .btn-action-outline { width: 100%; justify-content: center; }
            .filter-row-top { flex-direction: column; align-items: stretch; gap: 12px; }
            .filter-group { width: 100%; }
            .filter-control { flex: 1; width: 100%; box-sizing: border-box; }
            .btn-clear-filters { width: 100%; }
            .search-group { width: 100%; }
        }
    </style>
</head>
<body id="main-body">

    <div id="custom-toast" class="custom-toast">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="8" x2="12" y2="12"></line>
            <line x1="12" y1="16" x2="12.01" cy="16"></line>
        </svg>
        <span id="toast-msg">上限為 5 張</span>
    </div>

    <!-- 開場歡迎提示視窗 (預設顯示 style="display: flex;") -->
    <div class="modal-overlay" id="modal-welcome" style="display: flex; z-index: 9999;">
        <div class="modal" style="max-width: 400px; text-align: center;">
            <div class="modal-header" style="padding: 25px 20px;">
                <span>系統公告</span>
            </div>
            <div class="modal-body" style="padding: 40px 30px;">
                <div style="margin-bottom: 20px;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="var(--primary-blue)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="12" y1="16" x2="12" y2="12"></line>
                        <line x1="12" y1="8" x2="12.01" y2="8"></line>
                    </svg>
                </div>
                <h3 style="margin: 0 0 15px 0; color: #1e293b; font-size: 19px; line-height: 1.4;">歡迎來到 MIA 春季成發<br>即時座位系統</h3>
                <p style="margin: 0 0 30px 0; color: #475569; font-size: 15px; line-height: 1.6;">
                    目前顯示的座位為即時狀態。<br>
                    如需劃位，請洽詢MIA光復館櫃台人員！
                </p>
                <button class="btn-complete" style="width: 100%; margin-bottom: 20px;" onclick="window.closeModal('modal-welcome')">我知道了</button>
                
                <!-- 隱藏版管理員捷徑 -->
                <div style="display: inline-flex; justify-content: center; align-items: center; gap: 6px; color: #cbd5e1; font-size: 13px; font-weight: bold; cursor: pointer; transition: 0.2s;" 
                     onclick="window.closeModal('modal-welcome'); window.handleHeaderAction();" 
                     onmouseover="this.style.color='#94a3b8'" 
                     onmouseout="this.style.color='#cbd5e1'">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                        <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                    </svg>
                    管理員專區
                </div>
            </div>
        </div>
    </div>

    <!-- 管理員登入 -->
    <div class="modal-overlay" id="modal-login">
        <div class="modal" style="max-width: 400px;">
            <div class="modal-header login-header">
                <span>管理員登入</span>
                <span class="close-x" onclick="window.closeModal('modal-login')">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </span>
            </div>
            <div class="modal-body">
                <div class="form-group" style="margin-bottom: 25px;">
                    <input type="password" id="admin-pw-input" placeholder="請輸入管理員密碼" style="padding:16px; border:1.5px solid #ddd; border-radius:12px; width:100%; box-sizing:border-box; font-size: 16px;">
                    <div id="login-error-msg" style="color: #ef4444; font-size: 13px; margin-top: 10px; font-weight: bold; display: none; text-align: center;">密碼錯誤，請重新輸入！</div>
                </div>
                <div style="display:flex; gap:10px;">
                    <button class="btn-confirm-final" style="background: white; color: #64748b; border: 1.5px solid #cbd5e1;" onclick="window.closeModal('modal-login')">取消</button>
                    <button class="btn-confirm-final" onclick="window.submitLogin()">登入</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 登出確認 -->
    <div class="modal-overlay" id="modal-logout-confirm">
        <div class="modal" style="max-width: 400px;">
            <div class="modal-header login-header">
                <span>系統登出</span>
                <span class="close-x" onclick="window.closeModal('modal-logout-confirm')">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </span>
            </div>
            <div class="modal-body">
                <div style="text-align: center; font-size: 16px; color: #475569; margin-bottom: 30px; font-weight: bold;">您確定要登出管理員模式嗎？</div>
                <div style="display:flex; gap:10px;">
                    <button class="btn-confirm-final" style="background: white; color: #64748b; border: 1.5px solid #cbd5e1;" onclick="window.closeModal('modal-logout-confirm')">取消</button>
                    <button class="btn-confirm-final" style="background: #ef4444;" onclick="window.confirmLogout()">確認登出</button>
                </div>
            </div>
        </div>
    </div>

    <div class="header">
        <div class="header-title-wrapper">
            <img src="logo.png" class="header-logo" alt="MIA LOGO" onerror="this.style.display='none'">
            <div class="header-title">
                <h1>2026 8th MIA SPRING SHOW</h1>
                <span>即時座位票務系統</span>
            </div>
        </div>
        <div class="header-actions">
            <button class="menu-btn" id="header-back-btn" onclick="window.closeOrderManager()" style="display:none;" title="返回購票畫面">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M2 9a3 3 0 0 1 0 6v2a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-2a3 3 0 0 1 0-6V7a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2Z"/>
                    <path d="M13 5v2"/>
                    <path d="M13 17v2"/>
                    <path d="M13 11v2"/>
                </svg>
            </button>
            <button class="menu-btn" id="header-order-btn" onclick="window.openOrderManager()" style="display:none;" title="訂單管理">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                    <polyline points="14 2 14 8 20 8"></polyline>
                    <line x1="16" y1="13" x2="8" y2="13"></line>
                    <line x1="16" y1="17" x2="8" y2="17"></line>
                    <polyline points="10 9 9 9 8 9"></polyline>
                </svg>
            </button>
            <button class="menu-btn" id="header-action-btn" onclick="window.handleHeaderAction()">
                <svg id="header-icon-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                    <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                </svg>
            </button>
        </div>
    </div>

    <div class="main-content" id="main-content-area">
        <div class="legend-area">
            <div class="legend-item"><div class="legend-box" style="background:var(--seat-bg-avail); border: 1px solid var(--seat-border-avail); box-shadow: 0 2px 0 0 var(--seat-shadow-avail);"></div> 可選位</div>
            <div class="legend-item"><div class="legend-box" style="background:var(--seat-bg-selected); box-shadow: 0 2px 0 0 var(--seat-shadow-selected);"></div> 已選擇</div>
            <div class="legend-item"><div class="legend-box" style="background:var(--seat-bg-sold); box-shadow: 0 2px 0 0 var(--seat-shadow-sold);"></div> 已售出</div>
            <div class="legend-item"><div class="legend-box" style="background:var(--seat-bg-camera); box-shadow: 0 2px 0 0 var(--seat-shadow-camera);"></div> 攝影席</div>
            <div class="legend-item"><div class="legend-box" style="background:var(--seat-bg-reserve); box-shadow: 0 2px 0 0 var(--seat-shadow-reserve);"></div> 保留席</div>
        </div>
        <div class="venue-wrapper">
            <div class="stage-area">
                <div class="screen">舞 台</div>
                <div class="view-notice">座位圖示僅供參考，實際視野可能因場地佈置略有差異。</div>
                <div class="venue-container" id="grid">
                    <div id="LT" class="block"></div><div id="MT" class="block"></div><div id="RT" class="block"></div>
                    <div id="LM" class="block"></div><div id="MM" class="block"></div><div id="RM" class="block"></div>
                    <div id="LB" class="block"></div><div id="MB" class="block"></div><div id="RB" class="block"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="order-page" id="order-page">
        <div class="order-page-inner">
            <div class="order-page-header">
                <h2 class="order-page-title">訂單管理</h2>
                <div class="header-actions-group">
                    <button class="btn-action-outline" onclick="window.exportToExcel()" title="匯出完整 Excel (含座位圖與訂單)">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                        匯出總表 (Excel)
                    </button>
                    <button class="btn-action-outline" onclick="window.exportDailyReceipts()" title="依據所選的收款日期匯出名冊">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                        匯出當日收款
                    </button>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">總營收</div>
                    <div class="stat-value" id="stat-revenue">$0</div>
                    <div id="stat-cash-revenue" style="font-size: 13px; color: #ef4444; font-weight: 600; margin-top: 5px;">現金收入 $0</div>
                    <div class="stat-icon-wrapper icon-revenue">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" cy="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">已售票數</div>
                    <div class="stat-value" id="stat-tickets">0 <span>張</span></div>
                    <div class="stat-icon-wrapper icon-tickets">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="4" width="20" height="16" rx="2"></rect><line x1="2" y1="10" x2="22" y2="10"></line></svg>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">訂單總數</div>
                    <div class="stat-value" id="stat-orders">0 <span>筆</span></div>
                    <div class="stat-icon-wrapper icon-orders">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M6 2 3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z"></path><path d="M3 6h18"></path><path d="M16 10a4 4 0 0 1-8 0"></path></svg>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">待核銷筆數</div>
                    <div class="stat-value pending" id="stat-pending">0 <span>筆</span></div>
                    <div class="stat-icon-wrapper icon-pending">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="12" cy="4" x2="12" y2="15"></line>
                            <line x1="12" y1="20" x2="12.01" y2="20"></line>
                        </svg>
                    </div>
                </div>
            </div>

            <div class="filter-panel">
                <div class="filter-row-top">
                    <div class="filter-group">
                        <span class="filter-label">訂單日期</span>
                        <input type="date" id="order-date-input" class="filter-control" onchange="window.renderOrders()">
                    </div>
                    <div class="filter-group">
                        <span class="filter-label">收款日期</span>
                        <input type="date" id="receipt-date-input" class="filter-control" onchange="window.renderOrders()">
                    </div>
                    <div class="filter-group">
                        <span class="filter-label">付款方式</span>
                        <select id="filter-payment" class="filter-control" onchange="window.renderOrders()">
                            <option value="all">全部</option>
                            <option value="cash">現金</option>
                            <option value="transfer">匯款</option>
                            <option value="free">免付費</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <span class="filter-label">狀態</span>
                        <select id="filter-status" class="filter-control" onchange="window.renderOrders()">
                            <option value="all">全部</option>
                            <option value="pending">待核銷</option>
                            <option value="paid">已完成</option>
                        </select>
                    </div>
                    <button class="btn-clear-filters" onclick="window.clearAllFilters()">清除篩選</button>
                    <div class="search-group">
                        <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="11" cy="11" r="8"></circle>
                            <line x1="21" cy="21" x2="16.65" y2="16.65"></line>
                        </svg>
                        <input type="text" id="order-search-input" class="search-input" placeholder="搜尋姓名/電話/座位..." oninput="window.renderOrders()">
                    </div>
                </div>
            </div>

            <div class="results-summary">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
                <span>共計 <span id="results-count-number" class="results-count">0</span> 筆符合篩選條件</span>
            </div>

            <div class="order-table-container">
                <table class="order-table">
                    <thead>
                        <tr>
                            <th>訂單時間</th>
                            <th>購票人資訊</th>
                            <th>座位</th>
                            <th>金額/方式</th>
                            <th>狀態</th>
                            <th style="text-align:right;">操作</th>
                        </tr>
                    </thead>
                    <tbody id="order-table-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 懸浮購票列 -->
    <div class="floating-bar" id="floating-bar">
        <div class="floating-bar-left">
            <div class="floating-cart-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="8" cy="21" r="1"></circle>
                    <circle cx="19" cy="21" r="1"></circle>
                    <path d="M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.12"></path>
                </svg>
            </div>
            <div class="floating-info">
                <div class="floating-info-top" id="display-sub-info">已選 0 座位</div>
            </div>
        </div>
        <button class="btn-floating-confirm" id="btn-open-modal">確認購票</button>
    </div>

    <!-- 購票步驟 -->
    <div class="modal-overlay" id="modal-purchase">
        <div class="modal">
            <div class="modal-header">
                <span>購票資訊</span>
                <span class="close-x" onclick="window.closeModal('modal-purchase')">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>劃位座位</label>
                    <input type="text" id="buy-seat-list" readonly style="padding:16px 14px; border:none; background:#f9f9f9; color:var(--primary-blue); font-weight:900; border-radius:8px; font-size:19px; font-family: inherit;">
                </div>
                <div class="form-group">
                    <label>票價類型</label>
                    <select id="p-type" style="padding:14px; border:1px solid #ddd; border-radius:8px; font-size:16px;" onchange="window.updateTotalDisplay()">
                        <option value="650">早鳥優惠 NT$ 650 / 張</option>
                        <option value="800">一般原價 NT$ 800 / 張</option>
                        <option value="0">公關票價 NT$ 0 / 張</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>付款方式</label>
                    <select id="p-pay-method-select" style="padding:14px; border:1px solid #ddd; border-radius:8px; font-size:16px;">
                        <option value="cash">現金</option>
                        <option value="transfer">匯款</option>
                    </select>
                </div>
                <div class="total-summary-row">
                    <div class="total-label">總計金額</div>
                    <div id="buy-final-total" class="total-amount">NT$ 0</div>
                </div>
                <button class="btn-confirm-final" style="margin-top: 20px;" onclick="window.goToStep2()">下一步：填寫購票資訊</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modal-payment">
        <div class="modal">
            <div class="modal-header">
                <span>購票資訊</span>
                <span class="close-x" onclick="window.closeModal('modal-payment')">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label id="label-name">購票姓名 <span class="required-star">*</span></label>
                    <input type="text" id="p-name" placeholder="請輸入姓名" style="padding:14px; border:1px solid #ddd; border-radius:8px; font-size:16px;">
                </div>
                <div class="form-group">
                    <label id="label-phone">聯絡電話 <span class="required-star">*</span></label>
                    <input type="tel" id="p-phone" placeholder="請輸入 09 開頭的 10 碼電話" maxlength="10" style="padding:14px; border:1px solid #ddd; border-radius:8px; font-size:16px;">
                </div>
                <div class="form-group">
                    <label>備註資訊</label>
                    <input type="text" id="p-note" placeholder="請輸入備註資訊" style="padding:14px; border:1px solid #ddd; border-radius:8px; font-size:16px;">
                </div>
                <div style="display:flex; gap:10px;">
                    <button class="btn-prev-step" onclick="window.goToStep1()">上一步</button>
                    <!-- 加上 id 以便操作 Loading 狀態 -->
                    <button class="btn-complete" id="btn-submit-order" onclick="window.submitFinalOrder()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
                        確認訂票
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modal-success">
        <div class="modal">
            <div class="modal-header success-header">
                <span>劃位完成</span>
                <span class="close-x" onclick="window.closeModal('modal-success')">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </span>
            </div>
            <div class="modal-body" style="text-align: center; padding: 30px;">
                <div class="success-checkmark">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                </div>
                <div id="success-status-label" style="display: inline-block; padding: 8px 24px; border-radius: 999px; font-weight: bold; font-size: 15px; margin-bottom: 5px;">訂單狀態：待付款</div>
                <div id="copy-transfer-box" class="copy-info-box" style="display:none;">
                    <div id="copy-transfer-text" class="copy-info-text"></div>
                    <button class="btn-copy-action" onclick="window.copyTransferInfo()">點擊複製匯款資訊</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 管理員核銷確認 -->
    <div class="modal-overlay" id="modal-verify">
        <div class="modal" style="max-width: 420px;">
            <div class="modal-header verify-header">
                <span id="verify-modal-title-text">核銷確認</span>
                <span class="close-x" onclick="window.closeModal('modal-verify')">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </span>
            </div>
            <div class="modal-body">
                <input type="hidden" id="verify-order-id">
                <div style="display: flex; flex-direction: column; gap: 15px; margin-bottom: 30px; padding: 0 5px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; min-height: 40px;">
                        <span style="font-size: 15px; font-weight: bold; color: #666; white-space: nowrap; flex-shrink: 0;">購票姓名：</span>
                        <span id="verify-name" style="font-weight: bold; color: #1e293b; font-size: 15px; text-align: right;"></span>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; min-height: 40px;">
                        <span style="font-size: 15px; font-weight: bold; color: #666; white-space: nowrap; flex-shrink: 0;">應收金額：</span>
                        <span id="verify-total" style="font-weight: bold; color: var(--primary-blue); font-size: 15px; text-align: right;"></span>
                    </div>
                    <div id="verify-transfer-info" style="display:none; justify-content: space-between; align-items: center; min-height: 40px;">
                        <span style="font-size: 15px; font-weight: bold; color: #666; white-space: nowrap; flex-shrink: 0;">匯款末五碼：</span>
                        <span id="verify-bank-code" style="font-weight: bold; color: #ef4444; font-size: 15px; text-align: right;"></span>
                    </div>
                </div>
                <div style="display:flex; gap:10px;">
                    <button class="btn-prev-step" onclick="window.closeModal('modal-verify')">取消</button>
                    <!-- 加上 id 以便操作 Loading 狀態 -->
                    <button class="btn-complete" id="btn-confirm-verify" onclick="window.confirmVerify()">確認核銷</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 編輯訂單 -->
    <div class="modal-overlay" id="modal-edit-order">
        <div class="modal" style="max-width: 420px;">
            
            <!-- 第一視圖：編輯表單 -->
            <div id="edit-step-1" style="display: flex; flex-direction: column; height: 100%;">
                <div class="modal-header">
                    <span>編輯訂單</span>
                    <span class="close-x" onclick="window.closeModal('modal-edit-order')">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                    </span>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="edit-order-id">
                    <div class="form-group">
                        <label>匯款末五碼</label>
                        <input type="text" id="edit-order-bank" placeholder="若非匯款請留空" style="padding:14px; border:1px solid #ddd; border-radius:8px; font-size:16px;">
                    </div>
                    <div class="form-group">
                        <label>備註資訊</label>
                        <input type="text" id="edit-order-note" placeholder="例如：寄票" style="padding:14px; border:1px solid #ddd; border-radius:8px; font-size:16px;">
                    </div>
                    <div class="form-group">
                        <label>付款方式 / 狀態</label>
                        <select id="edit-order-status" style="padding:14px; border:1px solid #ddd; border-radius:8px; font-size:16px;">
                            <option value="paid" id="edit-option-paid" style="display:none;">已完成</option>
                            <option value="paid-free" id="edit-option-free" style="display:none;">免付費 (已完成)</option>
                            <option value="pending-cash" id="edit-option-cash">現金（待付款）</option>
                            <option value="pending-transfer" id="edit-option-transfer">匯款（待入帳）</option>
                        </select>
                    </div>
                    <div style="display:flex; gap:10px; margin-top: 10px;">
                        <button class="btn-prev-step" onclick="window.closeModal('modal-edit-order')">取消</button>
                        <button class="btn-complete" onclick="window.saveOrderEdit()">確認變更</button>
                    </div>
                </div>
            </div>

            <!-- 第二視圖：防呆確認 -->
            <div id="edit-step-2" style="display: none; flex-direction: column; height: 100%;">
                <div class="modal-header danger-header">
                    <span>變更確認</span>
                    <span class="close-x" onclick="window.cancelWarning()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                    </span>
                </div>
                <div class="modal-body" style="padding: 32px 24px; text-align: center;">
                    <div class="warning-exclamation">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="12" y1="8" x2="12" y2="12"></line>
                            <line x1="12" y1="16" x2="12.01" y2="16"></line>
                        </svg>
                    </div>
                    <div style="margin-bottom: 30px; text-align: center; padding: 0 10px;">
                        <p style="margin: 0; color: #1e293b; font-size: 16px; font-weight: bold; line-height: 1.6;">此筆訂單已完成核銷，變更付款方式將會：<br><span style="color: #ef4444; font-weight: 800;">退回未核銷狀態</span> 並且 <span style="color: #ef4444; font-weight: 800;">清除收款日期</span></p>
                    </div>
                    <div style="display:flex; gap:12px;">
                        <button class="btn-prev-step" style="padding: 14px; flex: 1;" onclick="window.cancelWarning()">取消</button>
                        <!-- 加上 id 以便操作 Loading 狀態 -->
                        <button class="btn-complete" id="btn-execute-edit" style="background: #ef4444; padding: 14px; flex: 1.5; color: white;" onclick="window.executeOrderEdit()">確定變更</button>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- 刪除訂單專屬視窗 -->
    <div class="modal-overlay" id="modal-delete-order" style="z-index: 4000;">
        <div class="modal" style="max-width: 420px;">
            <div class="modal-header delete-header">
                <span>刪除訂單</span>
                <span class="close-x" onclick="window.closeModal('modal-delete-order')">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </span>
            </div>
            <div class="modal-body" style="padding: 32px 24px; text-align: center;">
                <div class="warning-exclamation" style="margin-bottom: 15px;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="3 6 5 6 21 6"></polyline>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                        <line x1="10" y1="11" x2="10" y2="17"></line>
                        <line x1="14" y1="11" x2="14" y2="17"></line>
                    </svg>
                </div>
                
                <div style="margin-bottom: 25px;">
                    <h3 style="margin: 0 0 10px 0; color: #1e293b; font-size: 16px;">您即將刪除 <span id="del-order-name" style="color:var(--primary-blue)"></span> 的訂單</h3>
                    <p style="margin: 0; color: #1e293b; font-weight: bold; font-size: 16px;">資料<span style="color: #ef4444;">無法恢復</span>，且座位將<span style="color: #ef4444;">立即釋出！</span></p>
                </div>

                <input type="hidden" id="delete-target-id">

                <div style="display:flex; gap:12px;">
                    <button class="btn-prev-step" style="padding: 14px; flex: 1;" onclick="window.closeModal('modal-delete-order')">取消</button>
                    <!-- 加上 id 以便操作 Loading 狀態 -->
                    <button class="btn-complete" id="btn-execute-delete" style="background: #ef4444; padding: 14px; flex: 1.5; color: white;" onclick="window.executeDeleteOrder()">確定刪除</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js";
        import { getDatabase, ref, onValue, update } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBpxxZ0DJvGJdu8anqJWmGeGHf_wUufv28",
            authDomain: "miaspringshow.firebaseapp.com",
            databaseURL: "https://miaspringshow-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "miaspringshow",
            storageBucket: "miaspringshow.firebasestorage.app",
            messagingSenderId: "756405426670",
            appId: "1:756405426670:web:cc234426bb8c3ac2ce96ff"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        
        let isAdmin = false;
        let seatsData = {};
        let ordersData = {};
        let selectedIds = [];
        let toastTimeout = null;
        let originalOrderState = null;
        
        const iconLock = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>`;
        const iconUnlock = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 9.9-1"></path></svg>`;

        const cameraSeats = ["G15", "G16", "G17", "H15", "H16", "H17"];
        const reserveSeats = [];
        for(let i=1; i<=27; i++) reserveSeats.push("A"+i); 
        for(let i=1; i<=27; i++) reserveSeats.push("B"+i); 
        for(let i=10; i<=14; i++) { reserveSeats.push("G"+i); reserveSeats.push("H"+i); }
        for(let i=18; i<=22; i++) { reserveSeats.push("G"+i); reserveSeats.push("H"+i); }

        onValue(ref(db, 'seats'), (snapshot) => { seatsData = snapshot.val() || {}; render(); });
        onValue(ref(db, 'orders'), (snapshot) => { 
            ordersData = snapshot.val() || {}; 
            const orderPage = document.getElementById('order-page');
            if(orderPage && orderPage.style.display === 'flex') window.renderOrders();
        });

        window.showToast = (msg, type = 'error') => {
            const toast = document.getElementById('custom-toast');
            const toastMsg = document.getElementById('toast-msg');
            if (!toast || !toastMsg) return;
            toastMsg.innerText = msg;
            toast.className = 'custom-toast show';
            if(type === 'success') toast.classList.add('success');
            if (toastTimeout) clearTimeout(toastTimeout);
            toastTimeout = setTimeout(() => {
                toast.classList.remove('show');
                toastTimeout = null;
            }, 3000);
        };

        window.handleHeaderAction = () => {
            if (!isAdmin) {
                document.getElementById('modal-login').style.display = 'flex';
                document.getElementById('admin-pw-input').value = '';
                document.getElementById('login-error-msg').style.display = 'none';
                setTimeout(() => document.getElementById('admin-pw-input').focus(), 100);
            } else {
                document.getElementById('modal-logout-confirm').style.display = 'flex';
            }
        };

        window.submitLogin = () => {
            const pw = document.getElementById('admin-pw-input').value;
            if(pw === "mia2026") {
                isAdmin = true;
                document.getElementById('main-body').classList.add('logged-in');
                document.getElementById('header-action-btn').innerHTML = iconUnlock;
                document.getElementById('header-order-btn').style.display = 'flex';
                window.closeModal('modal-login');
                render(); 
                window.showToast("登入成功", "success");
            } else {
                document.getElementById('login-error-msg').style.display = 'block';
                document.getElementById('admin-pw-input').value = '';
                document.getElementById('admin-pw-input').focus();
            }
        };

        window.confirmLogout = () => {
            isAdmin = false; 
            selectedIds = []; 
            document.getElementById('header-action-btn').innerHTML = iconLock;
            document.getElementById('header-order-btn').style.display = 'none';
            document.getElementById('header-back-btn').style.display = 'none';
            window.closeOrderManager();
            window.closeModal('modal-logout-confirm');
            render(); 
            window.showToast("已成功登出", "success");
        };

        const layout = [
            { id: 'T', rows: 6, L: [6, 7, 9, 10, 11, 9], M: [13, 13, 13, 13, 13, 13], R: [6, 7, 9, 10, 11, 9], start: 'A' }, 
            { id: 'M', rows: 10, L: [9, 9, 9, 9, 9, 9, 9, 9, 8, 5], M: [13, 13, 13, 13, 13, 13, 13, 13, 15, 15], R: [9, 9, 9, 9, 9, 9, 9, 9, 8, 5], start: 'G' }, 
            { id: 'B', rows: 9, L: 5, M: 15, R: 5, start: 'Q' }   
        ];

        function render() {
            layout.forEach(sec => {
                for(let r=0; r<sec.rows; r++){
                    const rowName = String.fromCharCode(sec.start.charCodeAt(0)+r);
                    const cL = Array.isArray(sec.L)?sec.L[r]:sec.L;
                    const cM = Array.isArray(sec.M)?sec.M[r]:sec.M;
                    const cR = Array.isArray(sec.R)?sec.R[r]:sec.R;
                    updateBlock(`L${sec.id}`, rowName, 1, cL);
                    updateBlock(`M${sec.id}`, rowName, cL+1, cL+cM);
                    updateBlock(`R${sec.id}`, rowName, cL+cM+1, cL+cM+cR);
                }
            });
            updateBottomBar();
        }

        function updateBlock(bid, rowName, start, end) {
            const block = document.getElementById(bid);
            if(!block) return;
            if(rowName==='A' || rowName==='G' || rowName==='Q') block.innerHTML = '';
            const rowDiv = document.createElement('div');
            rowDiv.className = 'row';
            for(let s=start; s<=end; s++){
                const id = rowName + s;
                const div = document.createElement('div');
                div.innerText = id;
                const isBlocked = ( (rowName === 'A' || rowName === 'B') && (bid.startsWith('L') || bid.startsWith('R')) );
                if (isBlocked) {
                    div.innerText = "x";
                    div.className = "seat blocked-seat";
                } else if (cameraSeats.includes(id)) {
                    div.className = "seat camera-seat";
                } else {
                    const status = (seatsData[id] && seatsData[id].status) ? seatsData[id].status : 'available';
                    const isReserve = reserveSeats.includes(id);
                    div.className = `seat ${status} ${isReserve ? 'reserve-seat' : ''}`;
                    if(selectedIds.includes(id)) div.classList.add('selected');
                    div.onclick = () => window.handleSeatClick(id);
                }
                rowDiv.appendChild(div);
            }
            block.appendChild(rowDiv);
        }

        window.handleSeatClick = (id) => {
            if(!isAdmin) return;
            const current = seatsData[id] || { status: 'available' };
            if(current.status === 'sold') {
                window.showToast("此座位已售出，請至「訂單管理」進行編輯或刪除", "error");
                return;
            }
            if (selectedIds.includes(id)) {
                selectedIds = selectedIds.filter(i => i !== id);
            } else { 
                if(selectedIds.length >= 5) { 
                    window.showToast("上限為 5 張", "error"); 
                    return; 
                }
                selectedIds.push(id); 
            }
            render();
        };

        function updateBottomBar() {
            const count = selectedIds.length;
            const displaySub = document.getElementById('display-sub-info');
            if(displaySub) displaySub.innerText = `已選 ${count} 座位`;
            const floatingBar = document.getElementById('floating-bar');
            if (floatingBar) {
                if (count > 0 && isAdmin && document.getElementById('order-page').style.display !== 'flex') floatingBar.classList.add('show');
                else floatingBar.classList.remove('show');
            }
        }

        window.closeModal = (mid) => { 
            const m = document.getElementById(mid);
            if(m) {
                m.style.display = 'none'; 
                if (mid === 'modal-edit-order') {
                    document.getElementById('edit-step-1').style.display = 'flex';
                    document.getElementById('edit-step-2').style.display = 'none';
                }
            }
        };

        window.cancelWarning = () => {
            document.getElementById('edit-step-2').style.display = 'none';
            document.getElementById('edit-step-1').style.display = 'flex';
        };

        window.updateTotalDisplay = () => {
            const price = parseInt(document.getElementById('p-type').value) || 0;
            const total = selectedIds.length * price;
            document.getElementById('buy-final-total').innerText = `NT$ ${total.toLocaleString()}`;

            // 新增：根據票價動態調整付款方式
            const paySelect = document.getElementById('p-pay-method-select');
            if (price === 0) {
                paySelect.innerHTML = '<option value="free">免付費</option>';
                paySelect.disabled = true; // 鎖定不可選
            } else {
                paySelect.innerHTML = `
                    <option value="cash">現金</option>
                    <option value="transfer">匯款</option>
                `;
                paySelect.disabled = false; // 開放選擇
            }
        };

        document.getElementById('btn-open-modal').onclick = () => {
            document.getElementById('p-name').value = ""; 
            document.getElementById('p-phone').value = "";
            document.getElementById('p-note').value = "";
            document.getElementById('p-type').value = "650"; // 預設選擇早鳥票
            document.getElementById('modal-payment').style.display = 'none';
            document.getElementById('modal-purchase').style.display = 'flex';
            document.getElementById('buy-seat-list').value = selectedIds.join(', ');
            window.updateTotalDisplay();
        };

        window.goToStep2 = () => {
            // 動態切換第二步的文案與必填星號狀態
            const price = parseInt(document.getElementById('p-type').value) || 0;
            const nameLabel = document.getElementById('label-name');
            const nameInput = document.getElementById('p-name');
            const phoneLabel = document.getElementById('label-phone');
            const phoneInput = document.getElementById('p-phone');
            
            const reqStarHtml = '<span class="required-star">*</span>';

            if (price === 0) {
                nameLabel.innerHTML = `貴賓稱呼 / 單位 ${reqStarHtml}`;
                nameInput.placeholder = "請輸入貴賓稱呼或單位";
                phoneLabel.innerHTML = `聯絡電話`; // 移除必填星號
                phoneInput.placeholder = "請輸入聯絡電話"; // 移除 "(選填)"
                phoneInput.removeAttribute('maxlength'); // 放寬長度限制
            } else {
                nameLabel.innerHTML = `購票姓名 ${reqStarHtml}`;
                nameInput.placeholder = "請輸入姓名";
                phoneLabel.innerHTML = `聯絡電話 ${reqStarHtml}`; // 加上必填星號
                phoneInput.placeholder = "請輸入 09 開頭的 10 碼電話";
                phoneInput.setAttribute('maxlength', '10');
            }

            document.getElementById('modal-purchase').style.display = 'none';
            document.getElementById('modal-payment').style.display = 'flex';
        };

        window.goToStep1 = () => {
            document.getElementById('modal-payment').style.display = 'none';
            document.getElementById('modal-purchase').style.display = 'flex';
        };

        window.copyTransferInfo = () => {
            const text = document.getElementById('copy-transfer-text').innerText;
            const el = document.createElement('textarea');
            el.value = text;
            document.body.appendChild(el);
            el.select();
            document.execCommand('copy');
            document.body.removeChild(el);
            window.showToast("已複製資訊！", "success");
        };

        // 建立 Loading 狀態的通用函數
        const setLoadingState = (btnId, isLoading, originalHtml = '', loadingText = '處理中...') => {
            const btn = document.getElementById(btnId);
            if (!btn) return originalHtml;
            
            if (isLoading) {
                const html = btn.innerHTML;
                btn.disabled = true;
                btn.innerHTML = `<svg class="spinner" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>${loadingText}`;
                return html; // 回傳原始內容以便後續恢復
            } else {
                btn.disabled = false;
                btn.innerHTML = originalHtml;
            }
        };

        window.submitFinalOrder = () => {
            const name = document.getElementById('p-name').value.trim();
            const phone = document.getElementById('p-phone').value.trim();
            const note = document.getElementById('p-note').value.trim();
            const method = document.getElementById('p-pay-method-select').value;
            
            // 針對公關票與一般票做不同的防呆驗證
            if (method === 'free') {
                if(!name) {
                    window.showToast("請填寫貴賓稱呼 / 單位！", "error"); return;
                }
                // 免付費票，電話為選填，不做手機格式強制檢查
            } else {
                if(!name || !phone) {
                    window.showToast("請填寫姓名與電話！", "error"); return;
                }
                const phoneRegex = /^09\d{8}$/;
                if (!phoneRegex.test(phone)) {
                    window.showToast("手機號碼格式錯誤，請輸入 09 開頭的 10 碼數字！", "error"); return;
                }
            }

            // 防呆 Loading 動畫開啟
            const originalBtnHtml = setLoadingState('btn-submit-order', true);

            const typeText = document.getElementById('p-type').options[document.getElementById('p-type').selectedIndex].text;
            const price = parseInt(document.getElementById('p-type').value) || 0;
            const orderId = 'ORD-' + Date.now();
            const status = (method === 'free') ? 'paid' : 'pending'; 
            const total = selectedIds.length * price;
            const createdAt = new Date().toISOString();

            // 若為免付費，自動加上今日的收款日期
            let finalDate = null;
            if (method === 'free') {
                const today = new Date();
                finalDate = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;
            }

            const updates = {};
            updates[`orders/${orderId}`] = {
                orderId, name, phone, ticketType: typeText, seats: selectedIds, 
                total, paymentMethod: method, bankCode: "", note, status, createdAt
            };
            if (finalDate) updates[`orders/${orderId}`].receiptDate = finalDate;

            selectedIds.forEach(id => {
                updates[`seats/${id}`] = { 
                    status: 'sold', name, phone, ticketType: typeText, bankCode: "", note, 
                    paymentMethod: method, orderId
                };
                if (finalDate) updates[`seats/${id}`].receiptDate = finalDate;
            });

            update(ref(db), updates).then(() => { 
                const seatsJoined = selectedIds.join('、');
                selectedIds = []; 
                window.closeModal('modal-payment'); 
                
                const statusLabel = document.getElementById('success-status-label');
                const copyBox = document.getElementById('copy-transfer-box');
                
                if (method === 'free') {
                    statusLabel.innerText = "訂單狀態：已完成 (公關免付費)";
                    statusLabel.style.background = "#dcfce7";
                    statusLabel.style.color = "#059669";
                    copyBox.style.display = "none";
                } else if (method === 'cash') {
                    statusLabel.innerText = "訂單狀態：待付款";
                    statusLabel.style.background = "#fee2e2";
                    statusLabel.style.color = "#b91c1c";
                    copyBox.style.display = "none";
                } else {
                    statusLabel.innerText = "訂單狀態：待入帳";
                    statusLabel.style.background = "#fef3c7";
                    statusLabel.style.color = "#d97706";
                    copyBox.style.display = "block";
                    
                    const transferText = `您好~您已成功預訂MIA春季成果發表座位\n為協助您保留座位，請於今日內完成匯款，逾期將釋出座位，敬請見諒。\n📍 座位：${seatsJoined}\n📍 金額：$${total.toLocaleString()}\n—\n📌中國信託（822）2995-4080-2139\n匯款 / 轉帳完成後請回覆：\n➊ 購票姓名 \n➋ 匯款金額\n❸ 帳號後五碼`;
                    document.getElementById('copy-transfer-text').innerText = transferText;
                }
                
                document.getElementById('modal-success').style.display = 'flex';
                render(); 
                window.showToast("劃位完成！", "success");
            }).catch((err) => {
                console.error(err);
                window.showToast("送出失敗，請檢查網路連線", "error");
            }).finally(() => {
                // 防呆 Loading 動畫關閉
                setLoadingState('btn-submit-order', false, originalBtnHtml);
            });
        };

        window.openOrderManager = () => {
            document.getElementById('main-content-area').style.display = 'none';
            document.getElementById('floating-bar').classList.remove('show');
            document.getElementById('order-page').style.display = 'flex';
            document.getElementById('header-order-btn').style.display = 'none';
            document.getElementById('header-back-btn').style.display = 'flex';
            
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            document.getElementById('order-date-input').value = `${yyyy}-${mm}-${dd}`;
            document.getElementById('receipt-date-input').value = ""; 
            
            window.renderOrders();
        };

        window.closeOrderManager = () => {
            document.getElementById('order-page').style.display = 'none';
            document.getElementById('main-content-area').style.display = 'flex';
            if (isAdmin) {
                document.getElementById('header-order-btn').style.display = 'flex';
                document.getElementById('header-back-btn').style.display = 'none';
            }
            updateBottomBar();
        };

        window.clearAllFilters = () => {
            document.getElementById('order-date-input').value = '';
            document.getElementById('receipt-date-input').value = '';
            document.getElementById('filter-payment').value = 'all';
            document.getElementById('filter-status').value = 'all';
            document.getElementById('order-search-input').value = '';
            window.renderOrders();
        };

        window.renderOrders = () => {
            const tbody = document.getElementById('order-table-body');
            const searchInput = document.getElementById('order-search-input');
            const orderDateInput = document.getElementById('order-date-input');
            const receiptDateInput = document.getElementById('receipt-date-input');
            const paymentInput = document.getElementById('filter-payment');
            const statusInput = document.getElementById('filter-status');
            
            const keyword = searchInput ? searchInput.value.trim().toLowerCase() : "";
            const selectedOrderDate = orderDateInput ? orderDateInput.value : "";
            const selectedReceiptDate = receiptDateInput ? receiptDateInput.value : "";
            const selectedPayment = paymentInput ? paymentInput.value : "all";
            const selectedStatus = statusInput ? statusInput.value : "all";
            
            if(!tbody) return;
            tbody.innerHTML = '';
            
            const allOrders = Object.values(ordersData).sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            let dateFilteredOrders = allOrders;
            if (selectedOrderDate !== "" || selectedReceiptDate !== "") {
                dateFilteredOrders = allOrders.filter(o => {
                    let matchOrderDate = true;
                    let matchReceiptDate = true;
                    if (selectedOrderDate !== "") {
                        const oDate = new Date(o.createdAt);
                        const y = oDate.getFullYear(), m = String(oDate.getMonth()+1).padStart(2,'0'), d = String(oDate.getDate()).padStart(2,'0');
                        const createdDateStr = `${y}-${m}-${d}`;
                        matchOrderDate = (createdDateStr === selectedOrderDate || o.reportDate === selectedOrderDate);
                    }
                    if (selectedReceiptDate !== "") {
                        matchReceiptDate = (o.receiptDate === selectedReceiptDate || o.reportDate === selectedReceiptDate);
                    }
                    return matchOrderDate && matchReceiptDate;
                });
            }

            let filteredArray = dateFilteredOrders.filter(o => {
                if (selectedStatus !== 'all' && o.status !== selectedStatus) return false;
                if (selectedPayment !== 'all' && o.paymentMethod !== selectedPayment) return false;
                if (keyword !== "") {
                    const nameMatch = o.name.toLowerCase().includes(keyword);
                    const phoneMatch = o.phone.toLowerCase().includes(keyword);
                    const seatMatch = (o.seats || []).some(s => s.toLowerCase().includes(keyword));
                    if (!nameMatch && !phoneMatch && !seatMatch) return false;
                }
                return true;
            });

            let totalRevenue = 0, cashRevenue = 0;
            filteredArray.forEach(o => {
                let isCountable = false;
                if (o.paymentMethod === 'transfer') {
                    if ((o.bankCode && o.bankCode.trim() !== "") || o.status === 'paid') {
                        isCountable = true;
                    }
                } else {
                    isCountable = true; 
                }
                if (isCountable) {
                    totalRevenue += o.total || 0;
                }
                if (o.status === 'paid' && o.paymentMethod === 'cash') {
                    cashRevenue += o.total || 0;
                }
            });

            document.getElementById('stat-revenue').innerText = `$${totalRevenue.toLocaleString()}`;
            document.getElementById('stat-cash-revenue').innerText = `現金收入 $${cashRevenue.toLocaleString()}`;
            
            let ticketsCount = 0, ordersCount = 0, pendingCount = 0;
            filteredArray.forEach(o => {
                ordersCount++;
                ticketsCount += (o.seats || []).length;
                if(o.status === 'pending') pendingCount++;
            });
            document.getElementById('stat-tickets').innerHTML = `${ticketsCount} <span>張</span>`;
            document.getElementById('stat-orders').innerHTML = `${ordersCount} <span>筆</span>`;
            document.getElementById('stat-pending').innerHTML = `${pendingCount} <span>筆</span>`;
            document.getElementById('results-count-number').innerText = filteredArray.length;

            if(filteredArray.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; color:#999; padding:40px;">找不到符合條件的訂單</td></tr>`;
                return;
            }

            filteredArray.forEach(o => {
                const dateObj = new Date(o.createdAt);
                const timeString = dateObj.toLocaleString('zh-TW', { month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', hour12: false });
                
                let statusLabel = (o.status === 'paid') ? '已完成' : (o.paymentMethod === 'cash' ? '待付款' : '待入帳');
                let statusClass = (o.status === 'paid') ? 'status-paid' : (o.paymentMethod === 'cash' ? 'status-unpaid-red' : 'status-pending-orange');

                let subDateHtml = '';
                if (o.status === 'paid' && o.receiptDate) {
                    subDateHtml += `<div style="font-size:10px; font-weight:bold; color:#10b981; margin-top:4px;">收款日: ${o.receiptDate}</div>`;
                } else if (o.reportDate && o.paymentMethod === 'transfer') {
                    subDateHtml += `<div style="font-size:10px; font-weight:bold; color:var(--primary-blue); margin-top:4px;">收款日: ${o.reportDate}</div>`;
                }
                
                let methodStr = '免付費';
                if (o.paymentMethod === 'cash') methodStr = '現金';
                else if (o.paymentMethod === 'transfer') methodStr = '匯款';

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><div style="font-weight:bold;">${timeString}</div>${subDateHtml}</td>
                    <td><div style="font-weight:bold;">${o.name}</div><div style="font-size:11px; color:#94a3b8;">${o.phone}</div></td>
                    <td style="max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${(o.seats || []).join(', ')}</td>
                    <td>
                        <div style="font-weight:bold; color:var(--primary-blue);">NT$ ${o.total.toLocaleString()}</div>
                        <div style="font-size:11px; color:#94a3b8;">${methodStr}</div>
                    </td>
                    <td><span class="status-badge ${statusClass}">${statusLabel}</span></td>
                    <td>
                        <div style="display: flex; justify-content: flex-end; align-items: center; gap: 4px;">
                            ${o.status === 'pending' ? `<button class="action-icon-btn verify" onclick="window.openVerifyOrder('${o.orderId}')"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg></button>` : ''}
                            <button class="action-icon-btn edit" onclick="window.openEditOrder('${o.orderId}')"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button>
                            <button class="action-icon-btn delete" onclick="window.openDeleteModal('${o.orderId}')"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg></button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        };

        window.openVerifyOrder = (orderId) => {
            const o = ordersData[orderId];
            if(!o) return;
            document.getElementById('verify-order-id').value = orderId;
            document.getElementById('verify-name').innerText = o.name;
            document.getElementById('verify-total').innerText = `NT$ ${o.total.toLocaleString()}`;
            const isCash = o.paymentMethod === 'cash';
            document.getElementById('verify-modal-title-text').innerText = isCash ? '現金收款確認' : '匯款入帳確認';
            document.getElementById('verify-transfer-info').style.display = isCash ? 'none' : 'flex';
            if (!isCash) {
                document.getElementById('verify-bank-code').innerText = o.bankCode || "未提供";
                document.getElementById('btn-confirm-verify').disabled = (!o.bankCode || o.bankCode.trim() === "");
            } else {
                document.getElementById('btn-confirm-verify').disabled = false;
            }
            document.getElementById('modal-verify').style.display = 'flex';
        };

        window.confirmVerify = () => {
            const orderId = document.getElementById('verify-order-id').value;
            const o = ordersData[orderId];
            if(!o) return;

            const originalBtnHtml = setLoadingState('btn-confirm-verify', true);

            let finalDate = "";
            if (o.paymentMethod === 'transfer') {
                finalDate = o.reportDate; 
            } else {
                const today = new Date();
                finalDate = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;
            }
            if(!finalDate) { 
                window.showToast("資料異常：找不到有效收款日！"); 
                setLoadingState('btn-confirm-verify', false, originalBtnHtml);
                return; 
            }
            const updates = {};
            updates[`orders/${orderId}/status`] = 'paid';
            updates[`orders/${orderId}/receiptDate`] = finalDate;
            if (o.seats) o.seats.forEach(s => updates[`seats/${s}/receiptDate`] = finalDate);
            
            update(ref(db), updates).then(() => { 
                window.closeModal('modal-verify'); 
                window.showToast("核銷成功！", "success"); 
            }).catch(err => {
                console.error(err);
                window.showToast("核銷失敗，請重試", "error");
            }).finally(() => {
                setLoadingState('btn-confirm-verify', false, originalBtnHtml);
            });
        };

        window.openEditOrder = (orderId) => {
            const o = ordersData[orderId];
            if(!o) return;
            document.getElementById('edit-order-id').value = orderId;
            document.getElementById('edit-order-bank').value = o.bankCode || "";
            document.getElementById('edit-order-note').value = o.note || "";
            
            originalOrderState = { status: o.status, paymentMethod: o.paymentMethod };

            const statusSelect = document.getElementById('edit-order-status');
            const paidOption = document.getElementById('edit-option-paid');
            const freeOption = document.getElementById('edit-option-free');
            const cashOption = document.getElementById('edit-option-cash');
            const transferOption = document.getElementById('edit-option-transfer');
            
            paidOption.style.display = 'none';
            freeOption.style.display = 'none';
            cashOption.style.display = 'block';
            transferOption.style.display = 'block';
            document.getElementById('edit-order-bank').disabled = false;

            if (o.paymentMethod === 'free') {
                freeOption.style.display = 'block';
                cashOption.style.display = 'none';
                transferOption.style.display = 'none';
                statusSelect.value = 'paid-free';
                document.getElementById('edit-order-bank').disabled = true;
            } else if (o.status === 'paid') {
                paidOption.style.display = 'block';
                statusSelect.value = 'paid';
            } else {
                statusSelect.value = o.paymentMethod === 'cash' ? 'pending-cash' : 'pending-transfer';
            }
            
            document.getElementById('edit-step-1').style.display = 'flex';
            document.getElementById('edit-step-2').style.display = 'none';
            document.getElementById('modal-edit-order').style.display = 'flex';
        };

        window.saveOrderEdit = () => {
            const statusVal = document.getElementById('edit-order-status').value;
            if (originalOrderState && (originalOrderState.status === 'paid' || originalOrderState.paymentMethod === 'free') && (statusVal !== 'paid' && statusVal !== 'paid-free')) {
                document.getElementById('edit-step-1').style.display = 'none';
                document.getElementById('edit-step-2').style.display = 'flex';
                return;
            }
            // 如果只有一頁編輯就直接存檔（但為了防呆加了動畫狀態，原本沒有特別指定 btn id，這裡簡單處理）
            window.executeOrderEdit(false); 
        };

        window.executeOrderEdit = (fromWarningPage = true) => {
            const orderId = document.getElementById('edit-order-id').value;
            const newBank = document.getElementById('edit-order-bank').value.trim();
            const newNote = document.getElementById('edit-order-note').value.trim();
            const statusVal = document.getElementById('edit-order-status').value;
            
            const o = ordersData[orderId];
            if(!o) return;

            // 如果是從第二頁(防呆警告)按下來的，才會有這個按鈕 ID
            let originalBtnHtml = '';
            if(fromWarningPage) {
                originalBtnHtml = setLoadingState('btn-execute-edit', true);
            }

            let finalStatus = (statusVal === 'paid' || statusVal === 'paid-free') ? 'paid' : 'pending';
            let finalMethod = o.paymentMethod;
            if (statusVal === 'pending-cash') finalMethod = 'cash';
            if (statusVal === 'pending-transfer') finalMethod = 'transfer';
            if (statusVal === 'paid-free') finalMethod = 'free';

            const updates = {};
            updates[`orders/${orderId}/bankCode`] = newBank;
            updates[`orders/${orderId}/note`] = newNote;
            updates[`orders/${orderId}/paymentMethod`] = finalMethod;
            updates[`orders/${orderId}/status`] = finalStatus;

            if (finalStatus === 'pending') {
                updates[`orders/${orderId}/receiptDate`] = null;
            }

            let currentReportDate = o.reportDate || null;
            if (finalMethod !== 'free' && newBank !== "" && (!o.bankCode || o.bankCode === "")) {
                const today = new Date();
                currentReportDate = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;
                updates[`orders/${orderId}/reportDate`] = currentReportDate;
            } else if (newBank === "") {
                currentReportDate = null;
                updates[`orders/${orderId}/reportDate`] = null;
            }

            if(o.seats) o.seats.forEach(s => {
                updates[`seats/${s}/bankCode`] = newBank;
                updates[`seats/${s}/note`] = newNote;
                updates[`seats/${s}/paymentMethod`] = finalMethod;
                updates[`seats/${s}/receiptDate`] = (finalStatus === 'pending') ? null : (o.receiptDate || null);
                updates[`seats/${s}/reportDate`] = currentReportDate;
            });

            update(ref(db), updates).then(() => { 
                window.closeModal('modal-edit-order'); 
                window.showToast("已儲存變更", "success"); 
            }).catch((err) => {
                console.error(err);
                window.showToast("儲存失敗，請重試");
            }).finally(() => {
                if(fromWarningPage) setLoadingState('btn-execute-edit', false, originalBtnHtml);
            });
        };

        window.openDeleteModal = (orderId) => {
            const o = ordersData[orderId];
            if(!o) return;
            document.getElementById('delete-target-id').value = orderId;
            document.getElementById('del-order-name').innerText = o.name;
            document.getElementById('modal-delete-order').style.display = 'flex';
        };

        window.executeDeleteOrder = () => {
            const orderId = document.getElementById('delete-target-id').value;
            const o = ordersData[orderId];
            if(!o) return;
            
            const originalBtnHtml = setLoadingState('btn-execute-delete', true);

            const updates = {};
            // 將訂單內的所有座位還原為空位
            if(o.seats) {
                o.seats.forEach(s => {
                    updates[`seats/${s}`] = null;
                });
            }
            // 刪除整筆訂單資料
            updates[`orders/${orderId}`] = null;
            
            update(ref(db), updates).then(() => {
                window.closeModal('modal-delete-order');
                window.showToast("訂單已刪除，座位已釋放！", "success");
            }).catch(err => {
                console.error(err);
                window.showToast("刪除失敗，請重試", "error");
            }).finally(() => {
                setLoadingState('btn-execute-delete', false, originalBtnHtml);
            });
        };

        window.exportToExcel = async () => {
            if(!isAdmin) return;
            window.showToast("正在產生 Excel 檔案，請稍候...", "success");

            const workbook = new ExcelJS.Workbook();
            workbook.creator = 'MIA Ticketing System';

            // ==========================================
            // 工作表 1：現場座位圖
            // ==========================================
            const wsMap = workbook.addWorksheet('現場座位圖', {views: [{showGridLines: false}]});
            
            for (let i = 1; i <= 41; i++) wsMap.getColumn(i).width = 8;

            wsMap.mergeCells('A1:AO1');
            wsMap.getCell('A1').value = '2026 8th MIA SPRING SHOW - 現場座位表';
            wsMap.getCell('A1').font = { size: 20, bold: true };
            wsMap.getCell('A1').alignment = { vertical: 'middle', horizontal: 'center' };
            wsMap.getRow(1).height = 40;

            wsMap.mergeCells('A2:AO2');
            wsMap.getCell('A2').value = '舞 台';
            wsMap.getCell('A2').fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF0F172A' } };
            wsMap.getCell('A2').font = { size: 16, bold: true, color: { argb: 'FFFFFFFF' } };
            wsMap.getCell('A2').alignment = { vertical: 'middle', horizontal: 'center' };
            wsMap.getRow(2).height = 30;

            wsMap.getRow(3).height = 20;

            const L_MAX = 11, M_MAX = 15, R_MAX = 11, GAP = 2;
            let currentRow = 4;

            layout.forEach(sec => {
                for(let r = 0; r < sec.rows; r++) {
                    const rowName = String.fromCharCode(sec.start.charCodeAt(0) + r);
                    const cL = Array.isArray(sec.L) ? sec.L[r] : sec.L;
                    const cM = Array.isArray(sec.M) ? sec.M[r] : sec.M;
                    const cR = Array.isArray(sec.R) ? sec.R[r] : sec.R;

                    let currentCol = 1;

                    const renderCell = (s, block) => {
                        const id = rowName + s;
                        const cell = wsMap.getCell(currentRow, currentCol);
                        const isBlocked = ((rowName === 'A' || rowName === 'B') && (block === 'L' || block === 'R'));
                        
                        cell.alignment = { wrapText: true, vertical: 'middle', horizontal: 'center' };
                        cell.border = { 
                            top: {style:'thin', color:{argb:'FFCBD5E1'}}, 
                            left: {style:'thin', color:{argb:'FFCBD5E1'}}, 
                            bottom: {style:'thin', color:{argb:'FFCBD5E1'}}, 
                            right: {style:'thin', color:{argb:'FFCBD5E1'}} 
                        };

                        if (isBlocked) {
                            cell.value = "X";
                            cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFE2E8F0' } };
                            cell.font = { color: { argb: 'FF94A3B8' }, bold: true };
                        } else if (cameraSeats.includes(id)) {
                            cell.value = `${id}\n攝影席`;
                            cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF1E3A8A' } };
                            cell.font = { color: { argb: 'FFFFFFFF' }, bold: true, size: 9 };
                        } else {
                            const seatInfo = seatsData[id] || {};
                            const isSold = seatInfo.status === 'sold';
                            const isReserve = reserveSeats.includes(id);

                            if (isSold) {
                                cell.value = `${id}\n${seatInfo.name || ''}`;
                                cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFEE2E2' } };
                                cell.font = { color: { argb: 'FFB91C1C' }, bold: true, size: 9 };
                            } else if (isReserve) {
                                cell.value = `${id}\n保留席`;
                                cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFEF3C7' } };
                                cell.font = { color: { argb: 'FFD97706' }, bold: true, size: 9 };
                            } else {
                                cell.value = id; 
                                cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFFFFFF' } };
                                cell.font = { color: { argb: 'FF1E293B' }, bold: true };
                            }
                        }
                    };

                    currentCol += (L_MAX - cL); 
                    for(let s = 1; s <= cL; s++) { renderCell(s, 'L'); currentCol++; }
                    currentCol += GAP;
                    const padMidLeft = Math.floor((M_MAX - cM) / 2);
                    currentCol += padMidLeft;
                    for(let s = cL + 1; s <= cL + cM; s++) { renderCell(s, 'M'); currentCol++; }
                    currentCol += (M_MAX - cM - padMidLeft);
                    currentCol += GAP;
                    for(let s = cL + cM + 1; s <= cL + cM + cR; s++) { renderCell(s, 'R'); currentCol++; }

                    wsMap.getRow(currentRow).height = 40;
                    currentRow++;
                }
                currentRow++; 
            });

            // ==========================================
            // 工作表 2：訂單名冊
            // ==========================================
            const wsOrders = workbook.addWorksheet('訂單名冊');
            wsOrders.columns = [
                { header: '訂單編號', key: 'orderId', width: 22 },
                { header: '訂單時間', key: 'time', width: 20 },
                { header: '購票姓名', key: 'name', width: 15 },
                { header: '電話', key: 'phone', width: 15 },
                { header: '座位', key: 'seats', width: 35 },
                { header: '金額', key: 'total', width: 12 },
                { header: '付款方式', key: 'method', width: 12 },
                { header: '末五碼', key: 'bankCode', width: 12 },
                { header: '收款日期', key: 'receiptDate', width: 15 },
                { header: '狀態', key: 'status', width: 15 },
                { header: '備註', key: 'note', width: 25 }
            ];

            wsOrders.getRow(1).font = { bold: true, color: { argb: 'FF475569' } };
            wsOrders.getRow(1).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFF8FAFC' } };
            wsOrders.getRow(1).border = { bottom: { style: 'medium', color: { argb: 'FFCBD5E1' } } };

            const allOrders = Object.values(ordersData).sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            allOrders.forEach(o => {
                const t = new Date(o.createdAt).toLocaleString('zh-TW', { hour12: false });
                const st = (o.status === 'paid') ? '已完成' : (o.paymentMethod === 'cash' ? '待付款' : '待入帳');
                wsOrders.addRow({
                    orderId: o.orderId,
                    time: t,
                    name: o.name,
                    phone: o.phone,
                    seats: (o.seats || []).join(', '),
                    total: o.total,
                    method: o.paymentMethod === 'cash' ? '現金' : (o.paymentMethod === 'transfer' ? '匯款' : '免付費'),
                    bankCode: o.bankCode || '',
                    receiptDate: o.receiptDate || o.reportDate || '',
                    status: st,
                    note: o.note || ''
                });
            });

            try {
                const buffer = await workbook.xlsx.writeBuffer();
                const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = `MIA_票務總表_${new Date().toLocaleDateString('zh-TW', {year:'numeric', month:'2-digit', day:'2-digit'}).replace(/\//g, '')}.xlsx`;
                link.click();
                window.showToast("Excel 匯出成功！", "success");
            } catch (err) {
                console.error(err);
                window.showToast("匯出失敗，請重試", "error");
            }
        };

        window.exportDailyReceipts = async () => {
            if(!isAdmin) return;
            const targetDate = document.getElementById('receipt-date-input').value;
            
            if(!targetDate) {
                window.showToast("請先在上方選擇「收款日期」", "error");
                return;
            }

            window.showToast("正在產生當日收款名冊...", "success");
            
            const workbook = new ExcelJS.Workbook();
            workbook.creator = 'MIA Ticketing System';
            const ws = workbook.addWorksheet('當日收款名冊');

            ws.columns = [
                { header: '訂單編號', key: 'orderId', width: 22 },
                { header: '訂單時間', key: 'time', width: 20 },
                { header: '購票姓名', key: 'name', width: 15 },
                { header: '電話', key: 'phone', width: 15 },
                { header: '座位', key: 'seats', width: 35 },
                { header: '金額', key: 'total', width: 12 },
                { header: '付款方式', key: 'method', width: 12 },
                { header: '末五碼', key: 'bankCode', width: 12 },
                { header: '收款日期', key: 'receiptDate', width: 15 },
                { header: '狀態', key: 'status', width: 15 },
                { header: '備註', key: 'note', width: 25 }
            ];

            ws.getRow(1).font = { bold: true, color: { argb: 'FF475569' } };
            ws.getRow(1).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFF8FAFC' } };
            ws.getRow(1).border = { bottom: { style: 'medium', color: { argb: 'FFCBD5E1' } } };

            const allOrders = Object.values(ordersData).sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            let dailyTotal = 0;
            let count = 0;

            allOrders.forEach(o => {
                let match = false;
                if (o.status === 'paid' && o.receiptDate === targetDate) {
                    match = true;
                } else if (o.paymentMethod === 'transfer' && o.reportDate === targetDate) {
                    match = true;
                }

                if(match) {
                    const t = new Date(o.createdAt).toLocaleString('zh-TW', { hour12: false });
                    const st = (o.status === 'paid') ? '已完成' : (o.paymentMethod === 'cash' ? '待付款' : '待入帳');
                    
                    ws.addRow({
                        orderId: o.orderId,
                        time: t,
                        name: o.name,
                        phone: o.phone,
                        seats: (o.seats || []).join(', '),
                        total: o.total,
                        method: o.paymentMethod === 'cash' ? '現金' : (o.paymentMethod === 'transfer' ? '匯款' : '免付費'),
                        bankCode: o.bankCode || '',
                        receiptDate: o.receiptDate || o.reportDate || '',
                        status: st,
                        note: o.note || ''
                    });
                    dailyTotal += (o.total || 0);
                    count++;
                }
            });

            ws.addRow({});
            const summaryRow = ws.addRow({
                seats: `共計 ${count} 筆`,
                total: `總計: $${dailyTotal.toLocaleString()}`
            });
            summaryRow.font = { bold: true, color: { argb: 'FF1E293B' } };

            try {
                const buffer = await workbook.xlsx.writeBuffer();
                const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = `MIA_當日收款名冊_${targetDate.replace(/-/g, '')}.xlsx`;
                link.click();
                window.showToast("Excel 匯出成功！", "success");
            } catch (err) {
                console.error(err);
                window.showToast("匯出失敗，請重試", "error");
            }
        };
    </script>
</body>
</html>
