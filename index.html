<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <meta property="og:title" content="2026 8th MIA SPRING SHOW">
    <meta property="og:description" content="MIA æ˜¥å­£å±•æ¼” | ç¥¨å‹™å³æ™‚ç®¡ç†ç³»çµ±">
    <meta property="og:image" content="https://2026miaspringshow.github.io/mia-seats/logo.png">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:type" content="website">
    <meta name="description" content="2026 MIA SPRING SHOW å³æ™‚åº§ä½ç¥¨å‹™ç³»çµ±">

    <title>2026 MIA SPRING SHOW | ç¥¨å‹™ç®¡ç†ç³»çµ±</title>
    <!-- å¼•å…¥ ExcelJS å¼•æ“ï¼Œç”¢ç”ŸçœŸæ­£çš„ xlsx æª”æ¡ˆ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <style>
        :root { 
            --primary-blue: #6366f1; 
            --accent-blue: #6366f1; 
            --bg-gray: #f8f9fa; 
            --mia-gradient: linear-gradient(135deg, #1e3a8a 0%, #172554 100%);
            --success-gradient: linear-gradient(135deg, #10b981 0%, #059669 100%);
            --confirm-dark: #0d1b2a;
            --confirm-hover: #1b2a3a;

            --seat-bg-avail: #ffffff;
            --seat-text-avail: #64748b;
            --seat-border-avail: #f1f5f9;
            --seat-shadow-avail: #cbd5e1;
            
            --seat-bg-selected: #6366f1;
            --seat-text-selected: #ffffff;
            --seat-shadow-selected: #3730a3;
            
            --seat-bg-sold: #fee2e2;
            --seat-text-sold: #b91c1c;
            --seat-shadow-sold: #fca5a5;
            
            --seat-bg-reserve: #fef3c7;
            --seat-text-reserve: #f59e0b;
            --seat-shadow-reserve: #fcd34d;
            
            --seat-bg-camera: #1e3a8a;
            --seat-text-camera: #ffffff;
            --seat-shadow-camera: #1e40af;

            --seat-bg-blocked: #e2e8f0;
            --seat-text-blocked: #94a3b8;
            --seat-shadow-blocked: #cbd5e1;
        }
        body { font-family: "PingFang TC", "Microsoft JhengHei", sans-serif; background-color: var(--bg-gray); margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        .header { background: var(--mia-gradient); color: white; padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.2); z-index: 1000; }
        .header-title-wrapper { display: flex; align-items: center; gap: 12px; }
        .header-logo { height: 48px; width: auto; object-fit: contain; } 
        .header-title h1 { margin: 0; font-size: 18px; font-weight: 800; letter-spacing: 1.5px; line-height: 1.2; }
        .header-title span { font-size: 13px; font-weight: 400; opacity: 0.95; }
        
        .header-actions { display: flex; align-items: center; gap: 12px; }
        .menu-btn { background: none; border: none; color: white; cursor: pointer; transition: 0.2s; padding: 0 5px; display: flex; align-items: center; justify-content: center; }
        .menu-btn:hover { opacity: 0.7; transform: scale(1.1); }
        .menu-btn svg { width: 24px; height: 24px; }

        .main-content { flex: 1; overflow-y: auto; padding-bottom: 10px; display: flex; flex-direction: column; align-items: center; width: 100%; position: relative; }
        
        .legend-area { display: flex; gap: 15px; margin: 15px 0; font-size: 14px; color: #666; justify-content: center; flex-wrap: wrap; align-items: center; }
        .legend-item { display: flex; align-items: center; gap: 6px; }
        .legend-box { width: 16px; height: 16px; border-radius: 4px 4px 2px 2px; }
        
        .venue-wrapper { width: 100%; overflow-x: auto; padding: 10px 0; }
        .stage-area { width: fit-content; margin: 0 auto; display: flex; flex-direction: column; align-items: center; padding: 0 50px; }
        
        .screen { background: #0f172a; width: 888px; margin-bottom: 8px; padding: 12px 20px; color: #fff; border-radius: 0 0 80px 80px; text-align: center; font-size: 20px; font-weight: 900; letter-spacing: 15px; box-shadow: 0 10px 20px rgba(0,0,0,0.15); }
        
        .view-notice { font-size: 14px; color: #999; margin-bottom: 30px; font-weight: normal; }
        
        .venue-container { 
            display: grid; 
            grid-template-columns: auto auto auto; 
            column-gap: 60px; 
            row-gap: 25px; 
            width: fit-content; 
        }
        .block { display: flex; flex-direction: column; gap: 6px; }
        #LT, #LM, #LB { align-items: flex-end; }
        #RT, #RM, #RB { align-items: flex-start; }
        #MT, #MM, #MB { align-items: center; }
        
        .row { display: flex; gap: 4px; height: 38px; align-items: center; }
        
        .seat { 
            width: 28px !important; 
            height: 28px !important; 
            box-sizing: border-box !important;
            flex-shrink: 0; 
            font-size: 9px; 
            font-weight: bold;
            border-radius: 12px 12px 6px 6px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            transition: all 0.15s ease; 
            user-select: none;
            background-color: var(--seat-bg-avail); 
            color: var(--seat-text-avail);
            border: 1px solid var(--seat-border-avail); 
            box-shadow: 0 3px 0 0 var(--seat-shadow-avail);
            cursor: pointer;
        }
        
        .seat:hover:not(.camera-seat):not(.sold):not(.blocked-seat):not(.disabled-seat) { transform: translateY(-2px); box-shadow: 0 5px 0 0 var(--seat-shadow-avail); z-index: 5; }
        .seat:active:not(.camera-seat):not(.sold):not(.blocked-seat):not(.disabled-seat) { transform: translateY(2px); box-shadow: 0 1px 0 0 var(--seat-shadow-avail); }

        .sold { background-color: var(--seat-bg-sold) !important; color: var(--seat-text-sold) !important; box-shadow: 0 3px 0 0 var(--seat-shadow-sold) !important; border: none !important; cursor: not-allowed; transform: none !important; }
        .selected { background-color: var(--seat-bg-selected) !important; color: var(--seat-text-selected) !important; box-shadow: 0 3px 0 0 var(--seat-shadow-selected) !important; border: none !important; transform: translateY(1px) !important; }
        .reserve-seat { background-color: var(--seat-bg-reserve) !important; color: var(--seat-text-reserve) !important; box-shadow: 0 3px 0 0 var(--seat-shadow-reserve) !important; border: none !important; }
        .reserve-seat.selected { background-color: var(--seat-bg-selected) !important; color: var(--seat-text-selected) !important; box-shadow: 0 3px 0 0 var(--seat-shadow-selected) !important; border: none !important; transform: translateY(1px) !important; }
        .sold.reserve-seat { background-color: #f59e0b !important; color: #fffbeb !important; box-shadow: 0 3px 0 0 #d97706 !important; border: none !important; }
        .camera-seat { background-color: var(--seat-bg-camera) !important; color: var(--seat-text-camera) !important; box-shadow: 0 3px 0 0 var(--seat-shadow-camera) !important; border: none !important; cursor: default; }
        
        .blocked-seat { 
            background-color: var(--seat-bg-blocked) !important; 
            color: var(--seat-text-blocked) !important; 
            box-shadow: 0 3px 0 0 var(--seat-shadow-blocked) !important; 
            border: 1px solid #cbd5e1 !important; 
            cursor: default !important; 
            pointer-events: none; 
        }

        /* æ›ä½æ¨¡å¼å°ˆç”¨ CSS */
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(239,68,68,0.7); } 70% { box-shadow: 0 0 0 10px rgba(239,68,68,0); } 100% { box-shadow: 0 0 0 0 rgba(239,68,68,0); } }
        .seat.swap-selected-old,
        .seat.sold.swap-selected-old,
        .seat.reserve-seat.swap-selected-old,
        .seat.sold.reserve-seat.swap-selected-old { background-color: #ef4444 !important; color: white !important; animation: pulse-red 1.5s infinite; border: none !important; z-index: 10; transform: translateY(-2px) !important; box-shadow: 0 5px 0 0 #b91c1c !important; }
        .swap-selectable-old { cursor: pointer !important; }
        .disabled-seat { opacity: 0.25 !important; cursor: not-allowed !important; pointer-events: none !important; filter: grayscale(100%); }

        /* æ›ä½æ¨¡å¼å°ˆå±¬è³ªæ„Ÿæ©«å¹… */
        .swap-banner {
            display: none; position: sticky; top: 0; left: 0; width: 100%; background: #1e293b; padding: 12px 20px; z-index: 2000; box-shadow: 0 4px 15px rgba(0,0,0,0.3); 
            justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; box-sizing: border-box; color: #f8fafc;
        }
        .swap-banner-text { font-size: 15px; line-height: 1.5; font-weight: 500; }
        .swap-banner-text b { color: #38bdf8; font-weight: 800; font-size: 16px; }
        .swap-banner-text .highlight-red { color: #f87171; font-weight: bold; }
        .swap-banner-text .highlight-green { color: #34d399; font-weight: bold; }

        .floating-bar {
            position: fixed; bottom: -120px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 450px;
            background: #0f172a; border-radius: 20px; padding: 12px 16px; display: flex; align-items: center;
            justify-content: space-between; box-shadow: 0 10px 30px rgba(0,0,0,0.4); z-index: 500;
            transition: bottom 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.15);
        }
        .floating-bar.show { bottom: 30px; }
        .floating-bar-left { display: flex; align-items: center; gap: 15px; }
        .floating-cart-icon { width: 46px; height: 46px; background: var(--primary-blue); border-radius: 14px; display: flex; align-items: center; justify-content: center; color: white; }
        .floating-info { display: flex; flex-direction: column; justify-content: center; }
        .floating-info-top { font-size: 16px; font-weight: bold; color: white; }
        .btn-floating-confirm { background: white; color: #0f172a; padding: 14px 24px; border-radius: 14px; border: none; font-size: 15px; font-weight: bold; cursor: pointer; transition: all 0.2s; }
        .btn-floating-confirm:hover { background: #f1f5f9; transform: scale(1.03); }
        .btn-floating-confirm:active { transform: scale(0.97); }

        .custom-toast {
            position: fixed; top: -100px; left: 50%; transform: translateX(-50%); background-color: #ef4444; color: white;
            padding: 12px 28px; border-radius: 9999px; display: flex; align-items: center; gap: 10px; font-size: 16px;
            font-weight: bold; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2); z-index: 5000;
            transition: top 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.2), opacity 0.3s; opacity: 0; pointer-events: none;
        }
        .custom-toast.show { top: 40px; opacity: 1; pointer-events: auto; }
        .custom-toast.success { background-color: #10b981; }
        .custom-toast svg { width: 22px; height: 22px; }

        /* èƒŒæ™¯æ¨¡ç³Šæ•ˆæœ */
        .modal-overlay { position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.6); backdrop-filter: blur(6px); -webkit-backdrop-filter: blur(6px); display: none; justify-content: center; align-items: center; z-index: 3000; padding: 20px; }
        .modal { background: white; width: 100%; max-width: 480px; max-height: 95vh; border-radius: 20px; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 25px 60px rgba(0,0,0,0.4); }
        
        .modal-header { 
            background-color: #1e3a8a; 
            background-image: 
                url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 24 24' fill='none' stroke='rgba(255,255,255,0.1)' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M2 9a3 3 0 0 1 0 6v2a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-2a3 3 0 0 1 0-6V7a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2Z'/%3E%3Cpath d='M13 5v2'/%3E%3Cpath d='M13 17v2'/%3E%3Cpath d='M13 11v2'/%3E%3C/svg%3E"),
                var(--mia-gradient); 
            background-repeat: no-repeat;
            background-position: right -15px center, center;
            background-size: 110px, cover; 
            color: white; 
            padding: 32px 20px; 
            text-align: center; 
            font-size: 20px; 
            font-weight: bold; 
            position: relative; 
            flex-shrink: 0; 
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-header.login-header { 
            background-image: 
                url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 24 24' fill='none' stroke='rgba(255,255,255,0.1)' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Crect x='3' y='11' width='18' height='11' rx='2' ry='2'/%3E%3Cpath d='M7 11V7a5 5 0 0 1 10 0v4'/%3E%3C/svg%3E"),
                var(--mia-gradient); 
            background-position: right -15px center, center;
            background-size: 110px, cover;
        }

        .modal-header.success-header { 
            background-image: 
                url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 24 24' fill='none' stroke='rgba(255,255,255,0.1)' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M2 9a3 3 0 0 1 0 6v2a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-2a3 3 0 0 1 0-6V7a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2Z'/%3E%3Cpath d='M13 5v2'/%3E%3Cpath d='M13 17v2'/%3E%3Cpath d='M13 11v2'/%3E%3C/svg%3E"),
                var(--success-gradient); 
            background-size: 110px, cover;
        }

        .modal-header.danger-header { 
            background-image: 
                url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 24 24' fill='none' stroke='rgba(255,255,255,0.1)' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='12' cy='12' r='10'/%3E%3Cline x1='12' y1='8' x2='12' y2='12'/%3E%3Cline x1='12' y1='16' x2='12.01' y2='16'/%3E%3C/svg%3E"),
                linear-gradient(135deg, #ef4444 0%, #b91c1c 100%); 
            background-size: 110px, cover;
            background-position: right -15px center, center;
        }

        .modal-header.delete-header { 
            background-image: 
                url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 24 24' fill='none' stroke='rgba(255,255,255,0.1)' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='3 6 5 6 21 6'/%3E%3Cpath d='M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2'/%3E%3Cline x1='10' y1='11' x2='10' y2='17'/%3E%3Cline x1='14' y1='11' x2='14' y2='17'/%3E%3C/svg%3E"),
                linear-gradient(135deg, #ef4444 0%, #b91c1c 100%); 
            background-size: 110px, cover;
            background-position: right -15px center, center;
        }

        .modal-header.verify-header { 
            background-image: 
                url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 24 24' fill='none' stroke='rgba(255,255,255,0.1)' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M22 11.08V12a10 10 0 1 1-5.93-9.14'/%3E%3Cpolyline points='22 4 12 14.01 9 11.01'/%3E%3C/svg%3E"),
                var(--success-gradient); 
            background-size: 110px, cover;
            background-position: right -15px center, center;
        }

        .close-x { 
            position: absolute; 
            right: 15px; 
            top: 50%; 
            transform: translateY(-50%); 
            width: 32px; 
            height: 32px; 
            background: rgba(255, 255, 255, 0.15); 
            color: white; 
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            cursor: pointer; 
            z-index: 10; 
            transition: background 0.2s; 
        }
        .close-x:hover { 
            background: rgba(255, 255, 255, 0.3); 
            color: white; 
        }
        
        .modal-body { padding: 30px; overflow-y: auto; flex: 1; }
        .modal-body input, .modal-body select { width: 100% !important; box-sizing: border-box !important; display: block !important; }

        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; font-size: 14px; font-weight: bold; margin-bottom: 8px; color: #666; }
        .required-star { color: #ef4444; margin-left: 4px; font-weight: 900; }

        .total-summary-row { 
            margin-top: 20px; 
            padding-top: 15px; 
            border-top: 1.5px dashed #e2e8f0; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        .total-label { font-size: 16px; font-weight: bold; color: #666; }
        .total-amount { font-size: 32px; font-weight: 900; color: var(--primary-blue); font-family: inherit; }

        .btn-confirm-final { background: var(--confirm-dark); color: white; width: 100%; padding: 16px; border-radius: 12px; border: none; font-size: 16px; font-weight: bold; cursor: pointer; transition: all 0.2s; }
        .btn-confirm-final:hover { background: var(--confirm-hover); }

        .pay-method-btn { flex: 1; padding: 14px; border-radius: 12px; border: 2px solid #e2e8f0; background: white; color: #64748b; font-weight: bold; cursor: pointer; transition: all 0.2s; text-align: center; font-size: 15px; }
        .pay-method-btn.active-cash { border-color: #10b981; background: #ecfdf5; color: #059669; }
        .pay-method-btn.active-transfer { border-color: #f59e0b; background: #fffbeb; color: #d97706; }
        
        .btn-prev-step { background: white; color: #64748b; border: 1px solid #cbd5e1; padding: 14px; border-radius: 12px; font-weight: bold; cursor: pointer; transition: all 0.2s; flex: 1; font-size: 15px; }
        .btn-prev-step:hover { background: #f8fafc; }
        .btn-complete { background: #10b981; color: white; border: none; padding: 14px; border-radius: 12px; font-weight: bold; cursor: pointer; transition: all 0.2s; flex: 2; font-size: 15px; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-complete:hover:not(:disabled) { background: #059669; transform: scale(1.02); }
        .btn-complete:active:not(:disabled) { transform: scale(0.98); }
        .btn-complete:disabled { background: #94a3b8; cursor: not-allowed; opacity: 0.8; transform: none; }

        /* Loading Spinner Animation */
        @keyframes spin { 100% { transform: rotate(360deg); } }
        .spinner { animation: spin 1s linear infinite; width: 20px; height: 20px; }

        .order-page { flex: 1; overflow-y: auto; padding: 30px 20px; width: 100%; display: none; flex-direction: column; align-items: center; background-color: var(--bg-gray); }
        .order-page-inner { width: 100%; max-width: 1000px; }
        .order-page-header { display: flex; align-items: center; gap: 20px; margin-bottom: 24px; flex-wrap: wrap; }
        .order-page-title { font-size: 24px; font-weight: 800; color: #1e293b; margin: 0; flex: 1; }
        .header-actions-group { display: flex; gap: 10px; flex-wrap: wrap; }
        .btn-action-outline { background: white; border: 2px solid #e2e8f0; padding: 10px 16px; border-radius: 12px; font-weight: bold; color: #64748b; cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 8px; font-size: 14px; }
        .btn-action-outline:hover { background: #f8fafc; border-color: #cbd5e1; transform: translateY(-1px); }
        
        .filter-panel {
            margin-bottom: 10px;
            width: 100%;
            box-sizing: border-box;
        }
        .filter-row-top {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }
        .filter-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .filter-label {
            font-size: 14px;
            font-weight: bold;
            color: #475569;
            white-space: nowrap;
        }
        .filter-control {
            padding: 0 14px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 14px;
            color: #1e293b;
            outline: none;
            transition: 0.2s;
            font-family: inherit;
            background: white;
            cursor: pointer;
            height: 42px;
            box-sizing: border-box;
        }
        .filter-control:focus { border-color: var(--primary-blue); }
        
        .btn-clear-filters {
            background: var(--primary-blue);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 0 15px;
            height: 42px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: 0.2s;
            font-size: 14px;
            font-weight: bold;
            box-shadow: 0 4px 6px -1px rgba(99, 102, 241, 0.3);
        }
        .btn-clear-filters:hover { 
            background: #4f46e5; 
            transform: translateY(-1px);
            box-shadow: 0 6px 12px -2px rgba(99, 102, 241, 0.4);
        }
        .btn-clear-filters:active {
            transform: translateY(0);
        }

        .search-group { position: relative; flex: 1; min-width: 200px; display: flex; align-items: center; }
        .search-input { padding: 0 16px; border: 2px solid #e2e8f0; border-radius: 10px; width: 100%; box-sizing: border-box; font-size: 14px; transition: all 0.2s; height: 42px; outline: none; line-height: normal; }
        .search-input:focus { border-color: var(--primary-blue); box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1); }

        .results-summary {
            font-size: 13px;
            color: #94a3b8;
            font-weight: 500;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .results-count {
            color: var(--primary-blue);
            font-weight: 800;
        }

        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 25px; }
        .stat-card { background: white; padding: 20px; border-radius: 16px; border: 1px solid #e2e8f0; display: flex; flex-direction: column; position: relative; overflow: hidden; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); }
        .stat-label { font-size: 12px; font-weight: bold; color: #94a3b8; margin-bottom: 10px; }
        .stat-value { font-size: 24px; font-weight: 900; color: #1e293b; }
        .stat-value span { font-size: 14px; font-weight: 500; color: #64748b; margin-left: 4px; }
        .stat-value.pending { color: #ef4444; } 
        .stat-icon-wrapper { position: absolute; right: 15px; top: 15px; width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; }
        .icon-revenue { background: #eef2ff; color: #6366f1; }
        .icon-tickets { background: #eff6ff; color: #3b82f6; }
        .icon-orders { background: #f0fdf4; color: #22c55e; }
        .icon-pending { background: #fff7ed; color: #f97316; }

        .order-table-container { width: 100%; overflow-x: auto; border-radius: 16px; border: 1px solid #e2e8f0; background: white; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05); }
        .order-table { width: 100%; border-collapse: collapse; text-align: left; min-width: 700px; font-size: 14px; }
        .order-table th { background: #f8fafc; padding: 16px 20px; font-weight: bold; color: #475569; border-bottom: 2px solid #e2e8f0; white-space: nowrap; }
        .order-table td { padding: 16px 20px; border-bottom: 1px solid #e2e8f0; color: #1e293b; vertical-align: middle; }
        .order-table tr:hover { background: #f1f5f9; }
        
        /* åˆ†é æ§åˆ¶å™¨æ¨£å¼ */
        .pagination { display: flex; justify-content: space-between; align-items: center; margin-top: 20px; font-size: 14px; color: #475569; padding: 0 5px; flex-wrap: wrap; gap: 15px; }
        .page-info { display: flex; align-items: center; gap: 10px; }
        .page-btn { padding: 8px 16px; border: 1px solid #cbd5e1; background: white; border-radius: 8px; cursor: pointer; transition: 0.2s; color: #1e293b; font-weight: bold; }
        .page-btn:hover:not(:disabled) { background: #f1f5f9; border-color: var(--primary-blue); color: var(--primary-blue); }
        .page-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .items-per-page-select { padding: 6px 10px; border-radius: 6px; border: 1px solid #cbd5e1; outline: none; font-family: inherit; cursor: pointer; font-weight: bold;}

        .status-badge { display: inline-flex; align-items: center; padding: 4px 10px; border-radius: 9999px; font-size: 12px; font-weight: bold; white-space: nowrap; border: 1px solid transparent; }
        .status-paid { background: #dcfce7; color: #059669; border-color: #a7f3d0; }
        .status-unpaid-red { background: #fee2e2; color: #b91c1c; border-color: #fecaca; }
        .status-pending-orange { background: #fef3c7; color: #d97706; border-color: #fde68a; }
        /* é€€æ¬¾ç›¸é—œ Badge */
        .status-pending-refund { background: #ffedd5; color: #c2410c; border-color: #fed7aa; }
        .status-refunded { background: #f1f5f9; color: #475569; border-color: #cbd5e1; }
        
        .action-icon-btn { background: none; border: none; cursor: pointer; padding: 8px; border-radius: 8px; transition: 0.2s; display: inline-flex; align-items: center; justify-content: center;}
        .action-icon-btn.edit:hover { background: #e0e7ff; color: #4338ca; }
        .action-icon-btn.delete { color: #94a3b8; }
        .action-icon-btn.delete:hover { background: #fee2e2; color: #b91c1c; }
        .action-icon-btn.verify { color: #10b981; }
        .action-icon-btn.verify:hover { background: #d1fae5; color: #065f46; }
        .action-icon-btn.refund { color: #8b5cf6; }
        .action-icon-btn.refund:hover { background: #ffedd5; color: #c2410c; }
        .action-icon-btn svg { width: 18px; height: 18px; }

        .success-checkmark {
            width: 80px; height: 80px; 
            margin: 0 auto 15px; 
            background: #d1fae5; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            color: #10b981;
        }
        .success-checkmark svg { width: 45px; height: 45px; }

        .warning-exclamation {
            width: 80px; height: 80px; 
            margin: 0 auto 20px; 
            background: #fee2e2; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            color: #ef4444;
        }
        .warning-exclamation svg { width: 40px; height: 40px; }

        .copy-info-box {
            background: #f1f5f9;
            padding: 18px;
            border-radius: 12px;
            margin-top: 20px;
            border: 1px solid #e2e8f0;
            text-align: left;
            position: relative;
        }
        .copy-info-text {
            font-size: 11px; 
            line-height: 1.65;
            color: #475569;
            white-space: pre-wrap;
            margin-bottom: 12px;
            user-select: all;
        }
        .btn-copy-action {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: 1.5px solid #cbd5e1;
            background: white;
            color: #64748b;
            font-weight: bold;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center; gap: 6px;
        }
        .btn-copy-action:hover {
            background: #f8fafc;
            border-color: var(--primary-blue);
            color: var(--primary-blue);
        }

        @media screen and (max-width: 768px) {
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .order-page-header { flex-direction: column; align-items: stretch; gap: 15px; }
            .header-actions-group { flex-direction: column; width: 100%; gap: 10px; }
            .btn-action-outline { width: 100%; justify-content: center; }
            .filter-row-top { flex-direction: column; align-items: stretch; gap: 12px; }
            .filter-group { width: 100%; }
            .filter-control { flex: 1; width: 100%; box-sizing: border-box; }
            .btn-clear-filters { width: 100%; }
            .search-group { width: 100%; }
        }
    </style>
</head>
<body id="main-body">

    <div id="custom-toast" class="custom-toast">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="8" x2="12" y2="12"></line>
            <line x1="12" y1="16" x2="12.01" cy="16"></line>
        </svg>
        <span id="toast-msg">ä¸Šé™ç‚º 5 å¼µ</span>
    </div>

    <!-- é–‹å ´æ­¡è¿æç¤ºè¦–çª— -->
    <div class="modal-overlay" id="modal-welcome" style="display: flex; z-index: 9999;">
        <div class="modal" style="max-width: 400px; text-align: center;">
            <div class="modal-header" style="padding: 25px 20px;">
                <span>ç³»çµ±å…¬å‘Š</span>
            </div>
            <div class="modal-body" style="padding: 40px 30px;">
                <div style="margin-bottom: 20px;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="var(--primary-blue)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="12" y1="16" x2="12" y2="12"></line>
                        <line x1="12" y1="8" x2="12.01" y2="8"></line>
                    </svg>
                </div>
                <h3 style="margin: 0 0 15px 0; color: #1e293b; font-size: 19px; line-height: 1.4;">æ­¡è¿ä¾†åˆ° MIA æ˜¥å­£æˆç™¼<br>å³æ™‚åº§ä½ç³»çµ±</h3>
                <p style="margin: 0 0 30px 0; color: #475569; font-size: 15px; line-height: 1.6;">
                    ç›®å‰é¡¯ç¤ºçš„åº§ä½ç‚ºå³æ™‚ç‹€æ…‹ã€‚<br>
                    å¦‚éœ€åŠƒä½ï¼Œè«‹æ´½è©¢MIAå…‰å¾©é¤¨æ«ƒå°äººå“¡ï¼
                </p>
                <button class="btn-complete" style="width: 100%; margin-bottom: 20px;" onclick="window.closeModal('modal-welcome')">æˆ‘çŸ¥é“äº†</button>
                
                <!-- éš±è—ç‰ˆç®¡ç†å“¡æ·å¾‘ -->
                <div style="display: inline-flex; justify-content: center; align-items: center; gap: 6px; color: #cbd5e1; font-size: 13px; font-weight: bold; cursor: pointer; transition: 0.2s;" 
                     onclick="window.closeModal('modal-welcome'); window.handleHeaderAction();" 
                     onmouseover="this.style.color='#94a3b8'" 
                     onmouseout="this.style.color='#cbd5e1'">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                        <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                    </svg>
                    ç®¡ç†å“¡å°ˆå€
                </div>
            </div>
        </div>
    </div>

    <!-- ç®¡ç†å“¡ç™»å…¥ -->
    <div class="modal-overlay" id="modal-login">
        <div class="modal" style="max-width: 400px;">
            <div class="modal-header login-header">
                <span>ç®¡ç†å“¡ç™»å…¥</span>
                <span class="close-x" onclick="window.closeModal('modal-login')">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </span>
            </div>
            <div class="modal-body">
                <div class="form-group" style="margin-bottom: 25px;">
                    <input type="password" id="admin-pw-input" placeholder="è«‹è¼¸å…¥ç®¡ç†å“¡å¯†ç¢¼" style="padding:16px; border:1.5px solid #ddd; border-radius:12px; width:100%; box-sizing:border-box; font-size: 16px;">
                    <div id="login-error-msg" style="color: #ef4444; font-size: 13px; margin-top: 10px; font-weight: bold; display: none; text-align: center;">å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹é‡æ–°è¼¸å…¥ï¼</div>
                </div>
                <div style="display:flex; gap:10px;">
                    <button class="btn-confirm-final" style="background: white; color: #64748b; border: 1.5px solid #cbd5e1;" onclick="window.closeModal('modal-login')">å–æ¶ˆ</button>
                    <button class="btn-confirm-final" onclick="window.submitLogin()">ç™»å…¥</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ç™»å‡ºç¢ºèª -->
    <div class="modal-overlay" id="modal-logout-confirm">
        <div class="modal" style="max-width: 400px;">
            <div class="modal-header login-header">
                <span>ç³»çµ±ç™»å‡º</span>
                <span class="close-x" onclick="window.closeModal('modal-logout-confirm')">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </span>
            </div>
            <div class="modal-body">
                <div style="text-align: center; font-size: 16px; color: #475569; margin-bottom: 30px; font-weight: bold;">æ‚¨ç¢ºå®šè¦ç™»å‡ºç®¡ç†å“¡æ¨¡å¼å—ï¼Ÿ</div>
                <div style="display:flex; gap:10px;">
                    <button class="btn-confirm-final" style="background: white; color: #64748b; border: 1.5px solid #cbd5e1;" onclick="window.closeModal('modal-logout-confirm')">å–æ¶ˆ</button>
                    <button class="btn-confirm-final" style="background: #ef4444;" onclick="window.confirmLogout()">ç¢ºèªç™»å‡º</button>
                </div>
            </div>
        </div>
    </div>

    <div class="header">
        <div class="header-title-wrapper">
            <img src="logo.png" class="header-logo" alt="MIA LOGO" onerror="this.style.display='none'">
            <div class="header-title">
                <h1>2026 8th MIA SPRING SHOW</h1>
                <span>å³æ™‚åº§ä½ç¥¨å‹™ç³»çµ±</span>
            </div>
        </div>
        <div class="header-actions">
            <button class="menu-btn" id="header-back-btn" onclick="window.closeOrderManager()" style="display:none;" title="è¿”å›è³¼ç¥¨ç•«é¢">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M2 9a3 3 0 0 1 0 6v2a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-2a3 3 0 0 1 0-6V7a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2Z"/>
                    <path d="M13 5v2"/>
                    <path d="M13 17v2"/>
                    <path d="M13 11v2"/>
                </svg>
            </button>
            <button class="menu-btn" id="header-order-btn" onclick="window.openOrderManager()" style="display:none;" title="è¨‚å–®ç®¡ç†">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                    <polyline points="14 2 14 8 20 8"></polyline>
                    <line x1="16" y1="13" x2="8" y2="13"></line>
                    <line x1="16" y1="17" x2="8" y2="17"></line>
                    <polyline points="10 9 9 9 8 9"></polyline>
                </svg>
            </button>
            <button class="menu-btn" id="header-action-btn" onclick="window.handleHeaderAction()">
                <svg id="header-icon-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                    <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                </svg>
            </button>
        </div>
    </div>

    <!-- æ›ä½æ¨¡å¼å°ˆå±¬è³ªæ„Ÿæ©«å¹… -->
    <div id="swap-banner" class="swap-banner">
        <div id="swap-banner-text" class="swap-banner-text"></div>
        <div style="display:flex; gap:10px; flex-wrap: nowrap; align-items: center;">
            <button class="btn-prev-step" style="padding:8px 16px; white-space: nowrap; margin: 0;" onclick="window.cancelSwapMode()">å–æ¶ˆæ›ä½</button>
            <button id="btn-swap-prev" class="btn-prev-step" style="padding:8px 16px; display:none; white-space: nowrap; margin: 0;" onclick="window.goToSwapStep1()">ä¸Šä¸€æ­¥</button>
            <button id="btn-swap-next" class="btn-complete" style="padding:8px 16px; display:none; white-space: nowrap; margin: 0;" onclick="window.goToSwapStep2()">ä¸‹ä¸€æ­¥</button>
            <button id="btn-swap-confirm" class="btn-complete" style="padding:8px 16px; display:none; background:var(--primary-blue); white-space: nowrap; margin: 0;" onclick="window.confirmSwap()">ç¢ºèªæ›ä½</button>
        </div>
    </div>

    <div class="main-content" id="main-content-area">
        <div class="legend-area">
            <div class="legend-item"><div class="legend-box" style="background:var(--seat-bg-avail); border: 1px solid var(--seat-border-avail); box-shadow: 0 2px 0 0 var(--seat-shadow-avail);"></div> å¯é¸ä½</div>
            <div class="legend-item"><div class="legend-box" style="background:var(--seat-bg-selected); box-shadow: 0 2px 0 0 var(--seat-shadow-selected);"></div> å·²é¸æ“‡</div>
            <div class="legend-item"><div class="legend-box" style="background:var(--seat-bg-sold); box-shadow: 0 2px 0 0 var(--seat-shadow-sold);"></div> å·²å”®å‡º</div>
            <div class="legend-item"><div class="legend-box" style="background:var(--seat-bg-camera); box-shadow: 0 2px 0 0 var(--seat-shadow-camera);"></div> æ”å½±å¸­</div>
            <div class="legend-item"><div class="legend-box" style="background:var(--seat-bg-reserve); box-shadow: 0 2px 0 0 var(--seat-shadow-reserve);"></div> ä¿ç•™å¸­</div>
        </div>
        <div class="venue-wrapper">
            <div class="stage-area">
                <div class="screen">èˆ å°</div>
                <div class="view-notice">åº§ä½åœ–ç¤ºåƒ…ä¾›åƒè€ƒï¼Œå¯¦éš›è¦–é‡å¯èƒ½å› å ´åœ°ä½ˆç½®ç•¥æœ‰å·®ç•°ã€‚</div>
                <div class="venue-container" id="grid">
                    <div id="LT" class="block"></div><div id="MT" class="block"></div><div id="RT" class="block"></div>
                    <div id="LM" class="block"></div><div id="MM" class="block"></div><div id="RM" class="block"></div>
                    <div id="LB" class="block"></div><div id="MB" class="block"></div><div id="RB" class="block"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="order-page" id="order-page">
        <div class="order-page-inner">
            <div class="order-page-header">
                <h2 class="order-page-title">è¨‚å–®ç®¡ç†</h2>
                <div class="header-actions-group">
                    <button class="btn-action-outline" onclick="window.exportToExcel()" title="åŒ¯å‡ºå®Œæ•´ Excel (å«åº§ä½åœ–èˆ‡è¨‚å–®)">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                        åŒ¯å‡ºç¸½è¡¨ (Excel)
                    </button>
                    <button class="btn-action-outline" onclick="window.exportDailyReceipts()" title="ä¾æ“šæ‰€é¸çš„æ”¶æ¬¾æ—¥æœŸåŒ¯å‡ºåå†Š">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                        åŒ¯å‡ºç•¶æ—¥æ”¶æ¬¾
                    </button>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label" id="stat-revenue-title">ç´¯è¨ˆç¸½ç‡Ÿæ”¶</div>
                    <div class="stat-value" id="stat-revenue">$0</div>
                    <div id="stat-cash-revenue" style="font-size: 13px; color: #ef4444; font-weight: 600; margin-top: 5px;">ç¾é‡‘æ”¶å…¥ $0</div>
                    <div class="stat-icon-wrapper icon-revenue">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" cy="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">ç´¯è¨ˆä¸€èˆ¬å¸­å·²å”®</div>
                    <div class="stat-value" id="stat-tickets">0 <span>å¼µ</span></div>
                    <div id="stat-remaining-info" style="font-size: 11px; color: #64748b; margin-top: 5px; font-weight: 600;">å‰©é¤˜ï¼šä¸€èˆ¬ 0 å¼µ ï½œ ä¿ç•™ 0 å¼µ</div>
                    <div class="stat-icon-wrapper icon-tickets">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="4" width="20" height="16" rx="2"></rect><line x1="2" y1="10" x2="22" y2="10"></line></svg>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">ç´¯è¨ˆè¨‚å–®ç¸½æ•¸</div>
                    <div class="stat-value" id="stat-orders">0 <span>ç­†</span></div>
                    <div class="stat-icon-wrapper icon-orders">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M6 2 3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z"></path><path d="M3 6h18"></path><path d="M16 10a4 4 0 0 1-8 0"></path></svg>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">ç›®å‰å¾…è™•ç†ç­†æ•¸</div>
                    <div class="stat-value pending" id="stat-pending">0 <span>ç­†</span></div>
                    <div class="stat-icon-wrapper icon-pending">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="12" cy="4" x2="12" y2="15"></line>
                            <line x1="12" y1="20" x2="12.01" y2="20"></line>
                        </svg>
                    </div>
                </div>
            </div>

            <div class="filter-panel">
                <div class="filter-row-top">
                    <div class="filter-group">
                        <span class="filter-label">è¨‚å–®æ—¥æœŸ</span>
                        <input type="date" id="order-date-input" class="filter-control" onchange="window.handleFilterChange()">
                    </div>
                    <div class="filter-group">
                        <span class="filter-label">æ”¶æ¬¾æ—¥æœŸ</span>
                        <input type="date" id="receipt-date-input" class="filter-control" onchange="window.handleFilterChange()">
                    </div>
                    <div class="filter-group">
                        <span class="filter-label">ä»˜æ¬¾æ–¹å¼</span>
                        <select id="filter-payment" class="filter-control" onchange="window.handleFilterChange()">
                            <option value="all">å…¨éƒ¨</option>
                            <option value="cash">ç¾é‡‘</option>
                            <option value="transfer">åŒ¯æ¬¾</option>
                            <option value="free">å…ä»˜è²»</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <span class="filter-label">ç‹€æ…‹</span>
                        <!-- ğŸŒŸ æ–°å¢ï¼šå°‡å¾…é€€æ¬¾ã€å·²é€€æ¬¾ç¨ç«‹æˆç‚ºé¸é … -->
                        <select id="filter-status" class="filter-control" onchange="window.handleFilterChange()">
                            <option value="all">å…¨éƒ¨</option>
                            <option value="pending">å¾…å…¥å¸³</option>
                            <option value="paid">å·²å®Œæˆ</option>
                            <option value="pending_refund">å¾…é€€æ¬¾</option>
                            <option value="refunded">å·²é€€æ¬¾</option>
                        </select>
                    </div>
                    <button class="btn-clear-filters" onclick="window.clearAllFilters()">æ¸…é™¤ç¯©é¸</button>
                    <div class="search-group">
                        <input type="text" id="order-search-input" class="search-input" placeholder="æœå°‹å§“å/é›»è©±/åº§ä½..." oninput="window.handleFilterChange()">
                    </div>
                </div>
            </div>

            <div class="results-summary">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
                <span>å…±è¨ˆ <span id="results-count-number" class="results-count">0</span> ç­†ç¬¦åˆç¯©é¸æ¢ä»¶</span>
            </div>

            <div class="order-table-container">
                <table class="order-table">
                    <thead>
                        <tr>
                            <th>è¨‚å–®æ™‚é–“</th>
                            <th>è³¼ç¥¨äººè³‡è¨Š</th>
                            <th>åº§ä½</th>
                            <th>é‡‘é¡/æ–¹å¼</th>
                            <th>ç‹€æ…‹</th>
                            <th style="text-align:right;">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="order-table-body"></tbody>
                </table>
            </div>
            
            <!-- åˆ†é æ§åˆ¶å€å¡Š -->
            <div class="pagination" id="pagination-controls" style="display:none;">
                <div class="page-info">
                    <span>æ¯é é¡¯ç¤º</span>
                    <select id="items-per-page" class="items-per-page-select" onchange="window.changeItemsPerPage()">
                        <option value="10">10</option>
                        <option value="20" selected>20</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                    </select>
                    <span>ç­†</span>
                </div>
                <div class="page-info">
                    <span id="page-indicator" style="font-weight: bold; color: var(--primary-blue);">ç¬¬ 1 / 1 é </span>
                    <div style="display:flex; gap: 8px;">
                        <button class="page-btn" id="btn-prev-page" onclick="window.prevPage()">ä¸Šä¸€é </button>
                        <button class="page-btn" id="btn-next-page" onclick="window.nextPage()">ä¸‹ä¸€é </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ‡¸æµ®è³¼ç¥¨åˆ— -->
    <div class="floating-bar" id="floating-bar">
        <div class="floating-bar-left">
            <div class="floating-cart-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="8" cy="21" r="1"></circle>
                    <circle cx="19" cy="21" r="1"></circle>
                    <path d="M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.12"></path>
                </svg>
            </div>
            <div class="floating-info">
                <div class="floating-info-top" id="display-sub-info">å·²é¸ 0 åº§ä½</div>
            </div>
        </div>
        <button class="btn-floating-confirm" id="btn-open-modal">ç¢ºèªè³¼ç¥¨</button>
    </div>

    <!-- è³¼ç¥¨æ­¥é©Ÿ -->
    <div class="modal-overlay" id="modal-purchase">
        <div class="modal">
            <div class="modal-header">
                <span>è³¼ç¥¨è³‡è¨Š</span>
                <span class="close-x" onclick="window.closeModal('modal-purchase')">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>åŠƒä½åº§ä½</label>
                    <input type="text" id="buy-seat-list" readonly style="padding:16px 14px; border:none; background:#f9f9f9; color:var(--primary-blue); font-weight:900; border-radius:8px; font-size:19px; font-family: inherit;">
                </div>
                <div class="form-group">
                    <label>ç¥¨åƒ¹é¡å‹</label>
                    <select id="p-type" style="padding:14px; border:1px solid #ddd; border-radius:8px; font-size:16px;" onchange="window.updateTotalDisplay()">
                        <option value="650">æ—©é³¥å„ªæƒ  NT$ 650 / å¼µ</option>
                        <option value="800">ä¸€èˆ¬åŸåƒ¹ NT$ 800 / å¼µ</option>
                        <option value="0">å…¬é—œç¥¨åƒ¹ NT$ 0 / å¼µ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ä»˜æ¬¾æ–¹å¼</label>
                    <select id="p-pay-method-select" style="padding:14px; border:1px solid #ddd; border-radius:8px; font-size:16px;">
                        <option value="cash">ç¾é‡‘</option>
                        <option value="transfer">åŒ¯æ¬¾</option>
                    </select>
                </div>
                <div class="total-summary-row">
                    <div class="total-label">ç¸½è¨ˆé‡‘é¡</div>
                    <div id="buy-final-total" class="total-amount">NT$ 0</div>
                </div>
                <button class="btn-confirm-final" style="margin-top: 20px;" onclick="window.goToStep2()">ä¸‹ä¸€æ­¥ï¼šå¡«å¯«è³¼ç¥¨è³‡è¨Š</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modal-payment">
        <div class="modal">
            <div class="modal-header">
                <span>è³¼ç¥¨è³‡è¨Š</span>
                <span class="close-x" onclick="window.closeModal('modal-payment')">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label id="label-name">è³¼ç¥¨å§“å <span class="required-star">*</span></label>
                    <input type="text" id="p-name" placeholder="è«‹è¼¸å…¥å§“å" style="padding:14px; border:1px solid #ddd; border-radius:8px; font-size:16px;">
                </div>
                <div class="form-group">
                    <label id="label-phone">è¯çµ¡é›»è©± <span class="required-star">*</span></label>
                    <input type="tel" id="p-phone" placeholder="è«‹è¼¸å…¥ 09 é–‹é ­çš„ 10 ç¢¼é›»è©±" maxlength="10" style="padding:14px; border:1px solid #ddd; border-radius:8px; font-size:16px;">
                </div>
                <div class="form-group">
                    <label>å‚™è¨»è³‡è¨Š</label>
                    <input type="text" id="p-note" placeholder="è«‹è¼¸å…¥å‚™è¨»è³‡è¨Š" style="padding:14px; border:1px solid #ddd; border-radius:8px; font-size:16px;">
                </div>
                <div style="display:flex; gap:10px;">
                    <button class="btn-prev-step" onclick="window.goToStep1()">ä¸Šä¸€æ­¥</button>
                    <!-- åŠ ä¸Š id ä»¥ä¾¿æ“ä½œ Loading ç‹€æ…‹ -->
                    <button class="btn-complete" id="btn-submit-order" onclick="window.submitFinalOrder()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
                        ç¢ºèªè¨‚ç¥¨
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modal-success">
        <div class="modal">
            <div class="modal-header success-header">
                <span>åŠƒä½å®Œæˆ</span>
                <span class="close-x" onclick="window.closeModal('modal-success')">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </span>
            </div>
            <div class="modal-body" style="text-align: center; padding: 30px;">
                <div class="success-checkmark">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                </div>
                <div id="success-status-label" style="display: inline-block; padding: 8px 24px; border-radius: 999px; font-weight: bold; font-size: 15px; margin-bottom: 5px;">è¨‚å–®ç‹€æ…‹ï¼šå¾…ä»˜æ¬¾</div>
                <div id="copy-transfer-box" class="copy-info-box" style="display:none;">
                    <div id="copy-transfer-text" class="copy-info-text"></div>
                    <button class="btn-copy-action" onclick="window.copyTransferInfo()">é»æ“Šè¤‡è£½åŒ¯æ¬¾è³‡è¨Š</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ç®¡ç†å“¡æ ¸éŠ·ç¢ºèª -->
    <div class="modal-overlay" id="modal-verify">
        <div class="modal" style="max-width: 420px;">
            <div class="modal-header verify-header">
                <span id="verify-modal-title-text">æ ¸éŠ·ç¢ºèª</span>
                <span class="close-x" onclick="window.closeModal('modal-verify')">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </span>
            </div>
            <div class="modal-body">
                <input type="hidden" id="verify-order-id">
                <div style="display: flex; flex-direction: column; gap: 15px; margin-bottom: 30px; padding: 0 5px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; min-height: 40px;">
                        <span style="font-size: 15px; font-weight: bold; color: #666; white-space: nowrap; flex-shrink: 0;">è³¼ç¥¨å§“åï¼š</span>
                        <span id="verify-name" style="font-weight: bold; color: #1e293b; font-size: 15px; text-align: right;"></span>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; min-height: 40px;">
                        <span style="font-size: 15px; font-weight: bold; color: #666; white-space: nowrap; flex-shrink: 0;">æ‡‰æ”¶é‡‘é¡ï¼š</span>
                        <span id="verify-total" style="font-weight: bold; color: var(--primary-blue); font-size: 15px; text-align: right;"></span>
                    </div>
                    <div id="verify-transfer-info" style="display:none; justify-content: space-between; align-items: center; min-height: 40px;">
                        <span style="font-size: 15px; font-weight: bold; color: #666; white-space: nowrap; flex-shrink: 0;">åŒ¯æ¬¾æœ«äº”ç¢¼ï¼š</span>
                        <span id="verify-bank-code" style="font-weight: bold; color: #ef4444; font-size: 15px; text-align: right;"></span>
                    </div>
                </div>
                <div style="display:flex; gap:10px;">
                    <button class="btn-prev-step" onclick="window.closeModal('modal-verify')">å–æ¶ˆ</button>
                    <button class="btn-complete" id="btn-confirm-verify" onclick="window.confirmVerify()">ç¢ºèªæ ¸éŠ·</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ç®¡ç†å“¡é€€æ¬¾æ ¸éŠ·ç¢ºèª -->
    <div class="modal-overlay" id="modal-verify-refund">
        <div class="modal" style="max-width: 420px;">
            <div class="modal-header verify-header">
                <span>é€€æ¬¾å®Œæˆç¢ºèª</span>
                <span class="close-x" onclick="window.closeModal('modal-verify-refund')">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </span>
            </div>
            <div class="modal-body">
                <input type="hidden" id="verify-refund-order-id">
                <div style="display: flex; flex-direction: column; gap: 15px; margin-bottom: 30px; padding: 0 5px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; min-height: 40px;">
                        <span style="font-size: 15px; font-weight: bold; color: #666; white-space: nowrap; flex-shrink: 0;">é€€æ¬¾å°è±¡ï¼š</span>
                        <span id="verify-refund-name" style="font-weight: bold; color: #1e293b; font-size: 15px; text-align: right;"></span>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; min-height: 40px;">
                        <span style="font-size: 15px; font-weight: bold; color: #666; white-space: nowrap; flex-shrink: 0;">æ‡‰é€€é‡‘é¡ï¼š</span>
                        <span id="verify-refund-total" style="font-weight: bold; color: #ef4444; font-size: 15px; text-align: right;"></span>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 8px; margin-top: 10px;">
                        <span style="font-size: 14px; font-weight: bold; color: #666;">å¯¦éš›é€€æ¬¾æ—¥æœŸï¼š</span>
                        <input type="date" id="verify-refund-date-input" style="padding:12px; border:1px solid #ddd; border-radius:8px; font-size:16px;">
                    </div>
                </div>
                <div style="display:flex; gap:10px;">
                    <button class="btn-prev-step" onclick="window.closeModal('modal-verify-refund')">å–æ¶ˆ</button>
                    <button class="btn-complete" id="btn-confirm-verify-refund" onclick="window.confirmVerifyRefund()">ç¢ºèªå·²é€€æ¬¾</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ğŸŒŸ é‡æ–°åˆ†é–‹ï¼šé€€ç¥¨ä½œæ¥­å°ˆå±¬è¦–çª— -->
    <div class="modal-overlay" id="modal-create-refund" style="z-index: 4000;">
        <div class="modal" style="max-width: 420px;">
            <div class="modal-header">
                <span>é€€ç¥¨ä½œæ¥­</span>
                <span class="close-x" onclick="window.closeModal('modal-create-refund')">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </span>
            </div>
            <div class="modal-body">
                <input type="hidden" id="refund-order-id">
                
                <div style="margin-bottom: 20px;">
                    <h3 style="margin: 0 0 10px 0; color: #1e293b; font-size: 16px;">æ‚¨æ­£åœ¨è™•ç† <span id="refund-order-name" style="color:var(--primary-blue)"></span> çš„é€€ç¥¨</h3>
                </div>

                <div class="form-group">
                    <label>è«‹å‹¾é¸è¦é€€å‡ºçš„åº§ä½ï¼ˆå…¨é¸å³å…¨å–®é€€ç¥¨ï¼‰</label>
                    <div id="refund-seat-checkboxes" style="display:flex; flex-wrap:wrap; gap:10px; margin-bottom:15px;">
                        <!-- JS dynamically injects checkboxes here -->
                    </div>
                </div>

                <div class="form-group" id="refund-method-group">
                    <label>é è¨ˆé€€æ¬¾æ–¹å¼</label>
                    <select id="refund-method-select" class="filter-control" style="width:100%;">
                        <option value="cash">ç¾é‡‘é€€æ¬¾</option>
                        <option value="transfer">åŒ¯æ¬¾é€€æ¬¾</option>
                    </select>
                </div>

                <div id="refund-note-text" style="margin-bottom: 20px; font-size: 13px; color: #64748b; line-height: 1.5;">
                    <!-- å‹•æ…‹æç¤ºæ–‡å­— -->
                </div>

                <div style="display:flex; gap:12px;">
                    <button class="btn-prev-step" style="padding: 14px; flex: 1;" onclick="window.closeModal('modal-create-refund')">å–æ¶ˆ</button>
                    <button class="btn-complete" id="btn-execute-create-refund" style="background: #ef4444; padding: 14px; flex: 1.5; color: white;" onclick="window.executeCreateRefund()">ç¢ºèªé€€ç¥¨</button>
                </div>
            </div>
        </div>
    </div>

    <!-- åˆªé™¤è¨‚å–®å°ˆå±¬è¦–çª— -->
    <div class="modal-overlay" id="modal-delete-order" style="z-index: 4000;">
        <div class="modal" style="max-width: 420px;">
            <div class="modal-header delete-header">
                <span>åˆªé™¤è¨‚å–®</span>
                <span class="close-x" onclick="window.closeModal('modal-delete-order')">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </span>
            </div>
            <div class="modal-body" style="padding: 32px 24px; text-align: center;">
                <div class="warning-exclamation" style="margin-bottom: 15px;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </div>
                
                <div style="margin-bottom: 25px;">
                    <h3 style="margin: 0 0 10px 0; color: #1e293b; font-size: 16px;">æ‚¨å³å°‡åˆªé™¤ <span id="del-order-name" style="color:var(--primary-blue)"></span> çš„æ•´ç­†è¨‚å–®</h3>
                    <p style="margin: 0; color: #1e293b; font-weight: bold; font-size: 16px;">æ­¤æ“ä½œå°‡<span style="color: #ef4444;">ä¸ç•™ä»»ä½•å¸³é¢ç´€éŒ„</span>ï¼Œä¸”åº§ä½å°‡ç«‹å³é‡‹å‡ºï¼</p>
                </div>

                <input type="hidden" id="delete-target-id">

                <div style="display:flex; gap:12px;">
                    <button class="btn-prev-step" style="padding: 14px; flex: 1;" onclick="window.closeModal('modal-delete-order')">å–æ¶ˆ</button>
                    <!-- åŠ ä¸Š id ä»¥ä¾¿æ“ä½œ Loading ç‹€æ…‹ -->
                    <button class="btn-complete" id="btn-execute-delete" style="background: #ef4444; padding: 14px; flex: 1.5; color: white;" onclick="window.executeDeleteOrder()">ç¢ºå®šä½œå»¢</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ç·¨è¼¯è¨‚å–® -->
    <div class="modal-overlay" id="modal-edit-order">
        <div class="modal" style="max-width: 420px;">
            
            <!-- ç¬¬ä¸€è¦–åœ–ï¼šç·¨è¼¯è¡¨å–® -->
            <div id="edit-step-1" style="display: flex; flex-direction: column; height: 100%;">
                <div class="modal-header">
                    <span>ç·¨è¼¯è¨‚å–®</span>
                    <span class="close-x" onclick="window.closeModal('modal-edit-order')">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                    </span>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="edit-order-id">
                    <div class="form-group">
                        <label>åŒ¯æ¬¾æœ«äº”ç¢¼</label>
                        <input type="text" id="edit-order-bank" placeholder="è‹¥éåŒ¯æ¬¾è«‹ç•™ç©º" style="padding:14px; border:1px solid #ddd; border-radius:8px; font-size:16px;">
                    </div>
                    <div class="form-group">
                        <label>å‚™è¨»è³‡è¨Š</label>
                        <input type="text" id="edit-order-note" placeholder="ä¾‹å¦‚ï¼šå¯„ç¥¨æˆ–é€€æ¬¾å¸³è™Ÿ" style="padding:14px; border:1px solid #ddd; border-radius:8px; font-size:16px;">
                    </div>
                    <div class="form-group">
                        <label>ä»˜æ¬¾/é€€æ¬¾ ç‹€æ…‹</label>
                        <select id="edit-order-status" style="padding:14px; border:1px solid #ddd; border-radius:8px; font-size:16px;">
                            <!-- JS å‹•æ…‹å¯«å…¥é¸é … -->
                        </select>
                    </div>
                    <div style="display:flex; gap:10px; margin-top: 10px;">
                        <button class="btn-prev-step" onclick="window.closeModal('modal-edit-order')">å–æ¶ˆ</button>
                        <button class="btn-complete" onclick="window.saveOrderEdit()">ç¢ºèªè®Šæ›´</button>
                    </div>
                    
                    <!-- æ›´æ›åº§ä½æŒ‰éˆ• (é€€è²»å–®ä¸é¡¯ç¤º) -->
                    <button id="btn-open-swap" class="btn-action-outline" style="width:100%; justify-content:center; margin-top:15px; border-color:var(--primary-blue); color:var(--primary-blue);" onclick="window.startSwapMode()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                        é€²å…¥æ›´æ›åº§ä½æ¨¡å¼
                    </button>
                </div>
            </div>

            <!-- ç¬¬äºŒè¦–åœ–ï¼šé˜²å‘†ç¢ºèª -->
            <div id="edit-step-2" style="display: none; flex-direction: column; height: 100%;">
                <div class="modal-header danger-header">
                    <span>è®Šæ›´ç¢ºèª</span>
                    <span class="close-x" onclick="window.cancelWarning()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                    </span>
                </div>
                <div class="modal-body" style="padding: 32px 24px; text-align: center;">
                    <div class="warning-exclamation">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="12" y1="8" x2="12" y2="12"></line>
                            <line x1="12" y1="16" x2="12.01" y2="16"></line>
                        </svg>
                    </div>
                    <div style="margin-bottom: 30px; text-align: center; padding: 0 10px;">
                        <p style="margin: 0; color: #1e293b; font-size: 16px; font-weight: bold; line-height: 1.6;">æ­¤ç­†è¨‚å–®å·²å®Œæˆæ ¸éŠ·ï¼Œè®Šæ›´ç‹€æ…‹å°‡æœƒï¼š<br><span style="color: #ef4444; font-weight: 800;">é€€å›æœªæ ¸éŠ·ç‹€æ…‹</span> ä¸¦ä¸” <span style="color: #ef4444; font-weight: 800;">æ¸…é™¤ç›¸æ‡‰æ—¥æœŸ</span></p>
                    </div>
                    <div style="display:flex; gap:12px;">
                        <button class="btn-prev-step" style="padding: 14px; flex: 1;" onclick="window.cancelWarning()">å–æ¶ˆ</button>
                        <!-- åŠ ä¸Š id ä»¥ä¾¿æ“ä½œ Loading ç‹€æ…‹ -->
                        <button class="btn-complete" id="btn-execute-edit" style="background: #ef4444; padding: 14px; flex: 1.5; color: white;" onclick="window.executeOrderEdit()">ç¢ºå®šè®Šæ›´</button>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js";
        import { getDatabase, ref, onValue, update } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBpxxZ0DJvGJdu8anqJWmGeGHf_wUufv28",
            authDomain: "miaspringshow.firebaseapp.com",
            databaseURL: "https://miaspringshow-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "miaspringshow",
            storageBucket: "miaspringshow.firebasestorage.app",
            messagingSenderId: "756405426670",
            appId: "1:756405426670:web:cc234426bb8c3ac2ce96ff"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        
        let isAdmin = false;
        let seatsData = {};
        let ordersData = {};
        let selectedIds = [];
        let toastTimeout = null;
        let originalOrderState = null;
        
        // åˆ†é ç‹€æ…‹è®Šæ•¸
        let currentPage = 1;
        let itemsPerPage = 20;

        // æ›ä½æ¨¡å¼ç‹€æ…‹ç®¡ç†
        window.swapState = { active: false, step: 1, orderId: null, oldSeats: [], newSeats: [], type: '' };

        const iconLock = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>`;
        const iconUnlock = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 9.9-1"></path></svg>`;

        const cameraSeats = ["G15", "G16", "G17", "H15", "H16", "H17"];
        const reserveSeats = [];
        for(let i=1; i<=27; i++) { reserveSeats.push("A"+i); reserveSeats.push("B"+i); }
        for(let i=10; i<=14; i++) { reserveSeats.push("G"+i); reserveSeats.push("H"+i); }
        for(let i=18; i<=22; i++) { reserveSeats.push("G"+i); reserveSeats.push("H"+i); }

        // å»ºç«‹ç¥¨åˆ¸æµæ°´è™Ÿå°ç…§è¡¨
        const ticketMapping = {};
        const serialList = [];

        function addMapping(startSerial, seatPrefix, startNum, count) {
            for (let i = 0; i < count; i++) {
                const serialNum = startSerial + i;
                const serialStr = String(serialNum).padStart(3, '0');
                const seatId = seatPrefix + String(startNum + i);
                ticketMapping[seatId] = serialStr;
                serialList.push({ serial: serialStr, seat: seatId });
            }
        }

        addMapping(1, 'C', 1, 29);
        addMapping(32, 'D', 1, 31);
        addMapping(65, 'E', 1, 33);
        addMapping(100, 'F', 1, 14);
        addMapping(660, 'F', 15, 3); 
        addMapping(114, 'F', 18, 14);
        addMapping(128, 'G', 1, 14);
        addMapping(142, 'G', 18, 14); 
        addMapping(156, 'H', 1, 31); 
        
        let currentSerial = 187;
        const midRows = ['I', 'J', 'K', 'L', 'M', 'N', 'O'];
        for(let r of midRows) { addMapping(currentSerial, r, 1, 31); currentSerial += 31; }
        
        const backRows = ['P', 'Q', 'R', 'S', 'T', 'U', 'V', 'W', 'X', 'Y'];
        for(let r of backRows) { addMapping(currentSerial, r, 1, 25); currentSerial += 25; }

        const extraBlanks = [30, 31, 63, 64, 98, 99, 654, 655, 656, 657, 658, 659];
        for (let num of extraBlanks) {
            serialList.push({ serial: String(num).padStart(3, '0'), seat: '-' });
        }

        serialList.sort((a, b) => parseInt(a.serial) - parseInt(b.serial));

        onValue(ref(db, 'seats'), (snapshot) => { seatsData = snapshot.val() || {}; render(); });
        onValue(ref(db, 'orders'), (snapshot) => { 
            ordersData = snapshot.val() || {}; 
            const orderPage = document.getElementById('order-page');
            if(orderPage && orderPage.style.display === 'flex') window.renderOrders();
        });

        window.showToast = (msg, type = 'error') => {
            const toast = document.getElementById('custom-toast');
            const toastMsg = document.getElementById('toast-msg');
            if (!toast || !toastMsg) return;
            toastMsg.innerText = msg;
            toast.className = 'custom-toast show';
            if(type === 'success') toast.classList.add('success');
            if (toastTimeout) clearTimeout(toastTimeout);
            toastTimeout = setTimeout(() => {
                toast.classList.remove('show');
                toastTimeout = null;
            }, 3000);
        };

        window.handleHeaderAction = () => {
            if (!isAdmin) {
                document.getElementById('modal-login').style.display = 'flex';
                document.getElementById('admin-pw-input').value = '';
                document.getElementById('login-error-msg').style.display = 'none';
                setTimeout(() => document.getElementById('admin-pw-input').focus(), 100);
            } else {
                document.getElementById('modal-logout-confirm').style.display = 'flex';
            }
        };

        window.submitLogin = () => {
            const pw = document.getElementById('admin-pw-input').value;
            if(pw === "mia2026") {
                isAdmin = true;
                document.getElementById('main-body').classList.add('logged-in');
                document.getElementById('header-action-btn').innerHTML = iconUnlock;
                document.getElementById('header-order-btn').style.display = 'flex';
                window.closeModal('modal-login');
                render(); 
                window.showToast("ç™»å…¥æˆåŠŸ", "success");
            } else {
                document.getElementById('login-error-msg').style.display = 'block';
                document.getElementById('admin-pw-input').value = '';
                document.getElementById('admin-pw-input').focus();
            }
        };

        window.confirmLogout = () => {
            isAdmin = false; 
            selectedIds = []; 
            document.getElementById('header-action-btn').innerHTML = iconLock;
            document.getElementById('header-order-btn').style.display = 'none';
            document.getElementById('header-back-btn').style.display = 'none';
            window.closeOrderManager();
            window.closeModal('modal-logout-confirm');
            render(); 
            window.showToast("å·²æˆåŠŸç™»å‡º", "success");
        };

        const layout = [
            { id: 'T', rows: 6, L: [6, 7, 8, 9, 10, 9], M: [13, 13, 13, 13, 13, 13], R: [6, 7, 8, 9, 10, 9], start: 'A' }, 
            { id: 'M', rows: 10, L: [9, 9, 9, 9, 9, 9, 9, 9, 8, 5], M: [13, 13, 13, 13, 13, 13, 13, 13, 15, 15], R: [9, 9, 9, 9, 9, 9, 9, 9, 8, 5], start: 'G' }, 
            { id: 'B', rows: 9, L: 5, M: 15, R: 5, start: 'Q' }   
        ];

        function render() {
            layout.forEach(sec => {
                for(let r=0; r<sec.rows; r++){
                    const rowName = String.fromCharCode(sec.start.charCodeAt(0)+r);
                    const cL = Array.isArray(sec.L)?sec.L[r]:sec.L;
                    const cM = Array.isArray(sec.M)?sec.M[r]:sec.M;
                    const cR = Array.isArray(sec.R)?sec.R[r]:sec.R;
                    updateBlock(`L${sec.id}`, rowName, 1, cL);
                    updateBlock(`M${sec.id}`, rowName, cL+1, cL+cM);
                    updateBlock(`R${sec.id}`, rowName, cL+cM+1, cL+cM+cR);
                }
            });
            updateBottomBar();
        }

        function updateBlock(bid, rowName, start, end) {
            const block = document.getElementById(bid);
            if(!block) return;
            if(rowName==='A' || rowName==='G' || rowName==='Q') block.innerHTML = '';
            const rowDiv = document.createElement('div');
            rowDiv.className = 'row';
            
            const isSwapActive = window.swapState && window.swapState.active;

            for(let s=start; s<=end; s++){
                const id = rowName + s;
                const div = document.createElement('div');
                div.innerText = id;
                const isBlocked = ( (rowName === 'A' || rowName === 'B') && (bid.startsWith('L') || bid.startsWith('R')) );
                
                let isSwapDisabled = false;
                let swapClasses = [];
                const isReserve = reserveSeats.includes(id);

                if (isSwapActive && !isBlocked && !cameraSeats.includes(id)) {
                    if (window.swapState.step === 1) {
                        const o = ordersData[window.swapState.orderId];
                        const isRefunded = (o.refundedSeats || []).includes(id);
                        if (!o.seats.includes(id) || isRefunded) {
                            isSwapDisabled = true;
                        } else {
                            swapClasses.push('swap-selectable-old');
                            if (window.swapState.oldSeats.includes(id)) swapClasses.push('swap-selected-old');
                        }
                    } else { // step 2
                        const matchType = (window.swapState.type === 'reserve' && isReserve) || (window.swapState.type === 'regular' && !isReserve);
                        const currentStatus = seatsData[id]?.status || 'available';
                        const isFreed = window.swapState.oldSeats.includes(id);

                        if (!matchType) {
                            isSwapDisabled = true;
                        } else if (isFreed) {
                            isSwapDisabled = true;
                        } else if (currentStatus === 'sold') {
                            isSwapDisabled = true;
                        }

                        if (window.swapState.newSeats.includes(id)) {
                            swapClasses.push('selected');
                        }
                    }
                } else if (isSwapActive) {
                    isSwapDisabled = true;
                }

                if (isBlocked) {
                    div.innerText = "x";
                    div.className = "seat blocked-seat";
                    if(isSwapActive) div.classList.add('disabled-seat');
                } else if (cameraSeats.includes(id)) {
                    div.className = "seat camera-seat";
                    if(isSwapActive) div.classList.add('disabled-seat');
                } else {
                    const status = (seatsData[id] && seatsData[id].status) ? seatsData[id].status : 'available';
                    div.className = `seat ${status} ${isReserve ? 'reserve-seat' : ''}`;
                    
                    if (isSwapDisabled) div.classList.add('disabled-seat');
                    swapClasses.forEach(cls => div.classList.add(cls));
                    if (!isSwapActive && selectedIds.includes(id)) div.classList.add('selected');
                    
                    div.onclick = () => window.handleSeatClick(id);
                }
                rowDiv.appendChild(div);
            }
            block.appendChild(rowDiv);
        }

        window.handleSeatClick = (id) => {
            if(!isAdmin) return;

            if (window.swapState && window.swapState.active) {
                const { step, orderId, oldSeats, newSeats, type } = window.swapState;
                const o = ordersData[orderId];
                
                if (step === 1) {
                    const isRefunded = (o.refundedSeats || []).includes(id);
                    if (!o.seats.includes(id) || isRefunded) return;
                    if (oldSeats.includes(id)) {
                        window.swapState.oldSeats = oldSeats.filter(s => s !== id);
                    } else {
                        window.swapState.oldSeats.push(id);
                    }
                    updateSwapBanner();
                    render();
                } else if (step === 2) {
                    const isSeatReserve = reserveSeats.includes(id);
                    if ((type === 'reserve' && !isSeatReserve) || (type === 'regular' && isSeatReserve)) {
                        window.showToast(`è«‹é¸æ“‡ã€Œ${type === 'reserve' ? 'ä¿ç•™å¸­' : 'ä¸€èˆ¬å¸­'}ã€ç©ºä½ï¼`, "error");
                        return;
                    }
                    
                    if (oldSeats.includes(id)) {
                        return; 
                    }

                    const currentStatus = seatsData[id]?.status || 'available';
                    if (currentStatus === 'sold') {
                        return; 
                    }

                    if (newSeats.includes(id)) {
                        window.swapState.newSeats = newSeats.filter(s => s !== id);
                    } else {
                        if (newSeats.length >= oldSeats.length) {
                            window.showToast(`æ‚¨åªé€€å‡ºäº† ${oldSeats.length} å€‹åº§ä½ï¼Œæœ€å¤šåªèƒ½é¸ ${oldSeats.length} å€‹æ–°åº§ä½ï¼`, "error");
                            return;
                        }
                        window.swapState.newSeats.push(id);
                    }
                    updateSwapBanner();
                    render();
                }
                return; 
            }

            const current = seatsData[id] || { status: 'available' };
            if(current.status === 'sold') {
                window.showToast("æ­¤åº§ä½å·²å”®å‡ºï¼Œè«‹è‡³ã€Œè¨‚å–®ç®¡ç†ã€é€²è¡Œç·¨è¼¯æˆ–åˆªé™¤", "error");
                return;
            }
            if (selectedIds.includes(id)) {
                selectedIds = selectedIds.filter(i => i !== id);
            } else { 
                if(selectedIds.length >= 5) { 
                    window.showToast("ä¸Šé™ç‚º 5 å¼µ", "error"); 
                    return; 
                }
                selectedIds.push(id); 
            }
            render();
        };

        function updateBottomBar() {
            const count = selectedIds.length;
            const displaySub = document.getElementById('display-sub-info');
            if(displaySub) displaySub.innerText = `å·²é¸ ${count} åº§ä½`;
            const floatingBar = document.getElementById('floating-bar');
            if (floatingBar) {
                if (window.swapState && window.swapState.active) {
                    floatingBar.classList.remove('show');
                    return;
                }
                if (count > 0 && isAdmin && document.getElementById('order-page').style.display !== 'flex') floatingBar.classList.add('show');
                else floatingBar.classList.remove('show');
            }
        }

        window.startSwapMode = () => {
            const oid = document.getElementById('edit-order-id').value;
            const o = ordersData[oid];
            if(!o || !o.seats || o.seats.length === 0) return;
            
            const isReserveOrder = reserveSeats.includes(o.seats[0]);

            window.swapState = { 
                active: true, 
                step: 1, 
                orderId: oid, 
                oldSeats: [], 
                newSeats: [], 
                type: isReserveOrder ? 'reserve' : 'regular' 
            };
            
            selectedIds = []; 
            window.closeModal('modal-edit-order');
            document.getElementById('order-page').style.display = 'none'; 
            document.getElementById('main-content-area').style.display = 'flex';
            document.getElementById('swap-banner').style.display = 'flex';
            
            updateSwapBanner();
            render();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        window.cancelSwapMode = () => {
            window.swapState = { active: false, step: 1, orderId: null, oldSeats: [], newSeats: [], type: '' };
            document.getElementById('swap-banner').style.display = 'none';
            render();
        };

        window.goToSwapStep1 = () => {
            window.swapState.step = 1;
            window.swapState.newSeats = []; 
            updateSwapBanner();
            render();
        };

        window.goToSwapStep2 = () => {
            window.swapState.step = 2;
            updateSwapBanner();
            render();
        };

        function updateSwapBanner() {
            const bText = document.getElementById('swap-banner-text');
            const bPrev = document.getElementById('btn-swap-prev');
            const bNext = document.getElementById('btn-swap-next');
            const bConfirm = document.getElementById('btn-swap-confirm');
            const o = ordersData[window.swapState.orderId];

            if (window.swapState.step === 1) {
                bText.innerHTML = `æ­£åœ¨ç‚º <b>${o.name}</b> æ›´æ›åº§ä½<br>ç¬¬ä¸€æ­¥ï¼šè«‹é»é¸è¦é€€å‡ºçš„ã€ŒåŸåº§ä½ã€ <span class="highlight-red">(å·²é¸ ${window.swapState.oldSeats.length} å€‹)</span>`;
                if(bPrev) bPrev.style.display = 'none';
                bNext.style.display = window.swapState.oldSeats.length > 0 ? 'block' : 'none';
                bConfirm.style.display = 'none';
            } else {
                const required = window.swapState.oldSeats.length;
                const current = window.swapState.newSeats.length;
                const typeName = window.swapState.type === 'reserve' ? 'ä¿ç•™å¸­' : 'ä¸€èˆ¬å¸­';
                bText.innerHTML = `ç¬¬äºŒæ­¥ï¼šè«‹é¸æ“‡ <b>${required}</b> å€‹æ–°çš„ã€Œ${typeName}ã€ç©ºä½<br><span class="highlight-green">(å·²é¸ ${current} / éœ€é¸ ${required})</span>`;
                if(bPrev) bPrev.style.display = 'block';
                bNext.style.display = 'none';
                bConfirm.style.display = current === required ? 'block' : 'none';
            }
        }

        window.confirmSwap = () => {
            document.getElementById('swap-confirm-old').innerText = window.swapState.oldSeats.join(', ');
            document.getElementById('swap-confirm-new').innerText = window.swapState.newSeats.join(', ');
            document.getElementById('modal-swap-confirm').style.display = 'flex';
        };

        window.executeSwap = () => {
            const oldHtml = setLoadingState('btn-execute-swap', true);
            const { orderId, oldSeats, newSeats } = window.swapState;
            const o = ordersData[orderId];
            
            let updatedSeats = o.seats.filter(s => !oldSeats.includes(s));
            updatedSeats = [...updatedSeats, ...newSeats];

            const updates = {};
            updates[`orders/${orderId}/seats`] = updatedSeats;

            oldSeats.forEach(s => {
                if (!updatedSeats.includes(s)) { 
                    updates[`seats/${s}`] = null;
                }
            });

            newSeats.forEach(s => {
                updates[`seats/${s}`] = { 
                    status: 'sold', 
                    name: o.name, 
                    phone: o.phone, 
                    ticketType: o.ticketType, 
                    bankCode: o.bankCode || "", 
                    note: o.note || "", 
                    paymentMethod: o.paymentMethod, 
                    orderId: orderId 
                };
                if (o.receiptDate) updates[`seats/${s}`].receiptDate = o.receiptDate;
                if (o.reportDate) updates[`seats/${s}`].reportDate = o.reportDate;
            });

            update(ref(db), updates).then(() => {
                window.closeModal('modal-swap-confirm');
                window.cancelSwapMode(); 
                window.openOrderManager(); 
                window.showToast("åº§ä½æ›´æ›æˆåŠŸï¼", "success");
            }).catch(err => {
                console.error(err);
                window.showToast("æ›´æ›å¤±æ•—ï¼Œè«‹é‡è©¦", "error");
            }).finally(() => {
                setLoadingState('btn-execute-swap', false, oldHtml);
            });
        };

        window.closeModal = (mid) => { 
            const m = document.getElementById(mid);
            if(m) {
                m.style.display = 'none'; 
                if (mid === 'modal-edit-order') {
                    document.getElementById('edit-step-1').style.display = 'flex';
                    document.getElementById('edit-step-2').style.display = 'none';
                }
            }
        };

        window.cancelWarning = () => {
            document.getElementById('edit-step-2').style.display = 'none';
            document.getElementById('edit-step-1').style.display = 'flex';
        };

        window.updateTotalDisplay = () => {
            const price = parseInt(document.getElementById('p-type').value) || 0;
            const total = selectedIds.length * price;
            document.getElementById('buy-final-total').innerText = `NT$ ${total.toLocaleString()}`;

            const paySelect = document.getElementById('p-pay-method-select');
            if (price === 0) {
                paySelect.innerHTML = '<option value="free">å…ä»˜è²»</option>';
                paySelect.disabled = true; 
            } else {
                paySelect.innerHTML = `
                    <option value="cash">ç¾é‡‘</option>
                    <option value="transfer">åŒ¯æ¬¾</option>
                `;
                paySelect.disabled = false; 
            }
        };

        document.getElementById('btn-open-modal').onclick = () => {
            document.getElementById('p-name').value = ""; 
            document.getElementById('p-phone').value = "";
            document.getElementById('p-note').value = "";
            document.getElementById('p-type').value = "650"; 
            document.getElementById('modal-payment').style.display = 'none';
            document.getElementById('modal-purchase').style.display = 'flex';
            document.getElementById('buy-seat-list').value = selectedIds.join(', ');
            window.updateTotalDisplay();
        };

        window.goToStep2 = () => {
            const price = parseInt(document.getElementById('p-type').value) || 0;
            const nameLabel = document.getElementById('label-name');
            const nameInput = document.getElementById('p-name');
            const phoneLabel = document.getElementById('label-phone');
            const phoneInput = document.getElementById('p-phone');
            
            const reqStarHtml = '<span class="required-star">*</span>';

            if (price === 0) {
                nameLabel.innerHTML = `è²´è³“ç¨±å‘¼ / å–®ä½ ${reqStarHtml}`;
                nameInput.placeholder = "è«‹è¼¸å…¥è²´è³“ç¨±å‘¼æˆ–å–®ä½";
                phoneLabel.innerHTML = `è¯çµ¡é›»è©±`; 
                phoneInput.placeholder = "è«‹è¼¸å…¥è¯çµ¡é›»è©±"; 
                phoneInput.removeAttribute('maxlength'); 
            } else {
                nameLabel.innerHTML = `è³¼ç¥¨å§“å ${reqStarHtml}`;
                nameInput.placeholder = "è«‹è¼¸å…¥å§“å";
                phoneLabel.innerHTML = `è¯çµ¡é›»è©± ${reqStarHtml}`; 
                phoneInput.placeholder = "è«‹è¼¸å…¥ 09 é–‹é ­çš„ 10 ç¢¼é›»è©±";
                phoneInput.setAttribute('maxlength', '10');
            }

            document.getElementById('modal-purchase').style.display = 'none';
            document.getElementById('modal-payment').style.display = 'flex';
        };

        window.goToStep1 = () => {
            document.getElementById('modal-payment').style.display = 'none';
            document.getElementById('modal-purchase').style.display = 'flex';
        };

        window.copyTransferInfo = () => {
            const text = document.getElementById('copy-transfer-text').innerText;
            const el = document.createElement('textarea');
            el.value = text;
            document.body.appendChild(el);
            el.select();
            document.execCommand('copy');
            document.body.removeChild(el);
            window.showToast("å·²è¤‡è£½è³‡è¨Šï¼", "success");
        };

        const setLoadingState = (btnId, isLoading, originalHtml = '', loadingText = 'è™•ç†ä¸­...') => {
            const btn = document.getElementById(btnId);
            if (!btn) return originalHtml;
            
            if (isLoading) {
                const html = btn.innerHTML;
                btn.disabled = true;
                btn.innerHTML = `<svg class="spinner" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>${loadingText}`;
                return html; 
            } else {
                btn.disabled = false;
                btn.innerHTML = originalHtml;
            }
        };

        window.submitFinalOrder = () => {
            const name = document.getElementById('p-name').value.trim();
            const phone = document.getElementById('p-phone').value.trim();
            const note = document.getElementById('p-note').value.trim();
            const method = document.getElementById('p-pay-method-select').value;
            
            if (method === 'free') {
                if(!name) {
                    window.showToast("è«‹å¡«å¯«è²´è³“ç¨±å‘¼ / å–®ä½ï¼", "error"); return;
                }
            } else {
                if(!name || !phone) {
                    window.showToast("è«‹å¡«å¯«å§“åèˆ‡é›»è©±ï¼", "error"); return;
                }
                const phoneRegex = /^09\d{8}$/;
                if (!phoneRegex.test(phone)) {
                    window.showToast("æ‰‹æ©Ÿè™Ÿç¢¼æ ¼å¼éŒ¯èª¤ï¼Œè«‹è¼¸å…¥ 09 é–‹é ­çš„ 10 ç¢¼æ•¸å­—ï¼", "error"); return;
                }
            }

            const originalBtnHtml = setLoadingState('btn-submit-order', true);

            const typeText = document.getElementById('p-type').options[document.getElementById('p-type').selectedIndex].text;
            const price = parseInt(document.getElementById('p-type').value) || 0;
            const orderId = 'ORD-' + Date.now();
            const status = (method === 'free') ? 'paid' : 'pending'; 
            const total = selectedIds.length * price;
            const createdAt = new Date().toISOString();

            let finalDate = null;
            if (method === 'free') {
                const today = new Date();
                finalDate = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;
            }

            const updates = {};
            updates[`orders/${orderId}`] = {
                orderId, name, phone, ticketType: typeText, seats: selectedIds, 
                total, paymentMethod: method, bankCode: "", note, status, createdAt
            };
            if (finalDate) updates[`orders/${orderId}`].receiptDate = finalDate;

            selectedIds.forEach(id => {
                updates[`seats/${id}`] = { 
                    status: 'sold', name, phone, ticketType: typeText, bankCode: "", note, 
                    paymentMethod: method, orderId
                };
                if (finalDate) updates[`seats/${id}`].receiptDate = finalDate;
            });

            update(ref(db), updates).then(() => { 
                const seatsJoined = selectedIds.join('ã€');
                selectedIds = []; 
                window.closeModal('modal-payment'); 
                
                const statusLabel = document.getElementById('success-status-label');
                const copyBox = document.getElementById('copy-transfer-box');
                
                if (method === 'free') {
                    statusLabel.innerText = "è¨‚å–®ç‹€æ…‹ï¼šå·²å®Œæˆ (å…ä»˜è²»)";
                    statusLabel.style.background = "#dcfce7";
                    statusLabel.style.color = "#059669";
                    copyBox.style.display = "none";
                } else if (method === 'cash') {
                    statusLabel.innerText = "è¨‚å–®ç‹€æ…‹ï¼šå¾…ä»˜æ¬¾";
                    statusLabel.style.background = "#fee2e2";
                    statusLabel.style.color = "#b91c1c";
                    copyBox.style.display = "none";
                } else {
                    statusLabel.innerText = "è¨‚å–®ç‹€æ…‹ï¼šå¾…å…¥å¸³";
                    statusLabel.style.background = "#fef3c7";
                    statusLabel.style.color = "#d97706";
                    copyBox.style.display = "block";
                    
                    const transferText = `æ‚¨å¥½~æ‚¨å·²æˆåŠŸé è¨‚MIAæ˜¥å­£æˆæœç™¼è¡¨åº§ä½\nç‚ºå”åŠ©æ‚¨ä¿ç•™åº§ä½ï¼Œè«‹æ–¼ä»Šæ—¥å…§å®ŒæˆåŒ¯æ¬¾ï¼Œé€¾æœŸå°‡é‡‹å‡ºåº§ä½ï¼Œæ•¬è«‹è¦‹è«’ã€‚\nğŸ“ åº§ä½ï¼š${seatsJoined}\nğŸ“ é‡‘é¡ï¼š$${total.toLocaleString()}\nâ€”\nğŸ“Œä¸­åœ‹ä¿¡è¨—ï¼ˆ822ï¼‰2995-4080-2139\nåŒ¯æ¬¾ / è½‰å¸³å®Œæˆå¾Œè«‹å›è¦†ï¼š\nâŠ è³¼ç¥¨å§“å \nâ‹ åŒ¯æ¬¾é‡‘é¡\nâ¸ å¸³è™Ÿå¾Œäº”ç¢¼`;
                    document.getElementById('copy-transfer-text').innerText = transferText;
                }
                
                document.getElementById('modal-success').style.display = 'flex';
                render(); 
                window.showToast("åŠƒä½å®Œæˆï¼", "success");
            }).catch((err) => {
                console.error(err);
                window.showToast("é€å‡ºå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š", "error");
            }).finally(() => {
                setLoadingState('btn-submit-order', false, originalBtnHtml);
            });
        };

        window.openOrderManager = () => {
            document.getElementById('main-content-area').style.display = 'none';
            document.getElementById('floating-bar').classList.remove('show');
            document.getElementById('order-page').style.display = 'flex';
            document.getElementById('header-order-btn').style.display = 'none';
            document.getElementById('header-back-btn').style.display = 'flex';
            
            window.clearAllFilters();
        };

        window.closeOrderManager = () => {
            document.getElementById('order-page').style.display = 'none';
            document.getElementById('main-content-area').style.display = 'flex';
            if (isAdmin) {
                document.getElementById('header-order-btn').style.display = 'flex';
                document.getElementById('header-back-btn').style.display = 'none';
            }
            updateBottomBar();
        };

        window.handleFilterChange = () => {
            currentPage = 1;
            window.renderOrders();
        };

        window.prevPage = () => {
            if (currentPage > 1) {
                currentPage--;
                window.renderOrders();
                document.getElementById('order-page').scrollTo({ top: 0, behavior: 'smooth' });
            }
        };

        window.nextPage = () => {
            currentPage++;
            window.renderOrders();
            document.getElementById('order-page').scrollTo({ top: 0, behavior: 'smooth' });
        };

        window.changeItemsPerPage = () => {
            itemsPerPage = parseInt(document.getElementById('items-per-page').value);
            currentPage = 1; 
            window.renderOrders();
            document.getElementById('order-page').scrollTo({ top: 0, behavior: 'smooth' });
        };

        window.clearAllFilters = () => {
            document.getElementById('order-date-input').value = '';
            document.getElementById('receipt-date-input').value = '';
            document.getElementById('filter-payment').value = 'all';
            document.getElementById('filter-status').value = 'all';
            document.getElementById('order-search-input').value = '';
            currentPage = 1; 
            window.renderOrders();
        };

        window.renderOrders = () => {
            const tbody = document.getElementById('order-table-body');
            const searchInput = document.getElementById('order-search-input');
            const orderDateInput = document.getElementById('order-date-input');
            const receiptDateInput = document.getElementById('receipt-date-input');
            const paymentInput = document.getElementById('filter-payment');
            const statusInput = document.getElementById('filter-status');
            
            const keyword = searchInput ? searchInput.value.trim().toLowerCase() : "";
            const selectedOrderDate = orderDateInput ? orderDateInput.value : "";
            const selectedReceiptDate = receiptDateInput ? receiptDateInput.value : "";
            const selectedPayment = paymentInput ? paymentInput.value : "all";
            const selectedStatus = statusInput ? statusInput.value : "all";
            
            if(!tbody) return;
            tbody.innerHTML = '';
            
            const allOrders = Object.values(ordersData).sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            let totalRegularCount = 0;
            let totalReserveCount = 0;
            let soldRegularCount = 0;
            let soldReserveCount = 0;

            layout.forEach(sec => {
                for (let r = 0; r < sec.rows; r++) {
                    const rowName = String.fromCharCode(sec.start.charCodeAt(0) + r);
                    const cL = Array.isArray(sec.L) ? sec.L[r] : sec.L;
                    const cM = Array.isArray(sec.M) ? sec.M[r] : sec.M;
                    const cR = Array.isArray(sec.R) ? sec.R[r] : sec.R;
                    const totalCols = cL + cM + cR;
                    for (let s = 1; s <= totalCols; s++) {
                        const id = rowName + s;
                        const isBlocked = ((rowName === 'A' || rowName === 'B') && (s <= cL || s > cL + cM));
                        if (!isBlocked && !cameraSeats.includes(id)) {
                            if (reserveSeats.includes(id)) totalReserveCount++;
                            else totalRegularCount++;
                        }
                    }
                }
            });

            Object.keys(seatsData).forEach(id => {
                if (seatsData[id].status === 'sold') {
                    if (reserveSeats.includes(id)) soldReserveCount++;
                    else soldRegularCount++;
                }
            });

            const remainingRegular = totalRegularCount - soldRegularCount;
            const remainingReserve = totalReserveCount - soldReserveCount;
            
            const infoEl = document.getElementById('stat-remaining-info');
            if (infoEl) infoEl.innerText = `å‰©é¤˜ï¼šä¸€èˆ¬ ${remainingRegular} å¼µ ï½œ ä¿ç•™ ${remainingReserve} å¼µ`;

            let dateFilteredOrders = allOrders;
            if (selectedOrderDate !== "" || selectedReceiptDate !== "") {
                dateFilteredOrders = allOrders.filter(o => {
                    let matchOrderDate = true;
                    let matchReceiptDate = true;
                    if (selectedOrderDate !== "") {
                        const oDate = new Date(o.createdAt);
                        const y = oDate.getFullYear(), m = String(oDate.getMonth()+1).padStart(2,'0'), d = String(oDate.getDate()).padStart(2,'0');
                        const createdDateStr = `${y}-${m}-${d}`;
                        matchOrderDate = (createdDateStr === selectedOrderDate || o.reportDate === selectedOrderDate);
                    }
                    if (selectedReceiptDate !== "") {
                        if (o.isRefund) {
                            matchReceiptDate = (o.status === 'refunded' && o.refundDate === selectedReceiptDate);
                        } else {
                            matchReceiptDate = (o.receiptDate === selectedReceiptDate || o.reportDate === selectedReceiptDate);
                        }
                    }
                    return matchOrderDate && matchReceiptDate;
                });
            }

            let filteredArray = dateFilteredOrders.filter(o => {
                if (selectedStatus !== 'all' && o.status !== selectedStatus) return false;
                if (selectedPayment !== 'all' && o.paymentMethod !== selectedPayment) return false;
                
                if (keyword !== "") {
                    const nameMatch = o.name.toLowerCase().includes(keyword);
                    const phoneMatch = o.phone.toLowerCase().includes(keyword);
                    const seatMatch = (o.seats || []).some(s => {
                        const serial = ticketMapping[s] || "";
                        const matchStr = `${s} ${serial} #${serial}`.toLowerCase();
                        return matchStr.includes(keyword);
                    });
                    if (!nameMatch && !phoneMatch && !seatMatch) return false;
                }
                return true;
            });

            let displayTotalRev = 0;
            let displayCashRev = 0;
            let revTitle = "ç´¯è¨ˆç¸½ç‡Ÿæ”¶";
            
            if (selectedReceiptDate !== "") {
                revTitle = "å–®æ—¥çµç®—ç‡Ÿæ”¶";
                allOrders.forEach(o => {
                    if (o.isRefund) {
                        if (o.status === 'refunded' && o.refundDate === selectedReceiptDate) {
                            displayTotalRev += (o.total || 0);
                            if (o.paymentMethod === 'cash') displayCashRev += (o.total || 0);
                        }
                    } else {
                        let isCashMatch = (o.paymentMethod === 'cash' && o.status === 'paid' && o.receiptDate === selectedReceiptDate);
                        let isTransferMatch = (o.paymentMethod === 'transfer' && o.bankCode && o.bankCode.trim() !== "" && o.reportDate === selectedReceiptDate);
                        
                        if (isCashMatch) {
                            displayTotalRev += (o.total || 0);
                            displayCashRev += (o.total || 0);
                        }
                        if (isTransferMatch) {
                            displayTotalRev += (o.total || 0);
                        }
                    }
                });
            } else {
                allOrders.forEach(o => {
                    if (o.paymentMethod !== 'free') {
                        displayTotalRev += (o.total || 0);
                    }
                    if (o.paymentMethod === 'cash') {
                        displayCashRev += (o.total || 0);
                    }
                });
            }

            let totalRegularTickets = 0;
            let totalPendingCount = 0;
            
            allOrders.forEach(o => {
                if (!o.isRefund && o.status === 'pending') totalPendingCount++;
                if (o.isRefund && o.status === 'pending_refund') totalPendingCount++;
                
                if (!o.isRefund) {
                    const activeSeats = (o.seats || []).filter(s => !(o.refundedSeats || []).includes(s));
                    activeSeats.forEach(s => {
                        if (!reserveSeats.includes(s) && !cameraSeats.includes(s)) {
                            totalRegularTickets++;
                        }
                    });
                }
            });

            const revTitleEl = document.getElementById('stat-revenue-title');
            if(revTitleEl) revTitleEl.innerText = revTitle;
            
            document.getElementById('stat-revenue').innerText = `$${displayTotalRev.toLocaleString()}`;
            document.getElementById('stat-cash-revenue').innerText = `ç¾é‡‘æ·¨æ”¶ $${displayCashRev.toLocaleString()}`;
            
            document.getElementById('stat-tickets').innerHTML = `${totalRegularTickets} <span>å¼µ</span>`;
            document.getElementById('stat-orders').innerHTML = `${allOrders.length} <span>ç­†</span>`;
            document.getElementById('stat-pending').innerHTML = `${totalPendingCount} <span>ç­†</span>`;
            
            document.getElementById('results-count-number').innerText = filteredArray.length;

            const paginationControls = document.getElementById('pagination-controls');

            if(filteredArray.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; color:#999; padding:40px;">æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„è¨‚å–®</td></tr>`;
                if(paginationControls) paginationControls.style.display = 'none';
                return;
            }

            const totalItems = filteredArray.length;
            const totalPages = Math.ceil(totalItems / itemsPerPage) || 1;
            
            if (currentPage > totalPages) currentPage = totalPages;
            
            if(paginationControls) {
                paginationControls.style.display = 'flex';
                document.getElementById('page-indicator').innerText = `ç¬¬ ${currentPage} / ${totalPages} é `;
                document.getElementById('btn-prev-page').disabled = currentPage === 1;
                document.getElementById('btn-next-page').disabled = currentPage >= totalPages;
            }

            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedArray = filteredArray.slice(startIndex, endIndex);

            paginatedArray.forEach(o => {
                const dateObj = new Date(o.createdAt);
                const timeString = dateObj.toLocaleString('zh-TW', { month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', hour12: false });
                
                let statusLabel = '';
                let statusClass = '';
                if (o.isRefund) {
                    statusLabel = (o.status === 'refunded') ? 'å·²é€€æ¬¾' : 'å¾…é€€æ¬¾';
                    statusClass = (o.status === 'refunded') ? 'status-refunded' : 'status-pending-refund';
                } else {
                    statusLabel = (o.status === 'paid') ? 'å·²å®Œæˆ' : (o.paymentMethod === 'cash' ? 'å¾…ä»˜æ¬¾' : 'å¾…å…¥å¸³');
                    statusClass = (o.status === 'paid') ? 'status-paid' : (o.paymentMethod === 'cash' ? 'status-unpaid-red' : 'status-pending-orange');
                }

                let subDateHtml = '';
                if (o.isRefund) {
                    if (o.status === 'refunded' && o.refundDate) {
                        subDateHtml += `<div style="font-size:10px; font-weight:bold; color:#ef4444; margin-top:4px;">é€€æ¬¾æ—¥: ${o.refundDate}</div>`;
                    }
                } else if (o.paymentMethod !== 'free') {
                    if (o.status === 'paid' && o.receiptDate) {
                        subDateHtml += `<div style="font-size:10px; font-weight:bold; color:#10b981; margin-top:4px;">æ”¶æ¬¾æ—¥: ${o.receiptDate}</div>`;
                    } else if (o.reportDate && o.paymentMethod === 'transfer') {
                        subDateHtml += `<div style="font-size:10px; font-weight:bold; color:var(--primary-blue); margin-top:4px;">æ”¶æ¬¾æ—¥: ${o.reportDate}</div>`;
                    }
                }
                
                let methodStr = 'å…ä»˜è²»';
                if (o.paymentMethod === 'cash') methodStr = 'ç¾é‡‘';
                else if (o.paymentMethod === 'transfer') methodStr = 'åŒ¯æ¬¾';

                const seatNamesStr = (o.seats || []).map(s => {
                    return (o.refundedSeats || []).includes(s) ? `${s}<span style="color:#ef4444;font-size:11px;">(å·²é€€)</span>` : s;
                }).join(', ');
                
                const serialsOnlyStr = (o.seats || [])
                    .map(s => {
                        const serial = ticketMapping[s];
                        if (!serial) return null;
                        return (o.refundedSeats || []).includes(s) ? `#${serial}(å·²é€€)` : `#${serial}`;
                    })
                    .filter(Boolean) 
                    .join(', ');
                
                const serialHtml = serialsOnlyStr ? `<div style="font-size:11px; color:#94a3b8; margin-top:2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${serialsOnlyStr}</div>` : '';
                
                const seatsFullTitle = (o.seats || []).map(s => {
                    const serial = ticketMapping[s];
                    const baseStr = serial ? `${s} (#${serial})` : s;
                    return (o.refundedSeats || []).includes(s) ? `${baseStr} (å·²é€€)` : baseStr;
                }).join(', ');

                // ğŸŒŸ æ“ä½œæŒ‰éˆ•å€åŸŸ
                let actionsHtml = '';
                if (o.isRefund) {
                    if (o.status === 'pending_refund') {
                        actionsHtml += `<button class="action-icon-btn verify" onclick="window.openVerifyRefund('${o.orderId}')" title="ç¢ºèªé€€æ¬¾å®Œæˆ"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg></button>`;
                    }
                    actionsHtml += `<button class="action-icon-btn edit" onclick="window.openEditOrder('${o.orderId}')" title="ç·¨è¼¯é€€æ¬¾å–®"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button>`;
                } else {
                    if (o.status === 'pending') {
                        actionsHtml += `<button class="action-icon-btn verify" onclick="window.openVerifyOrder('${o.orderId}')" title="ç¢ºèªå…¥å¸³"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg></button>`;
                    }
                    actionsHtml += `<button class="action-icon-btn edit" onclick="window.openEditOrder('${o.orderId}')" title="ç·¨è¼¯è¨‚å–®"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button>`;
                    
                    const activeSeatsCount = (o.seats || []).length - (o.refundedSeats || []).length;
                    if (activeSeatsCount > 0) {
                        // é€€ç¥¨æŒ‰éˆ• (åƒåœ¾æ¡¶)
                        actionsHtml += `<button class="action-icon-btn refund" onclick="window.openRefundModal('${o.orderId}')" title="éƒ¨åˆ†é€€ç¥¨/é€€è²» (ä¿ç•™ç´€éŒ„)"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg></button>`;
                    }
                    
                    // åˆªé™¤ä½œå»¢æŒ‰éˆ• (X æ‰“å‰)
                    actionsHtml += `<button class="action-icon-btn delete" onclick="window.openDeleteModal('${o.orderId}')" title="åˆªé™¤æ•´ç­†è¨‚å–® (ä¸ç•™ç´€éŒ„)"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>`;
                }

                const amountColor = o.isRefund ? '#ef4444' : 'var(--primary-blue)';

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><div style="font-weight:bold;">${timeString}</div>${subDateHtml}</td>
                    <td><div style="font-weight:bold;">${o.name}</div><div style="font-size:11px; color:#94a3b8;">${o.phone}</div></td>
                    <td style="max-width: 150px;" title="${seatsFullTitle}">
                        <div style="font-weight:bold; color:#1e293b; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${seatNamesStr}</div>
                        ${serialHtml}
                    </td>
                    <td>
                        <div style="font-weight:bold; color:${amountColor};">NT$ ${o.total.toLocaleString()}</div>
                        <div style="font-size:11px; color:#94a3b8;">${methodStr}</div>
                    </td>
                    <td><span class="status-badge ${statusClass}">${statusLabel}</span></td>
                    <td>
                        <div style="display: flex; justify-content: flex-end; align-items: center; gap: 4px;">
                            ${actionsHtml}
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        };

        // --- é€€æ¬¾æ ¸éŠ·å°ˆå±¬åŠŸèƒ½ ---
        window.openVerifyRefund = (orderId) => {
            const o = ordersData[orderId];
            if(!o) return;
            document.getElementById('verify-refund-order-id').value = orderId;
            document.getElementById('verify-refund-name').innerText = o.name;
            document.getElementById('verify-refund-total').innerText = `NT$ ${Math.abs(o.total).toLocaleString()}`;
            
            const today = new Date();
            const dateStr = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;
            document.getElementById('verify-refund-date-input').value = dateStr;
            
            document.getElementById('modal-verify-refund').style.display = 'flex';
        };

        window.confirmVerifyRefund = () => {
            const orderId = document.getElementById('verify-refund-order-id').value;
            const o = ordersData[orderId];
            if(!o) return;

            const originalBtnHtml = setLoadingState('btn-confirm-verify-refund', true);
            const refundDate = document.getElementById('verify-refund-date-input').value;

            if(!refundDate) { 
                window.showToast("è«‹é¸æ“‡å¯¦éš›é€€æ¬¾æ—¥æœŸï¼"); 
                setLoadingState('btn-confirm-verify-refund', false, originalBtnHtml);
                return; 
            }

            const updates = {};
            updates[`orders/${orderId}/status`] = 'refunded';
            updates[`orders/${orderId}/refundDate`] = refundDate;
            
            update(ref(db), updates).then(() => { 
                window.closeModal('modal-verify-refund'); 
                window.showToast("å·²æˆåŠŸç™»è¨˜é€€æ¬¾ï¼", "success"); 
            }).catch(err => {
                console.error(err);
                window.showToast("æ“ä½œå¤±æ•—ï¼Œè«‹é‡è©¦", "error");
            }).finally(() => {
                setLoadingState('btn-confirm-verify-refund', false, originalBtnHtml);
            });
        };

        // ğŸŒŸ é€€ç¥¨åŠŸèƒ½ (åƒåœ¾æ¡¶æŒ‰éˆ•)
        window.openRefundModal = (orderId) => {
            const o = ordersData[orderId];
            if(!o) return;
            
            document.getElementById('refund-order-id').value = orderId;
            document.getElementById('refund-order-name').innerText = o.name;
            
            const container = document.getElementById('refund-seat-checkboxes');
            container.innerHTML = '';
            
            (o.seats || []).forEach(s => {
                if ((o.refundedSeats || []).includes(s)) return;
                
                const label = document.createElement('label');
                label.style.display = 'flex';
                label.style.alignItems = 'center';
                label.style.gap = '5px';
                label.style.background = '#f1f5f9';
                label.style.padding = '8px 12px';
                label.style.borderRadius = '8px';
                label.style.cursor = 'pointer';
                label.style.border = '1px solid #e2e8f0';
                
                const cb = document.createElement('input');
                cb.type = 'checkbox';
                cb.value = s;
                cb.className = 'refund-cb';
                
                label.appendChild(cb);
                label.appendChild(document.createTextNode(s));
                container.appendChild(label);
            });
            
            const isFree = o.paymentMethod === 'free';
            const isPending = o.status === 'pending';
            const methodGroup = document.getElementById('refund-method-group');
            const noteEl = document.getElementById('refund-note-text');
            
            if (isFree) {
                methodGroup.style.display = 'none';
                noteEl.innerHTML = "<span style='color:#ef4444; font-weight:bold;'>* æ­¤ç‚ºå…ä»˜è²»è¨‚å–®</span>ï¼Œç¢ºèªå¾Œå°‡ç›´æ¥é‡‹å‡ºåº§ä½ã€‚<br>* è‹¥å…¨é¸å°‡åˆªé™¤æ•´ç­†è¨‚å–®ï¼Œä¸ç”¢ç”Ÿé€€å–®ç´€éŒ„ã€‚";
            } else if (isPending) {
                methodGroup.style.display = 'none';
                noteEl.innerHTML = "<span style='color:#ef4444; font-weight:bold;'>* æ­¤ç‚ºæœªä»˜æ¬¾è¨‚å–®</span>ï¼Œç¢ºèªå¾Œå°‡<span style='color:#ef4444; font-weight:bold;'>ç›´æ¥æ‰£æ¸›åŸå–®é‡‘é¡</span>ã€‚<br>* è‹¥å…¨é¸å°‡åˆªé™¤æ•´ç­†è¨‚å–®ï¼Œä¸ç”¢ç”Ÿé€€æ¬¾ç´€éŒ„ã€‚";
            } else {
                methodGroup.style.display = 'block';
                document.getElementById('refund-method-select').value = o.paymentMethod;
                noteEl.innerHTML = "* å‹¾é¸ä¸¦ç¢ºèªå¾Œï¼Œç³»çµ±å°‡ç«‹å³é‡‹å‡ºåº§ä½ã€‚<br>* å°‡ç”¢ç”Ÿä¸€ç­†ã€Œå¾…é€€æ¬¾ã€è² æ•¸è¨‚å–®ä¸¦ä¿ç•™åŸå–®ç´€éŒ„ã€‚";
            }
            
            document.getElementById('modal-create-refund').style.display = 'flex';
        };

        window.executeCreateRefund = () => {
            const orderId = document.getElementById('refund-order-id').value;
            const o = ordersData[orderId];
            if(!o) return;
            
            const cbs = document.querySelectorAll('.refund-cb:checked');
            const selectedSeats = Array.from(cbs).map(cb => cb.value);
            
            if (selectedSeats.length === 0) {
                window.showToast("è«‹è‡³å°‘å‹¾é¸ä¸€å€‹è¦é€€å‡ºçš„åº§ä½ï¼");
                return;
            }
            
            const originalBtnHtml = setLoadingState('btn-execute-create-refund', true);
            const updates = {};
            
            const activeSeats = (o.seats || []).filter(s => !(o.refundedSeats || []).includes(s));
            const perSeatPrice = o.total / (o.seats.length || 1); 
            const refundAmount = perSeatPrice * selectedSeats.length;

            const isFree = o.paymentMethod === 'free';
            const isPending = o.status === 'pending';

            // é˜²å‘†ï¼šæœªä»˜æ¬¾è¨‚å–® æˆ– å…ä»˜è²»è¨‚å–® ç›´æ¥ä½œå»¢æ‰£é™¤ï¼Œä¸ç”Ÿé€€æ¬¾å–®
            if (isPending || isFree) {
                if (selectedSeats.length === activeSeats.length && (o.refundedSeats || []).length === 0) {
                    updates[`orders/${orderId}`] = null;
                } else {
                    const newSeats = o.seats.filter(s => !selectedSeats.includes(s));
                    const newTotal = isFree ? 0 : (o.total - refundAmount);
                    updates[`orders/${orderId}/seats`] = newSeats;
                    updates[`orders/${orderId}/total`] = newTotal;
                    
                    if (newSeats.length === 0) {
                         updates[`orders/${orderId}`] = null;
                    }
                }
                selectedSeats.forEach(s => updates[`seats/${s}`] = null);
            } else {
                // å·²ä»˜æ¬¾è¨‚å–®ï¼šä¿ç•™æ­·å²ã€ç”¢ç”Ÿé€€å–®
                const method = document.getElementById('refund-method-select').value;
                const newRefId = 'REF-' + Date.now();
                
                const existingRefunded = o.refundedSeats || [];
                updates[`orders/${orderId}/refundedSeats`] = [...existingRefunded, ...selectedSeats];
                
                const refundStatus = 'pending_refund';
                
                updates[`orders/${newRefId}`] = {
                    orderId: newRefId,
                    originalOrderId: orderId,
                    isRefund: true,
                    name: `${o.name} (é€€ç¥¨)`,
                    phone: o.phone,
                    ticketType: o.ticketType,
                    seats: selectedSeats,
                    total: -refundAmount,
                    paymentMethod: method,
                    status: refundStatus,
                    createdAt: new Date().toISOString()
                };
                
                selectedSeats.forEach(s => updates[`seats/${s}`] = null);
            }
            
            update(ref(db), updates).then(() => {
                window.closeModal('modal-create-refund');
                window.showToast("é€€ç¥¨/ä½œå»¢ è™•ç†å®Œæˆï¼Œåº§ä½å·²é‡‹å‡ºï¼", "success");
            }).catch(err => {
                console.error(err);
                window.showToast("æ“ä½œå¤±æ•—ï¼Œè«‹é‡è©¦", "error");
            }).finally(() => {
                setLoadingState('btn-execute-create-refund', false, originalBtnHtml);
            });
        };

        // --- åˆªé™¤è¨‚å–®åŠŸèƒ½ (X æŒ‰éˆ•) ---
        window.openDeleteModal = (orderId) => {
            const o = ordersData[orderId];
            if(!o) return;
            document.getElementById('delete-target-id').value = orderId;
            document.getElementById('del-order-name').innerText = o.name;
            document.getElementById('modal-delete-order').style.display = 'flex';
        };

        window.executeDeleteOrder = () => {
            const orderId = document.getElementById('delete-target-id').value;
            const o = ordersData[orderId];
            if(!o) return;
            
            const originalBtnHtml = setLoadingState('btn-execute-delete', true);
            const updates = {};
            
            if (!o.isRefund) {
                if(o.seats) {
                    o.seats.forEach(s => {
                        if (!(o.refundedSeats || []).includes(s)) {
                            updates[`seats/${s}`] = null;
                        }
                    });
                }
            }
            
            updates[`orders/${orderId}`] = null;
            
            update(ref(db), updates).then(() => {
                window.closeModal('modal-delete-order');
                window.showToast("è¨‚å–®å·²å¾¹åº•åˆªé™¤ï¼", "success");
            }).catch(err => {
                console.error(err);
                window.showToast("åˆªé™¤å¤±æ•—ï¼Œè«‹é‡è©¦", "error");
            }).finally(() => {
                setLoadingState('btn-execute-delete', false, originalBtnHtml);
            });
        };

        window.openVerifyOrder = (orderId) => {
            const o = ordersData[orderId];
            if(!o) return;
            document.getElementById('verify-order-id').value = orderId;
            document.getElementById('verify-name').innerText = o.name;
            document.getElementById('verify-total').innerText = `NT$ ${o.total.toLocaleString()}`;
            const isCash = o.paymentMethod === 'cash';
            document.getElementById('verify-modal-title-text').innerText = isCash ? 'ç¾é‡‘æ”¶æ¬¾ç¢ºèª' : 'åŒ¯æ¬¾å…¥å¸³ç¢ºèª';
            document.getElementById('verify-transfer-info').style.display = isCash ? 'none' : 'flex';
            if (!isCash) {
                document.getElementById('verify-bank-code').innerText = o.bankCode || "æœªæä¾›";
                document.getElementById('btn-confirm-verify').disabled = (!o.bankCode || o.bankCode.trim() === "");
            } else {
                document.getElementById('btn-confirm-verify').disabled = false;
            }
            document.getElementById('modal-verify').style.display = 'flex';
        };

        window.confirmVerify = () => {
            const orderId = document.getElementById('verify-order-id').value;
            const o = ordersData[orderId];
            if(!o) return;

            const originalBtnHtml = setLoadingState('btn-confirm-verify', true);

            let finalDate = "";
            if (o.paymentMethod === 'transfer') {
                finalDate = o.reportDate; 
            } else {
                const today = new Date();
                finalDate = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;
            }
            if(!finalDate) { 
                window.showToast("è³‡æ–™ç•°å¸¸ï¼šæ‰¾ä¸åˆ°æœ‰æ•ˆæ”¶æ¬¾æ—¥ï¼"); 
                setLoadingState('btn-confirm-verify', false, originalBtnHtml);
                return; 
            }
            const updates = {};
            updates[`orders/${orderId}/status`] = 'paid';
            updates[`orders/${orderId}/receiptDate`] = finalDate;
            if (o.seats) o.seats.forEach(s => updates[`seats/${s}/receiptDate`] = finalDate);
            
            update(ref(db), updates).then(() => { 
                window.closeModal('modal-verify'); 
                window.showToast("æ ¸éŠ·æˆåŠŸï¼", "success"); 
            }).catch(err => {
                console.error(err);
                window.showToast("æ ¸éŠ·å¤±æ•—ï¼Œè«‹é‡è©¦", "error");
            }).finally(() => {
                setLoadingState('btn-confirm-verify', false, originalBtnHtml);
            });
        };

        window.openEditOrder = (orderId) => {
            const o = ordersData[orderId];
            if(!o) return;
            document.getElementById('edit-order-id').value = orderId;
            document.getElementById('edit-order-bank').value = o.bankCode || "";
            document.getElementById('edit-order-note').value = o.note || "";
            
            originalOrderState = { status: o.status, paymentMethod: o.paymentMethod };

            const statusSelect = document.getElementById('edit-order-status');
            statusSelect.innerHTML = '';
            
            if (o.isRefund) {
                if (o.status === 'refunded') {
                    statusSelect.innerHTML = `<option value="refunded">å·²é€€æ¬¾</option>`;
                } else {
                    statusSelect.innerHTML = `
                        <option value="pending_refund-cash">ç¾é‡‘ï¼ˆå¾…é€€æ¬¾ï¼‰</option>
                        <option value="pending_refund-transfer">åŒ¯æ¬¾ï¼ˆå¾…é€€æ¬¾ï¼‰</option>
                    `;
                    statusSelect.value = `pending_refund-${o.paymentMethod}`;
                }
                document.getElementById('edit-order-bank').disabled = false;
                document.getElementById('btn-open-swap').style.display = 'none'; 
            } else {
                statusSelect.innerHTML = `
                    <option value="paid" id="edit-option-paid" style="display:none;">å·²å®Œæˆ</option>
                    <option value="paid-free" id="edit-option-free" style="display:none;">å…ä»˜è²» (å·²å®Œæˆ)</option>
                    <option value="pending-cash" id="edit-option-cash">ç¾é‡‘ï¼ˆå¾…ä»˜æ¬¾ï¼‰</option>
                    <option value="pending-transfer" id="edit-option-transfer">åŒ¯æ¬¾ï¼ˆå¾…å…¥å¸³ï¼‰</option>
                `;
                document.getElementById('btn-open-swap').style.display = 'flex'; 
                
                const paidOption = document.getElementById('edit-option-paid');
                const freeOption = document.getElementById('edit-option-free');
                const cashOption = document.getElementById('edit-option-cash');
                const transferOption = document.getElementById('edit-option-transfer');
                
                document.getElementById('edit-order-bank').disabled = false;

                if (o.paymentMethod === 'free') {
                    freeOption.style.display = 'block';
                    cashOption.style.display = 'none';
                    transferOption.style.display = 'none';
                    statusSelect.value = 'paid-free';
                    document.getElementById('edit-order-bank').disabled = true;
                } else if (o.status === 'paid') {
                    paidOption.style.display = 'block';
                    statusSelect.value = 'paid';
                } else {
                    statusSelect.value = o.paymentMethod === 'cash' ? 'pending-cash' : 'pending-transfer';
                }
            }
            
            document.getElementById('edit-step-1').style.display = 'flex';
            document.getElementById('edit-step-2').style.display = 'none';
            document.getElementById('modal-edit-order').style.display = 'flex';
        };

        window.saveOrderEdit = () => {
            const statusVal = document.getElementById('edit-order-status').value;
            if (originalOrderState && (originalOrderState.status === 'paid' || originalOrderState.paymentMethod === 'free') && (statusVal !== 'paid' && statusVal !== 'paid-free' && statusVal !== 'refunded')) {
                document.getElementById('edit-step-1').style.display = 'none';
                document.getElementById('edit-step-2').style.display = 'flex';
                return;
            }
            window.executeOrderEdit(false); 
        };

        window.executeOrderEdit = (fromWarningPage = true) => {
            const orderId = document.getElementById('edit-order-id').value;
            const newBank = document.getElementById('edit-order-bank').value.trim();
            const newNote = document.getElementById('edit-order-note').value.trim();
            const statusVal = document.getElementById('edit-order-status').value;
            
            const o = ordersData[orderId];
            if(!o) return;

            let originalBtnHtml = '';
            if(fromWarningPage) {
                originalBtnHtml = setLoadingState('btn-execute-edit', true);
            }

            const updates = {};
            updates[`orders/${orderId}/bankCode`] = newBank;
            updates[`orders/${orderId}/note`] = newNote;

            if (o.isRefund) {
                if (statusVal.startsWith('pending_refund-')) {
                    updates[`orders/${orderId}/paymentMethod`] = statusVal.split('-')[1];
                    updates[`orders/${orderId}/status`] = 'pending_refund';
                }
            } else {
                let finalStatus = (statusVal === 'paid' || statusVal === 'paid-free') ? 'paid' : 'pending';
                let finalMethod = o.paymentMethod;
                if (statusVal === 'pending-cash') finalMethod = 'cash';
                if (statusVal === 'pending-transfer') finalMethod = 'transfer';
                if (statusVal === 'paid-free') finalMethod = 'free';

                updates[`orders/${orderId}/paymentMethod`] = finalMethod;
                updates[`orders/${orderId}/status`] = finalStatus;

                if (finalStatus === 'pending') {
                    updates[`orders/${orderId}/receiptDate`] = null;
                }

                let currentReportDate = o.reportDate || null;
                if (finalMethod !== 'free' && newBank !== "" && (!o.bankCode || o.bankCode === "")) {
                    const today = new Date();
                    currentReportDate = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;
                    updates[`orders/${orderId}/reportDate`] = currentReportDate;
                } else if (newBank === "") {
                    currentReportDate = null;
                    updates[`orders/${orderId}/reportDate`] = null;
                }

                if(o.seats) o.seats.forEach(s => {
                    updates[`seats/${s}/bankCode`] = newBank;
                    updates[`seats/${s}/note`] = newNote;
                    updates[`seats/${s}/paymentMethod`] = finalMethod;
                    updates[`seats/${s}/receiptDate`] = (finalStatus === 'pending') ? null : (o.receiptDate || null);
                    updates[`seats/${s}/reportDate`] = currentReportDate;
                });
            }

            update(ref(db), updates).then(() => { 
                window.closeModal('modal-edit-order'); 
                window.showToast("å·²å„²å­˜è®Šæ›´", "success"); 
            }).catch((err) => {
                console.error(err);
                window.showToast("å„²å­˜å¤±æ•—ï¼Œè«‹é‡è©¦");
            }).finally(() => {
                if(fromWarningPage) setLoadingState('btn-execute-edit', false, originalBtnHtml);
            });
        };

        window.exportToExcel = async () => {
            if(!isAdmin) return;
            window.showToast("æ­£åœ¨ç”¢ç”Ÿ Excel æª”æ¡ˆï¼Œè«‹ç¨å€™...", "success");

            const workbook = new ExcelJS.Workbook();
            workbook.creator = 'MIA Ticketing System';

            // ==========================================
            // å·¥ä½œè¡¨ 1ï¼šç¾å ´åº§ä½åœ–
            // ==========================================
            const wsMap = workbook.addWorksheet('ç¾å ´åº§ä½åœ–', {views: [{showGridLines: false}]});
            
            for (let i = 1; i <= 41; i++) wsMap.getColumn(i).width = 8;

            wsMap.mergeCells('A1:AO1');
            wsMap.getCell('A1').value = '2026 8th MIA SPRING SHOW - ç¾å ´åº§ä½è¡¨';
            wsMap.getCell('A1').font = { size: 20, bold: true };
            wsMap.getCell('A1').alignment = { vertical: 'middle', horizontal: 'center' };
            wsMap.getRow(1).height = 40;

            wsMap.mergeCells('A2:AO2');
            wsMap.getCell('A2').value = 'èˆ å°';
            wsMap.getCell('A2').fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF0F172A' } };
            wsMap.getCell('A2').font = { size: 16, bold: true, color: { argb: 'FFFFFFFF' } };
            wsMap.getCell('A2').alignment = { vertical: 'middle', horizontal: 'center' };
            wsMap.getRow(2).height = 30;

            wsMap.getRow(3).height = 20;

            const L_MAX = 11, M_MAX = 15, R_MAX = 11, GAP = 2;
            let currentRow = 4;

            layout.forEach(sec => {
                for(let r = 0; r < sec.rows; r++) {
                    const rowName = String.fromCharCode(sec.start.charCodeAt(0) + r);
                    const cL = Array.isArray(sec.L) ? sec.L[r] : sec.L;
                    const cM = Array.isArray(sec.M) ? sec.M[r] : sec.M;
                    const cR = Array.isArray(sec.R) ? sec.R[r] : sec.R;

                    let currentCol = 1;

                    const renderCell = (s, block) => {
                        const id = rowName + s;
                        const cell = wsMap.getCell(currentRow, currentCol);
                        const isBlocked = ((rowName === 'A' || rowName === 'B') && (block === 'L' || block === 'R'));
                        
                        cell.alignment = { wrapText: true, vertical: 'middle', horizontal: 'center' };
                        cell.border = { 
                            top: {style:'thin', color:{argb:'FFCBD5E1'}}, 
                            left: {style:'thin', color:{argb:'FFCBD5E1'}}, 
                            bottom: {style:'thin', color:{argb:'FFCBD5E1'}}, 
                            right: {style:'thin', color:{argb:'FFCBD5E1'}} 
                        };

                        if (isBlocked) {
                            cell.value = "X";
                            cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFE2E8F0' } };
                            cell.font = { color: { argb: 'FF94A3B8' }, bold: true };
                        } else if (cameraSeats.includes(id)) {
                            cell.value = `${id}\næ”å½±å¸­`;
                            cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF1E3A8A' } };
                            cell.font = { color: { argb: 'FFFFFFFF' }, bold: true, size: 9 };
                        } else {
                            const seatInfo = seatsData[id] || {};
                            const isSold = seatInfo.status === 'sold';
                            const isReserve = reserveSeats.includes(id);

                            if (isSold) {
                                cell.value = `${id}\n${seatInfo.name || ''}`;
                                cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFEE2E2' } };
                                cell.font = { color: { argb: 'FFB91C1C' }, bold: true, size: 9 };
                            } else if (isReserve) {
                                cell.value = `${id}\nä¿ç•™å¸­`;
                                cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFEF3C7' } };
                                cell.font = { color: { argb: 'FFD97706' }, bold: true, size: 9 };
                            } else {
                                cell.value = id; 
                                cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFFFFFF' } };
                                cell.font = { color: { argb: 'FF1E293B' }, bold: true };
                            }
                        }
                    };

                    currentCol += (L_MAX - cL); 
                    for(let s = 1; s <= cL; s++) { renderCell(s, 'L'); currentCol++; }
                    currentCol += GAP;
                    const padMidLeft = Math.floor((M_MAX - cM) / 2);
                    currentCol += padMidLeft;
                    for(let s = cL + 1; s <= cL + cM; s++) { renderCell(s, 'M'); currentCol++; }
                    currentCol += (M_MAX - cM - padMidLeft);
                    currentCol += GAP;
                    for(let s = cL + cM + 1; s <= cL + cM + cR; s++) { renderCell(s, 'R'); currentCol++; }

                    wsMap.getRow(currentRow).height = 40;
                    currentRow++;
                }
                currentRow++; 
            });

            // ==========================================
            // å·¥ä½œè¡¨ 2ï¼šè¨‚å–®åå†Š
            // ==========================================
            const wsOrders = workbook.addWorksheet('è¨‚å–®åå†Š');
            wsOrders.columns = [
                { header: 'è¨‚å–®ç·¨è™Ÿ', key: 'orderId', width: 22 },
                { header: 'è¨‚å–®æ™‚é–“', key: 'time', width: 20 },
                { header: 'è³¼ç¥¨å§“å', key: 'name', width: 15 },
                { header: 'é›»è©±', key: 'phone', width: 15 },
                { header: 'åº§ä½', key: 'seats', width: 35 },
                { header: 'é‡‘é¡', key: 'total', width: 12 },
                { header: 'ä»˜æ¬¾æ–¹å¼', key: 'method', width: 12 },
                { header: 'æœ«äº”ç¢¼', key: 'bankCode', width: 12 },
                { header: 'æ”¶æ¬¾æ—¥æœŸ/é€€æ¬¾æ—¥æœŸ', key: 'receiptDate', width: 15 },
                { header: 'ç‹€æ…‹', key: 'status', width: 15 },
                { header: 'å‚™è¨»', key: 'note', width: 25 }
            ];

            wsOrders.getRow(1).font = { bold: true, color: { argb: 'FF475569' } };
            wsOrders.getRow(1).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFF8FAFC' } };
            wsOrders.getRow(1).border = { bottom: { style: 'medium', color: { argb: 'FFCBD5E1' } } };

            const allOrders = Object.values(ordersData).sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            allOrders.forEach(o => {
                const t = new Date(o.createdAt).toLocaleString('zh-TW', { hour12: false });
                
                let st = '';
                if (o.isRefund) {
                    st = (o.status === 'refunded') ? 'å·²é€€æ¬¾' : 'å¾…é€€æ¬¾';
                } else {
                    st = (o.status === 'paid') ? 'å·²å®Œæˆ' : (o.paymentMethod === 'cash' ? 'å¾…ä»˜æ¬¾' : 'å¾…å…¥å¸³');
                }
                
                // åŒ¯å‡ºåå†Šä¹ŸåŠ ä¸Šæµæ°´è™Ÿèˆ‡(å·²é€€)æ¨™è¨˜
                const seatsDisplay = (o.seats || []).map(s => {
                    const serial = ticketMapping[s];
                    const baseStr = serial ? `${s} (#${serial})` : s;
                    return (o.refundedSeats || []).includes(s) ? `${baseStr} (å·²é€€)` : baseStr;
                }).join(', ');

                wsOrders.addRow({
                    orderId: o.orderId,
                    time: t,
                    name: o.name,
                    phone: o.phone,
                    seats: seatsDisplay,
                    total: o.total,
                    method: o.paymentMethod === 'cash' ? 'ç¾é‡‘' : (o.paymentMethod === 'transfer' ? 'åŒ¯æ¬¾' : 'å…ä»˜è²»'),
                    bankCode: o.bankCode || '',
                    receiptDate: o.isRefund ? (o.refundDate || '') : (o.receiptDate || o.reportDate || ''),
                    status: st,
                    note: o.note || ''
                });
            });

            // ==========================================
            // å·¥ä½œè¡¨ 3ï¼šç¥¨åˆ¸æ ¸éŠ·æ¸…å†Š (çµ¦åœ‹ç¨…å±€)
            // ==========================================
            const wsAudit = workbook.addWorksheet('ç¥¨åˆ¸æ ¸éŠ·æ¸…å†Š');
            wsAudit.columns = [
                { header: 'æµæ°´ç·¨è™Ÿ', key: 'serial', width: 12 },
                { header: 'åº§ä½è™Ÿç¢¼', key: 'seat', width: 12 },
                { header: 'å”®å‡ºç‹€æ…‹', key: 'salesStatus', width: 15 },
                { header: 'åº§ä½é¡å‹', key: 'seatType', width: 15 },
                { header: 'ç¥¨ç¨®', key: 'ticketType', width: 20 },
                { header: 'é‡‘é¡', key: 'price', width: 12 },
                { header: 'è¨‚å–®ç·¨è™Ÿ', key: 'orderId', width: 22 },
                { header: 'è³¼ç¥¨äºº', key: 'buyer', width: 15 }
            ];

            wsAudit.getRow(1).font = { bold: true, color: { argb: 'FFFFFFFF' } };
            wsAudit.getRow(1).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF1E293B' } };
            
            serialList.forEach(item => {
                const seatInfo = seatsData[item.seat] || {};
                const isReserve = reserveSeats.includes(item.seat);
                
                let salesStatusStr = 'æœªå”®å‡º';
                let seatTypeStr = 'ä¸€èˆ¬å¸­';
                let typeStr = '';
                let priceVal = '';
                let oid = '';
                let buyer = '';

                if (item.seat === '-') {
                    // è™•ç†å¤šå°çš„å»¢ç¥¨
                    seatTypeStr = 'ç„¡(å¤šå°)';
                    salesStatusStr = 'æœªå”®å‡º';
                } else {
                    // åˆ¤æ–·åº§ä½é¡å‹
                    if (cameraSeats.includes(item.seat)) {
                        seatTypeStr = 'æ”å½±å¸­';
                        salesStatusStr = 'å…ä»˜è²»'; 
                    } else if (isReserve) {
                        seatTypeStr = 'ä¿ç•™å¸­';
                        salesStatusStr = 'å…ä»˜è²»'; 
                    } else {
                        seatTypeStr = 'ä¸€èˆ¬å¸­';
                        salesStatusStr = 'æœªå”®å‡º';
                    }

                    // åˆ¤æ–·å”®å‡ºç‹€æ…‹
                    if (seatInfo.status === 'sold') {
                        buyer = seatInfo.name || '';
                        oid = seatInfo.orderId || '';
                        typeStr = seatInfo.ticketType || '';
                        
                        if(ordersData[oid]) {
                            const o = ordersData[oid];
                            priceVal = o.total / (o.seats.length || 1);
                            if (o.paymentMethod === 'free') {
                                salesStatusStr = 'å…ä»˜è²»';
                            } else {
                                salesStatusStr = 'å·²å”®å‡º';
                            }
                        } else {
                            salesStatusStr = 'å·²å”®å‡º';
                        }
                    }
                }

                wsAudit.addRow({
                    serial: item.serial,
                    seat: item.seat,
                    salesStatus: salesStatusStr,
                    seatType: seatTypeStr,
                    ticketType: typeStr,
                    price: priceVal,
                    orderId: oid,
                    buyer: buyer
                });
            });

            try {
                const buffer = await workbook.xlsx.writeBuffer();
                const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = `MIA_ç¥¨å‹™ç¸½è¡¨_${new Date().toLocaleDateString('zh-TW', {year:'numeric', month:'2-digit', day:'2-digit'}).replace(/\//g, '')}.xlsx`;
                link.click();
                window.showToast("Excel åŒ¯å‡ºæˆåŠŸï¼", "success");
            } catch (err) {
                console.error(err);
                window.showToast("åŒ¯å‡ºå¤±æ•—ï¼Œè«‹é‡è©¦", "error");
            }
        };

        window.exportDailyReceipts = async () => {
            if(!isAdmin) return;
            const targetDateInput = document.getElementById('receipt-date-input').value;
            
            if(!targetDateInput) {
                window.showToast("è«‹å…ˆåœ¨ä¸Šæ–¹é¸æ“‡ã€Œæ”¶æ¬¾æ—¥æœŸã€", "error");
                return;
            }

            window.showToast("æ­£åœ¨ç”¢ç”Ÿç•¶æ—¥æ”¶æ¬¾åå†Š...", "success");
            
            const workbook = new ExcelJS.Workbook();
            workbook.creator = 'MIA Ticketing System';
            const ws = workbook.addWorksheet('ç•¶æ—¥æ”¶æ¬¾åå†Š');

            ws.columns = [
                { header: 'å¡«å¯«æ—¥æœŸ', key: 'date', width: 15 },
                { header: 'ä»˜æ¬¾é¡åˆ¥', key: 'method', width: 12 },
                { header: 'ç¹³è²»æœŸåˆ¥', key: 'period', width: 12 },
                { header: 'æ”¶è²»é …ç›®', key: 'item', width: 20 },
                { header: 'ä»˜æ¬¾äºº', key: 'payer', width: 15 },
                { header: 'ç¹³è²»æ˜ç´°/æ•¸é‡ è©³ç´°', key: 'details', width: 45 }, 
                { header: 'æ”¶å…¥é‡‘é¡', key: 'income', width: 12 },
                { header: 'æ–°/èˆŠç”Ÿ/å…¶ä»–', key: 'note', width: 15 }
            ];

            ws.getRow(1).font = { bold: true };
            ws.getRow(1).alignment = { vertical: 'middle', horizontal: 'center' };

            const allOrders = Object.values(ordersData).sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

            allOrders.forEach(o => {
                if (o.paymentMethod === 'free') return;

                let match = false;
                if (o.isRefund) {
                    if (o.status === 'refunded' && o.refundDate === targetDateInput) match = true;
                } else {
                    if (o.status === 'paid' && o.receiptDate === targetDateInput) {
                        match = true;
                    } else if (o.paymentMethod === 'transfer' && o.reportDate === targetDateInput) {
                        match = true;
                    }
                }

                if(match) {
                    const formattedDate = targetDateInput.replace(/-/g, '/');
                    let category = o.paymentMethod === 'cash' ? 'ç¾é‡‘' : 'åŒ¯æ¬¾';

                    let cleanTicketType = o.ticketType || "";
                    cleanTicketType = cleanTicketType
                        .replace('å„ªæƒ  ', '')
                        .replace(' NT$ ', '$')
                        .replace(' / å¼µ', '')
                        .replace('ä¸€èˆ¬åŸåƒ¹', 'åŸåƒ¹');

                    let detailString = '';
                    if (o.isRefund) {
                        detailString = `MIA 8th æˆç™¼é–€ç¥¨(é€€æ¬¾) / ${cleanTicketType} / ${(o.seats || []).join('ã€')}`;
                    } else {
                        detailString = `MIA 8th æˆç™¼é–€ç¥¨ / ${cleanTicketType} / ${(o.seats || []).join('ã€')}`;
                    }

                    ws.addRow({
                        date: formattedDate,
                        method: category,
                        period: '',  
                        item: 'é–€ç¥¨',
                        payer: o.name,
                        details: detailString,
                        income: o.total,
                        note: ''     
                    });
                }
            });

            try {
                const buffer = await workbook.xlsx.writeBuffer();
                const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = `MIA_æ•™å®¤ä¸Šå‚³ç”¨_${targetDateInput.replace(/-/g, '')}.xlsx`;
                link.click();
                window.showToast("Excel åŒ¯å‡ºæˆåŠŸï¼", "success");
            } catch (err) {
                console.error(err);
                window.showToast("åŒ¯å‡ºå¤±æ•—ï¼Œè«‹é‡è©¦", "error");
            }
        };
    </script>
</body>
</html>
