<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js";
    import { getDatabase, ref, onValue, update } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-database.js";

    // 這裡請填入你在 Firebase 官網申請到的 Config
    const firebaseConfig = {
        apiKey: "你的_API_KEY",
        databaseURL: "你的_DATABASE_URL",
        projectId: "你的_PROJECT_ID",
        storageBucket: "你的_STORAGE_BUCKET",
        messagingSenderId: "你的_SENDER_ID",
        appId: "你的_APP_ID"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    let selectedSeats = [];

    // --- 核心邏輯 A：監聽資料庫，即時同步座位狀態 ---
    const seatsRef = ref(db, 'seats');
    onValue(seatsRef, (snapshot) => {
        const data = snapshot.val();
        if (!data) return;

        // 遍歷所有座位 id (例如 LT-1-1) 並更新顏色
        Object.keys(data).forEach(id => {
            const seatEl = document.getElementById(id);
            if (seatEl) {
                // 移除舊狀態，換上 Firebase 傳來的新狀態 (sold, available)
                seatEl.className = `seat ${data[id].status}`;
            }
        });
        console.log("座位資訊已更新");
    });

    // --- 核心邏輯 B：處理點擊劃位 (僅限管理員登入後) ---
    document.addEventListener('click', (e) => {
        if (e.target.classList.contains('seat')) {
            // 只有當 body 有 .logged-in 類別時，工作人員才能點擊
            if (!document.body.classList.contains('logged-in')) return;
            if (e.target.classList.contains('sold')) return; // 已售出不能點

            const seatId = e.target.id;
            if (selectedSeats.includes(seatId)) {
                selectedSeats = selectedSeats.filter(id => id !== seatId);
                e.target.classList.remove('selected');
            } else {
                selectedSeats.push(seatId);
                e.target.classList.add('selected');
            }
            updateBottomBar();
        }
    });

    // 更新底部資訊與金額
    function updateBottomBar() {
        const total = selectedSeats.length * 600;
        document.getElementById('display-total').innerText = `NT$ ${total}`;
        document.getElementById('display-sub-info').innerText = `已選 ${selectedSeats.length} 張座位`;
        document.getElementById('btn-open-modal').disabled = selectedSeats.length === 0;
        document.getElementById('buy-seat-list').value = selectedSeats.join(', ');
    }

    // --- 核心邏輯 C：確認購票並寫入雲端 ---
    // 綁定到你的「確認購票」按鈕
    document.getElementById('btn-open-modal').onclick = () => {
        document.getElementById('modal-purchase').style.display = 'flex';
    };

    // 最終按下彈窗內的確認
    window.confirmPurchase = function() {
        const updates = {};
        selectedSeats.forEach(id => {
            updates[`seats/${id}`] = { status: 'sold' };
        });

        update(ref(db), updates).then(() => {
            alert('劃位成功！');
            selectedSeats = [];
            updateBottomBar();
            document.getElementById('modal-purchase').style.display = 'none';
        }).catch(err => alert('更新失敗：' + err));
    };
</script>
